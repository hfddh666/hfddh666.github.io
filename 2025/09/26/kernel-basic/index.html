<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>kernel basic | hfddh666's Blog</title><meta name="author" content="hfddh666"><meta name="copyright" content="hfddh666"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="linux kernelä¸€.åŸºç¡€çŸ¥è¯†1.æ“ä½œç³»ç»Ÿå†…æ ¸ 2.åˆ†çº§ä¿æŠ¤ç¯é€šè¿‡ç¡¬ä»¶å®ç°  **ç”¨æˆ·æ€ï¼š**CPUå±äºring 3çº§åˆ«ï¼Œè¿è¡Œå¹³å¸¸å†™çš„ä»£ç (C&#x2F;C++) **å†…æ ¸æ€ï¼š**CPUå±äºring 0çº§åˆ« 3.çŠ¶æ€åˆ‡æ¢CPU åœ¨ä¸åŒçš„ç‰¹æƒçº§é—´è¿›è¡Œåˆ‡æ¢ä¸»è¦æœ‰ä¸¤ä¸ªé€”å¾„ï¼š â€‹        (1)ä¸­æ–­ä¸å¼‚å¸¸ï¼ˆinterrupt &amp; exceptionï¼‰ï¼šå½“ CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ &amp;#x2">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel basic">
<meta property="og:url" content="https://hfddh666.github.io/2025/09/26/kernel-basic/index.html">
<meta property="og:site_name" content="hfddh666&#39;s Blog">
<meta property="og:description" content="linux kernelä¸€.åŸºç¡€çŸ¥è¯†1.æ“ä½œç³»ç»Ÿå†…æ ¸ 2.åˆ†çº§ä¿æŠ¤ç¯é€šè¿‡ç¡¬ä»¶å®ç°  **ç”¨æˆ·æ€ï¼š**CPUå±äºring 3çº§åˆ«ï¼Œè¿è¡Œå¹³å¸¸å†™çš„ä»£ç (C&#x2F;C++) **å†…æ ¸æ€ï¼š**CPUå±äºring 0çº§åˆ« 3.çŠ¶æ€åˆ‡æ¢CPU åœ¨ä¸åŒçš„ç‰¹æƒçº§é—´è¿›è¡Œåˆ‡æ¢ä¸»è¦æœ‰ä¸¤ä¸ªé€”å¾„ï¼š â€‹        (1)ä¸­æ–­ä¸å¼‚å¸¸ï¼ˆinterrupt &amp; exceptionï¼‰ï¼šå½“ CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ &amp;#x2">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hfddh666.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-09-26T15:41:17.000Z">
<meta property="article:modified_time" content="2026-02-06T12:52:02.436Z">
<meta property="article:author" content="hfddh666">
<meta property="article:tag" content="å†…æ ¸å®‰å…¨">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hfddh666.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "kernel basic",
  "url": "https://hfddh666.github.io/2025/09/26/kernel-basic/",
  "image": "https://hfddh666.github.io/img/butterfly-icon.png",
  "datePublished": "2025-09-26T15:41:17.000Z",
  "dateModified": "2026-02-06T12:52:02.436Z",
  "author": [
    {
      "@type": "Person",
      "name": "hfddh666",
      "url": "https://hfddh666.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hfddh666.github.io/2025/09/26/kernel-basic/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'kernel basic',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preload" href="/image/top-bg.jpg" as="image"><style>
  /* ğŸ”¥ é¡µé¢èƒŒæ™¯ï¼šæ›¿æ¢ä¸ºä½ è¦çš„é¢œè‰²ï¼ˆç¤ºä¾‹ç”¨æµ…ç°è“ #f5f7faï¼Œå¯è‡ªè¡Œä¿®æ”¹ï¼‰ */
  body, html {
    background: #f5f7fa !important; /* ä½ å¯æ›¿æ¢æˆä»»æ„é¢œè‰²å€¼ï¼Œæ¯”å¦‚ #f0f2f5ã€#eef1f5 ç­‰ */
    color: #333 !important;
  }
  /* é¡µé¢å®¹å™¨ï¼šå±…ä¸­+ç•™ç™½ */
  #content-inner {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
  }
  /* æ–‡ç« å¡ç‰‡ï¼šä¿ç•™çº¯ç™½è‰² */
  .recent-post-item {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 16px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.04) !important;
    padding: 30px !important;
    margin-bottom: 25px !important;
    /* ä¿ç•™å·¦ä¾§æš–æ£•æ¸å˜ç‚¹ç¼€ï¼ˆå¯é€‰ï¼Œä¸å–œæ¬¢å¯åˆ é™¤ï¼‰ */
    border-left: 4px solid;
    border-image: linear-gradient(to bottom, #e67e22, #d35400) 1 !important;
    transition: all 0.2s ease;
    position: relative;
  }
  /* å¡ç‰‡hoveræ•ˆæœ */
  .recent-post-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.06) !important;
  }
  /* å¡ç‰‡å³ä¸Šè§’å°ç‚¹ç¼€ï¼ˆå¯é€‰ï¼Œä¸å–œæ¬¢å¯åˆ é™¤ï¼‰ */
  .recent-post-item::after {
    content: "";
    position: absolute;
    top: 20px;
    right: 20px;
    width: 12px;
    height: 12px;
    background: linear-gradient(45deg, #e67e22, #d35400);
    border-radius: 50%;
    opacity: 0.8;
  }
  /* æ–‡ç« æ ‡é¢˜ï¼šæ·±è‰²è°ƒ */
  .post-title {
    font-size: 22px !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    margin-bottom: 12px !important;
    padding-right: 20px;
  }
  /* æ–‡ç« æ‘˜è¦ï¼šä¸­ç°è‰² */
  .post-excerpt {
    color: #555 !important;
    line-height: 1.7 !important;
    font-size: 15px !important;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  /* å‘å¸ƒæ—¶é—´ï¼šæš–ç°è‰²+å°å›¾æ ‡ */
  .post-meta {
    color: #777 !important;
    font-size: 14px !important;
    margin-top: 10px !important;
  }
  .post-meta:before {
    content: "ğŸ“… ";
    color: #e67e22;
  }
  /* ä¾§è¾¹æ ï¼šä¿ç•™çº¯ç™½è‰² */
  .card-widget {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 16px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.04) !important;
    padding: 25px !important;
    margin-bottom: 20px !important;
  }
  /* ä¾§è¾¹æ æ ‡é¢˜ï¼šæ·±è‰²è°ƒ */
  .aside-title {
    font-size: 18px !important;
    font-weight: 600 !important;
    padding-bottom: 8px !important;
    border-bottom: 2px solid #f5f7fa !important; /* å’ŒèƒŒæ™¯è‰²å‘¼åº” */
    margin-bottom: 15px !important;
    color: #2c3e50 !important;
  }
  /* æ ‡ç­¾/åˆ†ç±»ï¼šæµ…æ©™åº•ç‚¹ç¼€ */
  .tag-cloud-list a, .category-list a {
    background: #fef6e9 !important;
    color: #e67e22 !important;
    padding: 4px 12px !important;
    border-radius: 20px !important;
    margin: 0 5px 8px 0 !important;
    display: inline-block !important;
  }
  /* ä»£ç å—ï¼šä¿ç•™çº¯ç™½è‰² */
  figure.highlight {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 12px !important;
    padding: 20px !important;
    margin: 20px 0 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
    border: none !important;
  }
  .highlight code {
    color: #2c3e50 !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
  }
  /* è¡Œå†…ä»£ç ï¼šä¿ç•™çº¯ç™½è‰² */
  p code, li code {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    color: #e67e22 !important;
    padding: 2px 6px !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
  }
  /* é¡¶éƒ¨å›¾åŠ è½½ä¼˜åŒ– */
  #page-header {
    background-image: url(/image/top-bg.jpg) !important;
    background-size: cover !important;
    background-position: center !important;
    opacity: 1 !important;
    transition: none !important;
  }
  .top-img {
    background: url(/image/top-bg.jpg) center/cover !important;
  }
</style>
<meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/top-bg.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">hfddh666's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">kernel basic</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">kernel basic</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-09-26T15:41:17.000Z" title="å‘è¡¨äº 2025-09-26 23:41:17">2025-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2026-02-06T12:52:02.436Z" title="æ›´æ–°äº 2026-02-06 20:52:02">2026-02-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;æœ¬æ–‡æœ€åæ›´æ–°äº&quot;,&quot;messageNext&quot;:&quot;å¤©å‰ï¼Œæ–‡ä¸­å†…å®¹å¯èƒ½å·²è¿‡æ—¶ã€‚&quot;,&quot;postUpdate&quot;:&quot;2026-02-06 20:52:02&quot;}" hidden></div><h1 id="linux-kernel"><a href="#linux-kernel" class="headerlink" title="linux kernel"></a>linux kernel</h1><h2 id="ä¸€-åŸºç¡€çŸ¥è¯†"><a href="#ä¸€-åŸºç¡€çŸ¥è¯†" class="headerlink" title="ä¸€.åŸºç¡€çŸ¥è¯†"></a>ä¸€.åŸºç¡€çŸ¥è¯†</h2><h3 id="1-æ“ä½œç³»ç»Ÿå†…æ ¸"><a href="#1-æ“ä½œç³»ç»Ÿå†…æ ¸" class="headerlink" title="1.æ“ä½œç³»ç»Ÿå†…æ ¸"></a><strong>1.æ“ä½œç³»ç»Ÿå†…æ ¸</strong></h3><p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/Kernel_Layout.svg" alt="Kernel_Layout"></p>
<h3 id="2-åˆ†çº§ä¿æŠ¤ç¯"><a href="#2-åˆ†çº§ä¿æŠ¤ç¯" class="headerlink" title="2.åˆ†çº§ä¿æŠ¤ç¯"></a>2.åˆ†çº§ä¿æŠ¤ç¯</h3><p><strong>é€šè¿‡ç¡¬ä»¶å®ç°</strong></p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/ring_model.png" alt="Ring Model"></p>
<p>**ç”¨æˆ·æ€ï¼š**CPUå±äºring 3çº§åˆ«ï¼Œè¿è¡Œå¹³å¸¸å†™çš„ä»£ç (C&#x2F;C++)</p>
<p>**å†…æ ¸æ€ï¼š**CPUå±äºring 0çº§åˆ«</p>
<h3 id="3-çŠ¶æ€åˆ‡æ¢"><a href="#3-çŠ¶æ€åˆ‡æ¢" class="headerlink" title="3.çŠ¶æ€åˆ‡æ¢"></a>3.çŠ¶æ€åˆ‡æ¢</h3><p>CPU åœ¨ä¸åŒçš„ç‰¹æƒçº§é—´è¿›è¡Œåˆ‡æ¢ä¸»è¦æœ‰ä¸¤ä¸ªé€”å¾„ï¼š</p>
<p>â€‹        <strong>(1)ä¸­æ–­ä¸å¼‚å¸¸</strong>ï¼ˆinterrupt &amp; exceptionï¼‰ï¼šå½“ CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ &#x2F; å¼‚å¸¸æ—¶ï¼Œä¼šåˆ‡æ¢åˆ° ring0ï¼Œå¹¶                                   æ ¹æ®ä¸­æ–­æè¿°ç¬¦è¡¨ç´¢å¼•å¯¹åº”çš„ä¸­æ–­å¤„ç†ä»£ç ä»¥æ‰§è¡Œã€‚</p>
<p>â€‹        <strong>(2)ç‰¹æƒçº§ç›¸å…³æŒ‡ä»¤</strong>ï¼šå½“ CPU è¿è¡Œè¿™äº›æŒ‡ä»¤æ—¶ä¼šå‘ç”Ÿè¿è¡ŒçŠ¶æ€çš„æ”¹å˜ï¼Œä¾‹å¦‚ iret æŒ‡ä»¤ï¼ˆring0-&gt;ring3ï¼‰æˆ–æ˜¯ sysenter æŒ‡ä»¤ï¼ˆring3-&gt;ring0ï¼‰ã€‚</p>
<p>â€‹        åŸºäºè¿™äº›ç‰¹æƒçº§åˆ‡æ¢çš„æ–¹å¼ï¼Œç°ä»£æ“ä½œç³»ç»Ÿçš„å¼€å‘è€…åŒ…è£…å‡ºäº†ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ï¼Œä½œä¸ºç”± â€œç”¨æˆ·æ€â€ åˆ‡æ¢åˆ° â€œå†…æ ¸æ€â€ çš„å…¥å£ï¼Œä»è€Œæ‰§è¡Œå†…æ ¸ä»£ç æ¥å®Œæˆç”¨æˆ·è¿›ç¨‹æ‰€éœ€çš„ä¸€äº›åŠŸèƒ½ã€‚å½“ç”¨æˆ·è¿›ç¨‹æƒ³è¦è¯·æ±‚æ›´é«˜æƒé™çš„æœåŠ¡æ—¶ï¼Œä¾¿éœ€è¦é€šè¿‡ç”±ç³»ç»Ÿæä¾›çš„åº”ç”¨æ¥å£ï¼Œä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä»¥é™·å…¥å†…æ ¸æ€ï¼Œå†ç”±æ“ä½œç³»ç»Ÿå®Œæˆè¯·æ±‚ã€‚</p>
<h4 id="user-space-to-kernel-space-ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰"><a href="#user-space-to-kernel-space-ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰" class="headerlink" title="user space to kernel space ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰"></a>user space to kernel space ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</h4><p> å½“å‘ç”Ÿ <code>ç³»ç»Ÿè°ƒç”¨</code>ï¼Œ<code>äº§ç”Ÿå¼‚å¸¸</code>ï¼Œ<code>å¤–è®¾äº§ç”Ÿä¸­æ–­</code> ç­‰äº‹ä»¶æ—¶ï¼Œä¼šå‘ç”Ÿç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œè¿›å…¥åˆ°å†…æ ¸ç›¸å¯¹åº”çš„å¤„ç†ç¨‹åºä¸­è¿›è¡Œå¤„ç†ã€‚ </p>
<p><strong>CPUè¿›å…¥å†…æ ¸æ€ä¼šè¿›è¡Œçš„ä»¥ä¸‹æ“ä½œï¼š</strong></p>
<ol>
<li><p>é€šè¿‡ <code>swapgs</code> åˆ‡æ¢ GS æ®µå¯„å­˜å™¨ï¼Œå°† GS å¯„å­˜å™¨å€¼å’Œä¸€ä¸ªç‰¹å®šä½ç½®çš„å€¼è¿›è¡Œäº¤æ¢ï¼Œç›®çš„æ˜¯ä¿å­˜ GS å€¼ï¼ŒåŒæ—¶å°†è¯¥ä½ç½®çš„å€¼ä½œä¸ºå†…æ ¸æ‰§è¡Œæ—¶çš„ GS å€¼ä½¿ç”¨ã€‚</p>
</li>
<li><p>å°†å½“å‰æ ˆé¡¶ï¼ˆç”¨æˆ·ç©ºé—´æ ˆé¡¶ï¼‰è®°å½•åœ¨ CPU ç‹¬å å˜é‡åŒºåŸŸé‡Œï¼Œå°† CPU ç‹¬å åŒºåŸŸé‡Œè®°å½•çš„å†…æ ¸æ ˆé¡¶æ”¾å…¥ rsp&#x2F;espã€‚</p>
</li>
<li><p>é€šè¿‡ push ä¿å­˜å„å¯„å­˜å™¨å€¼ï¼Œå…·ä½“çš„ <a target="_blank" rel="noopener" href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S">ä»£ç </a> å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> ENTRY(entry_SYSCALL_64)</span><br><span class="line"> /* SWAPGS_UNSAFE_STACKæ˜¯ä¸€ä¸ªå®ï¼Œx86ç›´æ¥å®šä¹‰ä¸ºswapgsæŒ‡ä»¤ */</span><br><span class="line"> SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line"> /* ä¿å­˜æ ˆå€¼ï¼Œå¹¶è®¾ç½®å†…æ ¸æ ˆ */</span><br><span class="line"> movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"> movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* é€šè¿‡pushä¿å­˜å¯„å­˜å™¨å€¼ï¼Œå½¢æˆä¸€ä¸ªpt_regsç»“æ„ */</span><br><span class="line">/* Construct struct pt_regs on stack */</span><br><span class="line">pushq  $__USER_DS      /* pt_regs-&gt;ss */</span><br><span class="line">pushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs-&gt;sp */</span><br><span class="line">pushq  %r11             /* pt_regs-&gt;flags */</span><br><span class="line">pushq  $__USER_CS      /* pt_regs-&gt;cs */</span><br><span class="line">pushq  %rcx             /* pt_regs-&gt;ip */</span><br><span class="line">pushq  %rax             /* pt_regs-&gt;orig_ax */</span><br><span class="line">pushq  %rdi             /* pt_regs-&gt;di */</span><br><span class="line">pushq  %rsi             /* pt_regs-&gt;si */</span><br><span class="line">pushq  %rdx             /* pt_regs-&gt;dx */</span><br><span class="line">pushq  %rcx tuichu    /* pt_regs-&gt;cx */</span><br><span class="line">pushq  $-ENOSYS        /* pt_regs-&gt;ax */</span><br><span class="line">pushq  %r8              /* pt_regs-&gt;r8 */</span><br><span class="line">pushq  %r9              /* pt_regs-&gt;r9 */</span><br><span class="line">pushq  %r10             /* pt_regs-&gt;r10 */</span><br><span class="line">pushq  %r11             /* pt_regs-&gt;r11 */</span><br><span class="line">sub $(6*8), %rsp      /* pt_regs-&gt;bp, bx, r12-15 not saved */</span><br></pre></td></tr></table></figure>

<p>4.é€šè¿‡æ±‡ç¼–æŒ‡ä»¤åˆ¤æ–­æ˜¯å¦ä¸º <code>x32_abi</code>ã€‚</p>
<p>5.é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·ï¼Œè·³åˆ°å…¨å±€å˜é‡ <code>sys_call_table</code> ç›¸åº”ä½ç½®ç»§ç»­æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
</li>
</ol>
<h4 id="kernel-space-to-user-space"><a href="#kernel-space-to-user-space" class="headerlink" title="kernel space to user space"></a>kernel space to user space</h4><p>é€€å‡ºæ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡ <code>swapgs</code> æ¢å¤ GS å€¼ã€‚</li>
<li>é€šè¿‡ <code>sysretq</code> æˆ–è€… <code>iretq</code> æ¢å¤åˆ°ç”¨æˆ·æ§ä»¶ç»§ç»­æ‰§è¡Œã€‚å¦‚æœä½¿ç”¨ <code>iretq</code> è¿˜éœ€è¦ç»™å‡ºç”¨æˆ·ç©ºé—´çš„ä¸€äº›ä¿¡æ¯ï¼ˆCS, eflags&#x2F;rflags, esp&#x2F;rsp ç­‰ï¼‰ã€‚</li>
</ol>
<h3 id="4-è™šæ‹Ÿå†…å­˜ç©ºé—´"><a href="#4-è™šæ‹Ÿå†…å­˜ç©ºé—´" class="headerlink" title="4.è™šæ‹Ÿå†…å­˜ç©ºé—´"></a>4.è™šæ‹Ÿå†…å­˜ç©ºé—´</h3><p><strong>32ä½</strong></p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/mm_layout_32.png" alt="32 ä½ç³»ç»Ÿå†…å­˜å¸ƒå±€"></p>
<p><strong>64ä½</strong></p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/mm_layout_64.png" alt="64 ä½ç³»ç»Ÿå†…å­˜å¸ƒå±€"></p>
<h3 id="5-è¿›ç¨‹æƒé™ç®¡ç†"><a href="#5-è¿›ç¨‹æƒé™ç®¡ç†" class="headerlink" title="5.è¿›ç¨‹æƒé™ç®¡ç†"></a>5.è¿›ç¨‹æƒé™ç®¡ç†</h3><h4 id="è¿›ç¨‹æè¿°ç¬¦"><a href="#è¿›ç¨‹æè¿°ç¬¦" class="headerlink" title="è¿›ç¨‹æè¿°ç¬¦"></a>è¿›ç¨‹æè¿°ç¬¦</h4><p>åœ¨å†…æ ¸ä¸­ç”¨task_structè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹</p>
<p>ä¸€ä¸ªè¿›ç¨‹æè¿°ç¬¦è¡¨ç¤ºï¼šç”±å¤šä¸ªstructç»„æˆ</p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/task_struct.png" alt="task_struct"></p>
<h4 id="è¿›ç¨‹æƒé™å‡­è¯"><a href="#è¿›ç¨‹æƒé™å‡­è¯" class="headerlink" title="è¿›ç¨‹æƒé™å‡­è¯"></a>è¿›ç¨‹æƒé™å‡­è¯</h4><p>task_structæºç å­˜åœ¨ä¸€ä¸ªcredç»“æ„ä½“ï¼Œcredç”¨äºç®¡ç†ä¸€ä¸ªè¿›ç¨‹çš„æƒé™</p>
<p>ä¸€ä¸ª cred ç»“æ„ä½“ä¸­è®°è½½äº†ä¸€ä¸ªè¿›ç¨‹å››ç§ä¸åŒçš„ç”¨æˆ· IDï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹è¿™å‡ ä¸ª ID åº”å½“éƒ½æ˜¯ç›¸åŒçš„ï¼š</p>
<ul>
<li>çœŸå®ç”¨æˆ· IDï¼ˆreal UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶çš„ç”¨æˆ· ID</li>
<li>ä¿å­˜ç”¨æˆ· IDï¼ˆsaved UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æœ€åˆçš„æœ‰æ•ˆç”¨æˆ· ID</li>
<li>æœ‰æ•ˆç”¨æˆ· IDï¼ˆeffective UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ· IDï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ· ID è¿›è¡Œè®¤è¯çš„ï¼Œå†…æ ¸é€šè¿‡ euid æ¥è¿›è¡Œç‰¹æƒåˆ¤æ–­ï¼›ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¸€ç›´ä½¿ç”¨é«˜æƒé™ï¼Œå½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œeuid ä¼šä¸ suid è¿›è¡Œäº¤æ¢ï¼Œæ¢å¤è¿›ç¨‹çš„æœ‰æ•ˆæƒé™</li>
<li>æ–‡ä»¶ç³»ç»Ÿç”¨æˆ· IDï¼ˆUID for VFS opsï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ· ID</li>
</ul>
<p>ç”¨æˆ·ç»„ ID åŒæ ·åˆ†ä¸ºå››ä¸ªï¼šçœŸå®ç»„ IDã€ä¿å­˜ç»„ IDã€æœ‰æ•ˆç»„ IDã€æ–‡ä»¶ç³»ç»Ÿç»„ IDï¼Œä¸ç”¨æˆ· ID æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™ã€‚</p>
<h4 id="è¿›ç¨‹æƒé™æ”¹å˜"><a href="#è¿›ç¨‹æƒé™æ”¹å˜" class="headerlink" title="è¿›ç¨‹æƒé™æ”¹å˜"></a>è¿›ç¨‹æƒé™æ”¹å˜</h4><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œä¸€ä¸ªè¿›ç¨‹çš„æƒé™æ˜¯ç”±ä½äºå†…æ ¸ç©ºé—´çš„ <code>cred</code> ç»“æ„ä½“è¿›è¡Œç®¡ç†çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼šåªè¦æ”¹å˜ä¸€ä¸ªè¿›ç¨‹çš„ <code>cred</code> ç»“æ„ä½“ï¼Œå°±èƒ½æ”¹å˜å…¶æ‰§è¡Œæƒé™ã€‚</p>
<p>åœ¨å†…æ ¸ç©ºé—´æœ‰å¦‚ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼Œéƒ½ä½äº <code>kernel/cred.c</code> ä¸­ï¼š</p>
<ul>
<li><code>struct cred* prepare_kernel_cred(struct task_struct* daemon)</code>ï¼šè¯¥å‡½æ•°ç”¨ä»¥æ‹·è´ä¸€ä¸ªè¿›ç¨‹çš„ cred ç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ cred ç»“æ„ä½“ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ daemon å‚æ•°åº”ä¸ºæœ‰æ•ˆçš„è¿›ç¨‹æè¿°ç¬¦åœ°å€ã€‚</li>
<li><code>int commit_creds(struct cred *new)</code>ï¼šè¯¥å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ªæ–°çš„ cred ç»“æ„ä½“åº”ç”¨åˆ°è¿›ç¨‹ã€‚</li>
</ul>
<h3 id="6-Loadable-Kernel-Modules-LKMs"><a href="#6-Loadable-Kernel-Modules-LKMs" class="headerlink" title="6.Loadable Kernel Modules(LKMs)"></a>6.Loadable Kernel Modules(LKMs)</h3><p> Linux Kernel é‡‡ç”¨çš„æ˜¯å®å†…æ ¸(ä½†å…¶æœ¬èº«æ˜¯ä¸€ä¸ªå•å†…æ ¸)æ¶æ„ï¼Œä¸€åˆ‡çš„ç³»ç»ŸæœåŠ¡éƒ½éœ€è¦ç”±å†…æ ¸æ¥æä¾›ï¼Œ </p>
<p>LKMS ä½äºå†…æ ¸ç©ºé—´çš„ LKMs </p>
<p>å¸¸è§çš„ LKMs åŒ…æ‹¬ï¼š</p>
<ul>
<li>é©±åŠ¨ç¨‹åºï¼ˆDevice driversï¼‰<ul>
<li>è®¾å¤‡é©±åŠ¨</li>
<li>æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨</li>
<li>â€¦</li>
</ul>
</li>
<li>å†…æ ¸æ‰©å±•æ¨¡å— (modules)</li>
</ul>
<p> LKMs çš„æ–‡ä»¶æ ¼å¼å’Œç”¨æˆ·æ€çš„å¯æ‰§è¡Œç¨‹åºç›¸åŒï¼ŒLinux ä¸‹ä¸º ELFï¼ŒWindows ä¸‹ä¸º exe&#x2F;dllï¼Œmac ä¸‹ä¸º MACH-Oï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ IDA ç­‰å·¥å…·æ¥åˆ†æå†…æ ¸æ¨¡å—ã€‚ </p>
<p>æ¨¡å—å¯ä»¥è¢«å•ç‹¬ç¼–è¯‘ï¼Œä½†ä¸èƒ½è¢«å•ç‹¬è¿è¡Œ</p>
<h4 id="ç›¸å…³æŒ‡ä»¤"><a href="#ç›¸å…³æŒ‡ä»¤" class="headerlink" title="ç›¸å…³æŒ‡ä»¤"></a>ç›¸å…³æŒ‡ä»¤</h4><ul>
<li><strong>insmod</strong>: è®²æŒ‡å®šæ¨¡å—åŠ è½½åˆ°å†…æ ¸ä¸­</li>
<li><strong>rmmod</strong>: ä»å†…æ ¸ä¸­å¸è½½æŒ‡å®šæ¨¡å—</li>
<li><strong>lsmod</strong>: åˆ—å‡ºå·²ç»åŠ è½½çš„æ¨¡å—</li>
<li><strong>modprobe</strong>: æ·»åŠ æˆ–åˆ é™¤æ¨¡å—ï¼Œmodprobe åœ¨åŠ è½½æ¨¡å—æ—¶ä¼šæŸ¥æ‰¾ä¾èµ–å…³ç³»</li>
</ul>
<h3 id="7-å†…æ ¸äº¤äº’"><a href="#7-å†…æ ¸äº¤äº’" class="headerlink" title="7.å†…æ ¸äº¤äº’"></a>7.å†…æ ¸äº¤äº’</h3><h4 id="ç³»ç»Ÿè°ƒç”¨ï¼šioctlï¼ˆå¯ä»¥ç›´æ¥å¯»å€ï¼‰"><a href="#ç³»ç»Ÿè°ƒç”¨ï¼šioctlï¼ˆå¯ä»¥ç›´æ¥å¯»å€ï¼‰" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨ï¼šioctlï¼ˆå¯ä»¥ç›´æ¥å¯»å€ï¼‰"></a>ç³»ç»Ÿè°ƒç”¨ï¼šioctlï¼ˆå¯ä»¥ç›´æ¥å¯»å€ï¼‰</h4><p>åœ¨ <code>*NIX</code> ä¸­ä¸€åˆ‡éƒ½å¯ä»¥è¢«è§†ä¸ºæ–‡ä»¶ï¼Œå› è€Œä¸€åˆ‡éƒ½å¯ä»¥ä»¥è®¿é—®æ–‡ä»¶çš„æ–¹å¼è¿›è¡Œæ“ä½œï¼Œä¸ºäº†æ–¹ä¾¿ï¼ŒLinux å®šä¹‰äº†ç³»ç»Ÿè°ƒç”¨ <code>ioctl</code> ä¾›è¿›ç¨‹ä¸è®¾å¤‡ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</p>
<p><code>ioctl</code> æ˜¯ä¸€ä¸ªä¸“ç”¨äºè®¾å¤‡è¾“å…¥è¾“å‡ºæ“ä½œçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå…¶è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ioctl(int fd, unsigned long request, ...)</span><br></pre></td></tr></table></figure>

<p>å…¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ‰“å¼€è®¾å¤‡ (open) è¿”å›çš„ <a target="_blank" rel="noopener" href="http://m4x.fun/post/play-with-file-descriptor-1/">æ–‡ä»¶æè¿°ç¬¦</a>ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ï¼Œå†åè¾¹çš„å‚æ•°åˆ™æ˜¯ä¸€äº›è¡¥å……å‚æ•°ï¼Œä¸è®¾å¤‡æœ‰å…³ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæä¾›äº† ioctl é€šä¿¡æ–¹å¼çš„è®¾å¤‡è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶æ–‡ä»¶æè¿°ç¬¦ã€ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ç åŠå…¶ä»–è¯·æ±‚å‚æ•°é€šè¿‡ ioctl ç³»ç»Ÿè°ƒç”¨å®Œæˆä¸åŒçš„å¯¹è®¾å¤‡çš„ I&#x2F;O æ“ä½œã€‚</p>
<h3 id="8-å¸¸è§å†…æ ¸æ€å‡½æ•°"><a href="#8-å¸¸è§å†…æ ¸æ€å‡½æ•°" class="headerlink" title="8.å¸¸è§å†…æ ¸æ€å‡½æ•°"></a>8.å¸¸è§å†…æ ¸æ€å‡½æ•°</h3><p>å¸¸ç”¨çš„åŠŸèƒ½å‡½æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li>printf() -&gt; <strong>printk()</strong>ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ printk() ä¸ä¸€å®šä¼šæŠŠå†…å®¹æ˜¾ç¤ºåˆ°ç»ˆç«¯ä¸Šï¼Œä½†ä¸€å®šåœ¨å†…æ ¸ç¼“å†²åŒºé‡Œï¼Œå¯ä»¥é€šè¿‡ <code>dmesg</code> æŸ¥çœ‹æ•ˆæœ</li>
<li>memcpy() -&gt;copy_from_user()&#x2F;copy_to_user()<ul>
<li>copy_from_user() å®ç°äº†å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°å†…æ ¸ç©ºé—´</li>
<li>copy_to_user() å®ç°äº†å°†å†…æ ¸ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´</li>
</ul>
</li>
<li>malloc() -&gt; <strong>kmalloc()</strong>ï¼Œå†…æ ¸æ€çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå’Œ malloc() ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„æ˜¯ <code>slab/slub åˆ†é…å™¨</code></li>
<li>free() -&gt; <strong>kfree()</strong>ï¼ŒåŒ kmalloc()</li>
</ul>
<p>æ­¤å¤–ï¼Œ<code>kernel ç®¡ç†è¿›ç¨‹ï¼Œå› æ­¤ kernel ä¹Ÿè®°å½•äº†è¿›ç¨‹çš„æƒé™</code>ã€‚kernel ä¸­æœ‰ä¸¤ä¸ªå¯ä»¥æ–¹ä¾¿çš„æ”¹å˜æƒé™çš„å‡½æ•°ï¼š</p>
<ul>
<li><strong>int commit_creds(struct cred *new)</strong></li>
<li><strong>struct cred* prepare_kernel_cred(struct task_struct* daemon)</strong></li>
</ul>
<p>ä»å‡½æ•°åä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(&amp;init_task))</code> å³å¯è·å¾— root æƒé™ï¼Œå³æ‹·è´ init è¿›ç¨‹çš„ cred ä½œä¸ºå½“å‰è¿›ç¨‹çš„æ–°çš„ credentialsã€‚</p>
<p>æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(&amp;init_task))</code> ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ææƒæ‰‹æ®µï¼Œè¿™äº›å‡½æ•°ä¸å˜é‡çš„åœ°å€éƒ½å¯ä»¥åœ¨ <code>/proc/kallsyms</code> ä¸­æŸ¥çœ‹ï¼ˆè¾ƒè€çš„å†…æ ¸ç‰ˆæœ¬ä¸­æ˜¯ <code>/proc/ksyms</code>ï¼‰ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹é€šå¸¸éœ€è¦ root æƒé™æ‰èƒ½æ­£ç¡®æŸ¥çœ‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat /proc/kallsyms | grep &quot;T commit_creds&quot;</span><br><span class="line">ffffffffbb11ab20 T commit_creds</span><br><span class="line">$ sudo cat /proc/kallsyms | grep &quot;T prepare_kernel_cred&quot;</span><br><span class="line">ffffffffbb11b080 T prepare_kernel_cred</span><br><span class="line">$ sudo cat /proc/kallsyms | grep &quot;D init_cred&quot;</span><br><span class="line">ffffffffbce58840 D init_cred</span><br></pre></td></tr></table></figure>

<h3 id="9-ä¿æŠ¤æœºåˆ¶"><a href="#9-ä¿æŠ¤æœºåˆ¶" class="headerlink" title="9.ä¿æŠ¤æœºåˆ¶"></a>9.ä¿æŠ¤æœºåˆ¶</h3><h4 id="é€šç”¨ä¿æŠ¤"><a href="#é€šç”¨ä¿æŠ¤" class="headerlink" title="é€šç”¨ä¿æŠ¤"></a>é€šç”¨ä¿æŠ¤</h4><p><strong>kaslr</strong>ï¼šå†…å­˜åœ°å€éšæœºåŒ–ï¼ŒåŠ ä¸ªåç§»å€¼ï¼› åœ¨æœªå¼€å¯ KASLR ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œå†…æ ¸ä»£ç æ®µçš„åŸºå€ä¸º <code>0xffffffff81000000</code> ï¼Œdirect mapping area çš„åŸºå€ä¸º <code>0xffff888000000000</code>ã€‚ </p>
<p><strong>å†…å­˜å¸ƒå±€ï¼š <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.3/source/Documentation/x86/x86_64/mm.rst">è¿™é‡Œ</a></strong> </p>
<p>*<strong>fgaslr</strong></p>
<p><strong>canary</strong></p>
<p><strong>smap|smep</strong>ï¼šSMAP å³<code>ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤</code>ï¼ŒSMEP å³<code>ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤</code>ï¼Œè¿™ä¸¤ç§ä¿æŠ¤é€šå¸¸æ˜¯åŒæ—¶å¼€å¯çš„ï¼Œç”¨ä»¥é˜»æ­¢<strong>å†…æ ¸ç©ºé—´ç›´æ¥è®¿é—® &#x2F; æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®</strong>ï¼Œå®Œå…¨åœ°å°†å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´ç›¸åˆ†éš”å¼€ï¼Œç”¨ä»¥é˜²èŒƒ ret2usrï¼ˆreturn-to-userï¼Œå°†å†…æ ¸ç©ºé—´çš„æŒ‡ä»¤æŒ‡é’ˆé‡å®šå‘è‡³ç”¨æˆ·ç©ºé—´ä¸Šæ„é€ å¥½çš„ææƒä»£ç ï¼‰æ”»å‡»ã€‚</p>
<p>SMEP ä¿æŠ¤çš„ç»•è¿‡æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>åˆ©ç”¨å†…æ ¸çº¿æ€§æ˜ å°„åŒºå¯¹ç‰©ç†åœ°å€ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œæ‰¾åˆ°ç”¨æˆ·ç©ºé—´å¯¹åº”é¡µæ¡†çš„å†…æ ¸ç©ºé—´åœ°å€ï¼Œåˆ©ç”¨è¯¥å†…æ ¸åœ°å€å®Œæˆå¯¹ç”¨æˆ·ç©ºé—´çš„è®¿é—®ï¼ˆå³ä¸€ä¸ªå†…æ ¸ç©ºé—´åœ°å€ä¸ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€æ˜ å°„åˆ°äº†åŒä¸€ä¸ªé¡µæ¡†ä¸Šï¼‰ï¼Œè¿™ç§æ”»å‡»æ‰‹æ³•ç§°ä¸º ret2dir ã€‚</li>
<li>Intel ä¸‹ç³»ç»Ÿæ ¹æ® CR4 æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬ 20 ä½æ ‡è¯†æ˜¯å¦å¼€å¯ SMEP ä¿æŠ¤ï¼ˆ1 ä¸ºå¼€å¯ï¼Œ0 ä¸ºå…³é—­ï¼‰ï¼Œè‹¥æ˜¯èƒ½å¤Ÿé€šè¿‡ kernel ROP æ”¹å˜ CR4 å¯„å­˜å™¨çš„å€¼ä¾¿èƒ½å¤Ÿå…³é—­ SMEP ä¿æŠ¤ï¼Œå®Œæˆ SMEP-bypassï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿé‡æ–°è¿›è¡Œ ret2usrï¼Œ<strong>ä½†å¯¹äºå¼€å¯äº† KPTI çš„å†…æ ¸è€Œè¨€ï¼Œå†…æ ¸é¡µè¡¨çš„ç”¨æˆ·åœ°å€ç©ºé—´æ— æ‰§è¡Œæƒé™ï¼Œè¿™ä½¿å¾— ret2usr å½»åº•æˆä¸ºè¿‡å»å¼</strong> ã€‚</li>
</ul>
<p><strong>kpie</strong>:</p>
<p> <strong>åœ¨è¿™ä¸¤å¼ é¡µè¡¨ä¸Šéƒ½æœ‰ç€å¯¹ç”¨æˆ·å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œä½†åœ¨ç”¨æˆ·é¡µè¡¨ä¸­åªæ˜ å°„äº†å°‘é‡çš„å†…æ ¸ä»£ç ï¼ˆä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ã€ä¸­æ–­å¤„ç†ç­‰ï¼‰ï¼Œè€Œåªæœ‰åœ¨å†…æ ¸é¡µè¡¨ä¸­æ‰æœ‰ç€å¯¹å†…æ ¸å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œä½†ä¸¤å¼ é¡µè¡¨éƒ½æœ‰ç€å¯¹ç”¨æˆ·å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„</strong> </p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/kpti.png" alt="KPTI"></p>
<p> KPTI åŒæ—¶è¿˜ä»¤å†…æ ¸é¡µè¡¨ä¸­å±äºç”¨æˆ·åœ°å€ç©ºé—´çš„éƒ¨åˆ†ä¸å†æ‹¥æœ‰æ‰§è¡Œæƒé™ï¼Œè¿™ä½¿å¾— ret2usr å½»åº•æˆä¸ºè¿‡å»å¼ã€‚ </p>
<h4 id="å †ä¿æŠ¤"><a href="#å †ä¿æŠ¤" class="headerlink" title="å †ä¿æŠ¤"></a>å †ä¿æŠ¤</h4><p><strong>1.Hardened Usercopy</strong></p>
<p>hardened usercopy æ˜¯ç”¨ä»¥åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´æ•°æ®æ—¶è¿›è¡Œè¶Šç•Œæ£€æŸ¥çš„ä¸€ç§é˜²æŠ¤æœºåˆ¶ï¼Œ<strong>ä¸»è¦æ£€æŸ¥æ‹·è´è¿‡ç¨‹ä¸­å¯¹å†…æ ¸ç©ºé—´ä¸­æ•°æ®çš„è¯»å†™æ˜¯å¦ä¼šè¶Šç•Œ</strong>ï¼š</p>
<ul>
<li>è¯»å–çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…å‡ºæº object èŒƒå›´ã€‚</li>
<li>å†™å…¥çš„æ•°æ®é•¿åº¦æ˜¯å¦è¶…å‡ºç›®çš„ object èŒƒå›´ã€‚</li>
</ul>
<p>è¿™ä¸€ä¿æŠ¤è¢«ç”¨äº <code>copy_to_user()</code> ä¸ <code>copy_from_user()</code> ç­‰æ•°æ®äº¤æ¢ API ä¸­ï¼Œä¸è¿‡è¿™ç§ä¿æŠ¤ <em>ä¸é€‚ç”¨äºå†…æ ¸ç©ºé—´å†…çš„æ•°æ®æ‹·è´</em> ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„ç»•è¿‡æ‰‹æ®µã€‚</p>
<p><strong>2.Hardened freelist</strong></p>
<p>ç±»ä¼¼äº glibc 2.32 ç‰ˆæœ¬å¼•å…¥çš„ä¿æŠ¤ï¼Œåœ¨å¼€å¯è¿™ç§ä¿æŠ¤ä¹‹å‰ï¼Œslub ä¸­çš„ free object çš„ next æŒ‡é’ˆç›´æ¥å­˜æ”¾ç€ next free object çš„åœ°å€ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¯»å– freelist æ³„éœ²å‡ºå†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€ï¼Œåœ¨å¼€å¯äº†è¯¥ä¿æŠ¤ä¹‹å free object çš„ next æŒ‡é’ˆå­˜æ”¾çš„æ˜¯ç”±ä»¥ä¸‹ä¸‰ä¸ªå€¼è¿›è¡Œå¼‚æˆ–æ“ä½œåçš„å€¼ï¼š</p>
<ul>
<li>å½“å‰ free object çš„åœ°å€ã€‚</li>
<li>ä¸‹ä¸€ä¸ª free object çš„åœ°å€ã€‚</li>
<li>ç”± kmem_cache æŒ‡å®šçš„ä¸€ä¸ª random å€¼ã€‚</li>
</ul>
<p>æ”»å‡»è€…è‡³å°‘éœ€è¦è·å–åˆ°ç¬¬ä¸€ä¸ç¬¬ä¸‰ä¸ªå€¼æ‰èƒ½ç¯¡æ”¹ freelistï¼Œè¿™æ— ç–‘ä¸ºå¯¹ freelist çš„ç›´æ¥åˆ©ç”¨å¢æ·»ä¸å°‘éš¾åº¦ã€‚</p>
<p><strong>3.Random freelist</strong></p>
<p> slub allocator åˆšä» buddy system æ‹¿åˆ°æ–° slub çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ freelist çš„æ„æˆä»éµå¾ª LIFOã€‚ </p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/figure/freelist_random.png" alt="Random freelist"></p>
<h2 id="äºŒ-å†…æ ¸æºç ä¸‹è½½ä¸ç¼–è¯‘"><a href="#äºŒ-å†…æ ¸æºç ä¸‹è½½ä¸ç¼–è¯‘" class="headerlink" title="äºŒ.å†…æ ¸æºç ä¸‹è½½ä¸ç¼–è¯‘"></a>äºŒ.å†…æ ¸æºç ä¸‹è½½ä¸ç¼–è¯‘</h2><h3 id="1-ä¸‹è½½å†…æ ¸æºç "><a href="#1-ä¸‹è½½å†…æ ¸æºç " class="headerlink" title="1.ä¸‹è½½å†…æ ¸æºç "></a>1.ä¸‹è½½å†…æ ¸æºç </h3><p>æ ¹æ® <a target="_blank" rel="noopener" href="https://www.kernel.org/category/releases.html">Archive kernel releases</a>ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å†…æ ¸ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç±»åˆ«ï¼š</p>
<ul>
<li>Prepatch (RC) ï¼šä¸»çº¿å†…æ ¸çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«äº†æœ€æ–°çš„å¾…æµ‹è¯•çš„å†…æ ¸ç‰¹æ€§ï¼Œç”± Linus Torvalds ç»´æŠ¤ã€‚</li>
<li>Mainlineï¼šä¸»çº¿å†…æ ¸ç‰ˆæœ¬ï¼ŒRC ç‰ˆæœ¬çš„æ–°ç‰¹æ€§ç»è¿‡æµ‹è¯•åä¾¿ä¼šåˆå¹¶åˆ°ä¸»çº¿ï¼Œæ¯ 9ï½10 å‘¨å‘ä¸€ä¸ªç‰ˆæœ¬ï¼Œç”± Linus Torvalds ç»´æŠ¤ã€‚</li>
<li>Stableï¼šä¸»çº¿å†…æ ¸å‘å¸ƒåä¾¿ä¼šå˜ä¸º Stable çŠ¶æ€ï¼Œå…¶ä»…ä¼šè¢« stable kernel ç»´æŠ¤è€…ä»ä¸»çº¿æ ‘åå‘ç§»æ¤ä¸€äº›æ¼æ´ä¿®å¤ï¼Œç›´åˆ°ä¸‹ä¸ªå†…æ ¸ç‰ˆæœ¬é‡Šå‡ºã€‚Stable kernel æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ–°ï¼Œé€šå¸¸æ˜¯ä¸€å‘¨ä¸€æ¬¡ã€‚</li>
<li>Longtermï¼šéƒ¨åˆ†å†…æ ¸ç‰ˆæœ¬ä¼šè¢«é€‰ä½œé•¿æœŸæ”¯æŒç‰ˆï¼ˆLTSï¼‰ï¼Œç›¸æ¯”èµ· Stable å†…æ ¸æœ‰ç€æ›´ä¹…çš„æ”¯æŒæ—¶é•¿ï¼Œé€šå¸¸ä»…ä¼šè¢«åå‘ç§»æ¤é‡è¦çš„æ¼æ´ä¿®å¤ï¼Œä¸”æ›´æ–°å‘¨æœŸè¾ƒæ…¢ï¼ˆå°¤å…¶æ˜¯å¯¹äºæ›´è€çš„ç‰ˆæœ¬ï¼‰ã€‚</li>
</ul>
<p><strong>ä¸‹è½½å†…æ ¸</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.12.16.tar.xz </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unxz ./linux-6.12.16.tar.xz </span><br></pre></td></tr></table></figure>

<p><strong>éªŒè¯ç­¾å</strong></p>
<p> å¯¼å…¥ Linus Torvalds å’Œ Greg Kroah-Hartman çš„å…¬é’¥ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --locate-keys torvalds@kernel.org gregkh@kernel.org </span><br></pre></td></tr></table></figure>

<p> ä¸‹è½½å†…æ ¸ç­¾å</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.12.16.tar.sign</span><br></pre></td></tr></table></figure>

<p>æ ¡éªŒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --verify linux-6.12.16.tar.sign </span><br></pre></td></tr></table></figure>

<p>ç»“æœä¼šæœ‰warningï¼Œå› ä¸ºå¯¼å…¥çš„å…¬é’¥æ²¡æœ‰å¯ä¿¡ç­¾åï¼Œé‚£æˆ‘ä»¬å°±è®©å…¶å¯ä¿¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --tofu-policy good 38DBBDC86092693E </span><br></pre></td></tr></table></figure>

<p>é‡æ–°éªŒè¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --trust-model tofu --verify ./linux-6.12.16.tar.sign </span><br><span class="line"></span><br><span class="line">tar -xf linux-6.12.16.tar</span><br></pre></td></tr></table></figure>

<h3 id="2-é…ç½®ç¼–è¯‘é€‰é¡¹"><a href="#2-é…ç½®ç¼–è¯‘é€‰é¡¹" class="headerlink" title="2.é…ç½®ç¼–è¯‘é€‰é¡¹"></a>2.é…ç½®ç¼–è¯‘é€‰é¡¹</h3><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆè¿›å…¥æºç ç›®å½•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls  ä¸€ä¸‹æ‰¾åˆ°æºç ç„¶å</span><br><span class="line">cd ~/æ–‡ä»¶å #ä¸€èˆ¬æ˜¯linux 6-12ä¹‹ç±»çš„</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±è¿›å…¥äº†æ–‡ä»¶æºç ç›®å½•</p>
<p>åŠ¨æ€ç”Ÿæˆç¼–è¯‘é…ç½®ç³»ç»Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å½“å‰ç³»ç»Ÿè¿›è¡Œå¾®è°ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make defconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make localyesconfig # å°†é©±åŠ¨ç¼–è¯‘åˆ°å†…æ ¸å½“ä¸­</span><br><span class="line">make allyesconfig # å°†é©±åŠ¨ç¼–è¯‘åˆ°å†…æ ¸å½“ä¸­</span><br></pre></td></tr></table></figure>

<h3 id="3-è°ƒè¯•ç›¸å…³é€‰é¡¹"><a href="#3-è°ƒè¯•ç›¸å…³é€‰é¡¹" class="headerlink" title="3.è°ƒè¯•ç›¸å…³é€‰é¡¹"></a>3.è°ƒè¯•ç›¸å…³é€‰é¡¹</h3><p>ä¾æ¬¡è¿›å…¥åˆ° Kernel hacking -&gt; Compile-time checks and compiler optionsï¼Œç„¶åå‹¾é€‰å¦‚ä¸‹é€‰é¡¹ <code>Compile the kernel with debug info</code> ï¼Œä»¥ä¾¿äºè°ƒè¯•ã€‚è¿™é€šå¸¸æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p>
<p>å¦‚æœè¦ä½¿ç”¨ kgdb è°ƒè¯•å†…æ ¸ï¼Œåˆ™éœ€è¦é€‰ä¸­ <code>KGDB: kernel debugger</code>ï¼Œå¹¶é€‰ä¸­ KGDB ä¸‹çš„æ‰€æœ‰é€‰é¡¹ã€‚</p>
<h3 id="4-ç¼–è¯‘å†…æ ¸"><a href="#4-ç¼–è¯‘å†…æ ¸" class="headerlink" title="4.ç¼–è¯‘å†…æ ¸"></a>4.ç¼–è¯‘å†…æ ¸</h3><p>è¿˜æ˜¯è¦åœ¨å†…æ ¸æºç ç›®å½•ä¸­è¿›è¡Œ</p>
<p>è·å¾—çš„æ˜¯å‹ç¼©åçš„å†…æ ¸é•œåƒæ–‡ä»¶ <code>bzImage</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make bzImage   #ç‹—å±å•Šï¼Œæ€ä¹ˆè¦è¿™ä¹ˆä¹…</span><br></pre></td></tr></table></figure>

<p> <code>-j</code> å‚æ•°æŒ‡å®šäº†åŒæ—¶è¿›è¡Œç¼–è¯‘çš„å†…æ ¸æ•°é‡ï¼Œ<code>(nproc)</code> å˜é‡åˆ™é€šå¸¸ä»£è¡¨ä½ æ‰€ä½¿ç”¨çš„æœºå™¨æ‰€æ‹¥æœ‰çš„ç¡¬ä»¶çº¿ç¨‹æ•°ï¼š </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j(nproc) bzImage</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œå½“ç»ˆç«¯å‡ºç°å¦‚ä¸‹ä¿¡æ¯æ—¶ï¼Œè¯´æ˜ç¼–è¯‘å®Œæˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>

<p>äº§ç‰©ä¸­çš„ä¸¤ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li><code>vmlinux</code>ï¼šç¼–è¯‘ç”Ÿæˆçš„ ELF æ ¼å¼çš„åŸå§‹å†…æ ¸é•œåƒæ–‡ä»¶ï¼Œé€šå¸¸ä½äºæºç æ ¹ç›®å½•ä¸‹ã€‚</li>
<li><code>bzImage</code>ï¼šå‰è€…è¿›è¡Œå‹ç¼©åçš„å†…æ ¸é•œåƒæ–‡ä»¶ï¼Œé€šå¸¸ä½äº <code>arch/æ¶æ„/boot/bzImage</code> ï¼ˆæ³¨æ„å¯¹äº x86-64 è€Œè¨€ä»æ˜¯ <code>x86</code> ç›®å½•ï¼‰ã€‚</li>
</ul>
<h2 id="å››-æ­å»ºå†…æ ¸è¿è¡Œç¯å¢ƒ"><a href="#å››-æ­å»ºå†…æ ¸è¿è¡Œç¯å¢ƒ" class="headerlink" title="å››.æ­å»ºå†…æ ¸è¿è¡Œç¯å¢ƒ"></a>å››.æ­å»ºå†…æ ¸è¿è¡Œç¯å¢ƒ</h2><h3 id="1-è·å–å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆmake-j-nproc-bzImage"><a href="#1-è·å–å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆmake-j-nproc-bzImage" class="headerlink" title="1.è·å–å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆmake -j$(nproc) bzImage)"></a>1.è·å–å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆmake -j$(nproc) bzImage)</h3><h3 id="2-ä½¿ç”¨-BusyBox-æ­å»ºåŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#2-ä½¿ç”¨-BusyBox-æ­å»ºåŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.ä½¿ç”¨ BusyBox æ­å»ºåŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿ"></a>2.ä½¿ç”¨ BusyBox æ­å»ºåŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿ</h3><p>busyboxæ˜¯ä¸€ä¸ªåŒ…å«è®¸å¤šå‘½ä»¤çš„è½¯ä»¶ã€</p>
<p>ä¸‹è½½busyboxæºç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.36.0.tar.bz2 </span><br><span class="line">tar -jxvf busybox-1.36.0.tar.bz2</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘busyboxï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig </span><br><span class="line">make -j$(nproc)</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h4 id="é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨-installç›®å½•ä¸‹è¿›è¡Œï¼‰"><a href="#é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨-installç›®å½•ä¸‹è¿›è¡Œï¼‰" class="headerlink" title="é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨_installç›®å½•ä¸‹è¿›è¡Œï¼‰"></a><strong>é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨_installç›®å½•ä¸‹è¿›è¡Œï¼‰</strong></h4><p>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cd _install </span><br><span class="line">$ mkdir -pv &#123;bin,sbin,etc,proc,sys,dev,home/ctf,root,tmp,lib64,lib/x86_64-linux-gnu,usr/&#123;bin,sbin&#125;&#125; </span><br><span class="line">$ touch etc/inittab </span><br><span class="line">$ mkdir etc/init.d </span><br><span class="line">$ touch etc/init.d/rcS </span><br><span class="line">$ chmod +x ./etc/init.d/rcS </span><br></pre></td></tr></table></figure>

<p> åœ¨ <code>./etc/inittab</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS ::askfirst:/bin/login ::ctrlaltdel:/sbin/reboot ::shutdown:/sbin/swapoff -a ::shutdown:/bin/umount -a -r ::restart:/sbin/init </span><br></pre></td></tr></table></figure>

<p> etc&#x2F;init.d&#x2F;rcS ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\#!/bin/sh </span><br><span class="line">chown -R root:root / </span><br><span class="line">chmod 700 /root </span><br><span class="line">chown -R ctf:ctf /home/ctf </span><br><span class="line">mount -t proc none /proc </span><br><span class="line">mount -t sysfs none /sys </span><br><span class="line">mount -t tmpfs tmpfs /tmp </span><br><span class="line">mkdir /dev/pts </span><br><span class="line">mount -t devpts devpts /dev/pts </span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict </span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict </span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot; </span><br><span class="line">cd /home/ctf </span><br><span class="line">su ctf -c sh </span><br><span class="line">poweroff -d 0  -f </span><br></pre></td></tr></table></figure>

<p>ç„¶åä¸ºè¿™ä¸ªè„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./etc/init.d/rcS </span><br></pre></td></tr></table></figure>

<p> æ¥ä¸‹æ¥é…ç½®ç”¨æˆ·ç»„ç›¸å…³æƒé™ï¼Œåœ¨è¿™é‡Œå»ºç«‹äº†ä¸¤ä¸ªç”¨æˆ·ç»„ <code>root</code> å’Œ <code>ctf</code> ï¼Œä»¥åŠä¸¤ä¸ªç”¨æˆ· <code>root</code> å’Œ <code>ctf</code>ï¼Œå¹¶é…ç½®äº†ä¸€æ¡æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é¡¹ï¼š </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;root:x:0:0:root:/root:/bin/sh&quot; &gt; etc/passwd </span><br><span class="line">$ echo &quot;ctf:x:1000:1000:ctf:/home/ctf:/bin/sh&quot; &gt;&gt; etc/passwd </span><br><span class="line">$ echo &quot;root:x:0:&quot; &gt; etc/group </span><br><span class="line">$ echo &quot;ctf:x:1000:&quot; &gt;&gt; etc/group </span><br><span class="line">$ echo &quot;none /dev/pts devpts gid=5,mode=620 0 0&quot; &gt; etc/fstab </span><br></pre></td></tr></table></figure>

<h4 id="æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰"><a href="#æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰" class="headerlink" title="æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰"></a>æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰</h4><p><strong>qcow2æ ¼å¼</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create -f qcow2 rootfs.qcow2 8M  #åˆ›å»ºä¸€ä¸ªqcow2æ ¼å¼çš„é•œåƒæ–‡ä»¶</span><br><span class="line">sudo qemu-nbd -c /dev/nbd0 ./rootfs.qcow2 #æŒ‚è½½ä¸ºç½‘ç»œè®¾å¤‡</span><br><span class="line">sudo mkfs.ext4 /dev/nbd0 #æ ¼å¼åŒ–ä¸ºè‡ªå·±æƒ³è¦çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¾‹å¦‚æœ€å¸¸ç”¨çš„ ext4</span><br><span class="line">sudo mount /dev/nbd0 /mnt #å¸¸è§„æŒ‚è½½</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠå‰é¢æˆ‘ä»¬æ„å»ºçš„æ–‡ä»¶ç³»ç»Ÿå†…å®¹æ‹·è´è¿›å»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp -auv _install/* /mnt</span><br><span class="line">$ sudo chown -R root:root /mnt/</span><br><span class="line">$ sudo chmod 700 /mnt/root</span><br><span class="line">$ sudo chown -R 1000:1000 /mnt/home/ctf/</span><br></pre></td></tr></table></figure>

<p>æœ€åå¸¸è§„å¸è½½å¹¶è§£ç»‘ nbd å³å¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo umount /mnt</span><br><span class="line">$ sync</span><br><span class="line">$ sudo qemu-nbd -d /dev/nbd0</span><br></pre></td></tr></table></figure>

<h3 id="3-å¯åŠ¨å†…æ ¸"><a href="#3-å¯åŠ¨å†…æ ¸" class="headerlink" title="3.å¯åŠ¨å†…æ ¸"></a>3.å¯åŠ¨å†…æ ¸</h3><p>å°†bzImageå’Œrootfs.qcow2ï¼Œkernel.shæ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kernel.sh</span><br></pre></td></tr></table></figure>

<p>kernel.shå†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\#!/bin/sh </span><br><span class="line">qemu-system-x86_64 \    </span><br><span class="line">    -m 128M \    </span><br><span class="line">    -kernel ./bzImage \    </span><br><span class="line">    -hda ./rootfs.qcow2 \    </span><br><span class="line">    -monitor /dev/null \    </span><br><span class="line">    -append &quot;root=/dev/sda rw rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet kaslr&quot; \    </span><br><span class="line">    -cpu kvm64,+smep \    </span><br><span class="line">    -smp cores=2,threads=1 \   </span><br><span class="line">    -nographic \    </span><br><span class="line">    -snapshot \    </span><br><span class="line">    -s </span><br></pre></td></tr></table></figure>

<p>å„å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼Œè¯¦ç»†è¯´æ˜å¯ä»¥å‚ç…§ QEMU çš„å®˜æ–¹æ–‡æ¡£ï¼š</p>
<ul>
<li><p><code>-m</code>ï¼šè™šæ‹Ÿæœºå†…å­˜å¤§å°ã€‚</p>
</li>
<li><p><code>-kernel</code>ï¼šå†…æ ¸é•œåƒè·¯å¾„ã€‚</p>
</li>
<li><p><code>-hda</code>ï¼šæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œæˆ‘ä»¬å°† qcow2 é•œåƒæŒ‚è½½ä¸ºä¸€ä¸ªçœŸæ­£çš„ç¡¬ç›˜è®¾å¤‡ï¼Œä¼˜ç‚¹åœ¨äºæ›´è´´è¿‘çœŸå®ç¯å¢ƒã€‚</p>
</li>
<li><p><code>-monitor</code>ï¼šå°†ç›‘è§†å™¨é‡å®šå‘åˆ°ä¸»æœºè®¾å¤‡ <code>/dev/null</code>ï¼Œè¿™é‡Œé‡å®šå‘è‡³ null ä¸»è¦æ˜¯é˜²æ­¢ CTF ä¸­è¢«äººé€šè¿‡ç›‘è§†å™¨ç›´æ¥æ‹¿ flagã€‚</p>
</li>
<li><pre><code>-append
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ï¼šå†…æ ¸å¯åŠ¨å‚æ•°é€‰é¡¹</span><br><span class="line"></span><br><span class="line">  - `root=/dev/sda rw`ï¼šè¯¥å‚æ•°è®¾å®šäº†æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨è®¾å¤‡ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ `-hda` å°†å…¶æŒ‚è½½ä¸ºä¸€ä¸ª SATA ç¡¬ç›˜ï¼Œè€Œ Linux ä¸­ç¬¬ä¸€ä¸ª SATA ç¡¬ç›˜çš„è·¯å¾„ä¸º `/dev/sda` ï¼Œå› æ­¤æˆ‘ä»¬å°†æ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„æŒ‡å‘è®¾å¤‡è·¯å¾„ï¼Œå¹¶é€šè¿‡ `rw` æ ‡è¯†æ¥ç»™äºˆå¯è¯»å†™æƒé™ã€‚</span><br><span class="line">  - `kaslr`ï¼šå¼€å¯å†…æ ¸åœ°å€éšæœºåŒ–ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹ä¸º `nokaslr` è¿›è¡Œå…³é—­ä»¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œè°ƒè¯•ã€‚</span><br><span class="line">  - `rdinit`ï¼šæŒ‡å®šåˆå§‹å¯åŠ¨è¿›ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº† `/sbin/init` ä½œä¸ºåˆå§‹è¿›ç¨‹ï¼Œæ ¹æ®æˆ‘ä»¬å‰é¢çš„é…ç½®å…¶ä¼šé»˜è®¤ä»¥ `/etc/init.d/rcS` ä½œä¸ºå¯åŠ¨è„šæœ¬ã€‚</span><br><span class="line">  - `loglevel=3` &amp; `quiet`ï¼šä¸è¾“å‡º logã€‚</span><br><span class="line">  - `console=ttyS0`ï¼šæŒ‡å®šç»ˆç«¯ä¸º `/dev/ttyS0`ï¼Œè¿™æ ·ä¸€å¯åŠ¨å°±èƒ½è¿›å…¥ç»ˆç«¯ç•Œé¢ã€‚</span><br><span class="line"></span><br><span class="line">- `-cpu`ï¼šè®¾ç½® CPU é€‰é¡¹ï¼Œåœ¨è¿™é‡Œå¼€å¯äº† smep ä¿æŠ¤ã€‚</span><br><span class="line"></span><br><span class="line">- `-smp`ï¼šè®¾ç½®å¯¹ç§°å¤šå¤„ç†å™¨é…ç½®ï¼Œè¿™é‡Œè®¾ç½®äº†ä¸¤ä¸ªæ ¸å¿ƒï¼Œæ¯ä¸ªæ ¸å¿ƒä¸€ä¸ªçº¿ç¨‹ã€‚</span><br><span class="line"></span><br><span class="line">- `-nographic`ï¼šä¸æä¾›å›¾å½¢åŒ–ç•Œé¢ï¼Œæ­¤æ—¶å†…æ ¸ä»…æœ‰ä¸²å£è¾“å‡ºï¼Œè¾“å‡ºå†…å®¹ä¼šè¢« QEMU é‡å®šå‘è‡³æˆ‘ä»¬çš„ç»ˆç«¯ã€‚</span><br><span class="line"></span><br><span class="line">- `-snapshot`ï¼šä½¿ç”¨å¿«ç…§çš„æ–¹å¼å¯åŠ¨ï¼Œè¿™æ ·åœ¨è™šæ‹Ÿæœºå½“ä¸­å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä¸ä¼š â€œè½ç›˜â€ã€‚</span><br><span class="line"></span><br><span class="line">- `-s`ï¼šç›¸å½“äº`-gdb tcp::1234`çš„ç®€å†™ï¼ˆä¹Ÿå¯ä»¥ç›´æ¥è¿™ä¹ˆå†™ï¼‰ï¼Œåç»­æˆ‘ä»¬å¯ä»¥é€šè¿‡ gdb è¿æ¥æœ¬åœ°ç«¯å£è¿›è¡Œè°ƒè¯•ã€‚</span><br><span class="line"></span><br><span class="line">å¯åŠ¨åæ•ˆæœï¼š![1756207588927](C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1756207588927.png)</span><br><span class="line"></span><br><span class="line">### 4.åŠ è½½é©±åŠ¨</span><br><span class="line"></span><br><span class="line">å°†ç”Ÿæˆçš„.koæ–‡ä»¶æ”¾åœ¨ä¸€èµ·çš„æ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨init.dä¸­æ·»åŠ insmodå‘½ä»¤æ·»åŠ </span><br><span class="line"></span><br></pre></td></tr></table></figure>
chown -R root:root / 
chmod 700 /root 
chown -R ctf:ctf /home/ctf 
mount -t proc none /proc 
mount -t sysfs none /sys 
mount -t tmpfs tmpfs /tmp 
mkdir /dev/pts 
mount -t devpts devpts /dev/pts 
echo 1 &gt; /proc/sys/kernel/dmesg_restrict 
echo 1 &gt; /proc/sys/kernel/kptr_restrict 
insmod /root/a3kmod.ko 
echo -e &quot;\nBoot took $(cut -d&#39; &#39; -f1 /proc/uptime) seconds\n&quot; 
cd /root 
su root -c sh 
poweroff -d 0  -f
</code></pre>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> å¯åŠ¨å†…æ ¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ dmesg æŸ¥çœ‹è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®åŠ è½½äº†å¯¹åº”çš„ ko </span><br><span class="line"></span><br><span class="line">### 5.è°ƒè¯•åˆ†æ</span><br><span class="line"></span><br><span class="line">initè„šæœ¬ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> su root -c sh  #ä»¥rootç”¨æˆ·å¯åŠ¨<br> su ctf -c sh  #ä»¥ä½¿ç”¨è€…å¯åŠ¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å†…æ ¸å…³é—­éšæœºåŒ–ï¼šå°†kaslræ”¹ä¸ºnokaslr</span><br><span class="line"></span><br><span class="line">#### åŸºæœ¬æ“ä½œ</span><br><span class="line"></span><br><span class="line"> 1.è·å–ç‰¹å®šå†…æ ¸ç¬¦å·ä¿¡æ¯</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>cat &#x2F;proc&#x2F;kallsyms | grep prepare_kernel_cred </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2.æŸ¥çœ‹klmd</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>lsmod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3.è¯»å–å†…æ ¸æ¨¡å—ä¿¡æ¯</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> cat &#x2F;sys&#x2F;module&#x2F;a3kmod&#x2F;sections&#x2F;.text<br> cat &#x2F;sys&#x2F;module&#x2F;a3kmod&#x2F;sections&#x2F;.data </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### å¯åŠ¨è°ƒè¯•</span><br><span class="line"></span><br><span class="line"> åœ¨å¯åŠ¨å‚æ•°ä¸­æ·»åŠ  `-gdb dev` æ¥å¯åŠ¨è°ƒè¯•æœåŠ¡ </span><br><span class="line"></span><br><span class="line"> æœ€å¸¸è§çš„æ“ä½œä¸ºåœ¨ä¸€ä¸ªç«¯å£ç›‘å¬ä¸€ä¸ª tcp è¿æ¥ã€‚ QEMU åŒæ—¶æä¾›äº†ä¸€ä¸ªç®€å†™çš„æ–¹å¼ `-s`ï¼Œè¡¨ç¤º `-gdb tcp::1234`ï¼Œå³åœ¨ 1234 ç«¯å£å¼€å¯ä¸€ä¸ª gdbserverã€‚ </span><br><span class="line"></span><br><span class="line"> ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨å†…æ ¸åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯å†…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¥è¿æ¥åˆ°å¯¹åº”çš„ gdbserverï¼Œå¼€å§‹è°ƒè¯• </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> gdb -q -ex â€œtarget remote localhost:1234â€ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¯åŠ¨å†…æ ¸åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ gdb ä¸­ä½¿ç”¨ `add-symbol-file` å­—å‘½ä»¤æ¥æ·»åŠ ç¬¦å·ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ `-s æ®µåç§° æ®µåœ°å€` æ ¼å¼çš„é™„åŠ å‚æ•°æŒ‡å®šå„ä¸ªæ®µåœ¨å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼Œä¾‹å¦‚ï¼š </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> add-symbol-file .&#x2F;test_kmod&#x2F;src&#x2F;a3kmod.ko -s .text 0xffffffffc008f000 -s .data 0xffffffffc0091038 -s .bss 0xffffffffc0091540 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## äº”.system.map</span><br><span class="line"></span><br><span class="line">å½“æˆ‘ä»¬è·å¾—çš„ vmlinux æ˜¯ stripped æ—¶å°±éœ€è¦ System.map æ¥å¸®åŠ©æˆ‘ä»¬è°ƒè¯•ã€‚ `System.map` æ–‡ä»¶æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯ä¸€è¡ŒåŒ…å«ä¸‰ä¸ªå­—æ®µï¼š</span><br><span class="line"></span><br><span class="line">ç¬¦å·åœ°å€ï¼ˆå†…å­˜åœ°å€ï¼‰ ç¬¦å·ç±»å‹ï¼ˆä¾‹å¦‚ï¼šå‡½æ•°ã€å˜é‡ï¼‰å¦‚æœä¸ºå°å†™ï¼Œåˆ™ç¬¦å·ä¸ºæœ¬åœ°ç¬¦å·; å¦‚æœå¤§å†™ï¼Œç¬¦å·ä¸ºå…¨å±€ï¼ˆå¤–éƒ¨ï¼‰ã€‚ ç¬¦å·åï¼ˆæ ‡è¯†ç¬¦ï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> â””â”€$ head System.map<br> 0000000000000000 A VDSO32_PRELINK<br> 0000000000000000 D __per_cpu_start<br> 0000000000000000 D per_cpu__irq_stack_union  0000000000000000 A xen_irq_disable_direct_reloc 0000000000000000 A xen_save_fl_direct_reloc<br> 0000000000000040 A VDSO32_vsyscall_eh_frame_size  00000000000001e7 A kexec_control_code_size<br> 00000000000001f0 A VDSO32_NOTE_MASK<br> 0000000000000400 A VDSO32_sigreturn<br> 0000000000000410 A VDSO32_rt_sigreturn </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å¯åŠ¨è„šæœ¬ï¼š</span><br><span class="line"></span><br><span class="line">å…ˆå°†vmlinuxæ–‡ä»¶æ”¾å…¥idaä¸­ï¼Œå†ç”¨shift+F12æ‰“å¼€è„šæœ¬å‘½ä»¤çª—å£ï¼Œé»è´´å¦‚ä¸‹ä»£ç ï¼Œè¿è¡Œåï¼Œé€‰æ‹©æ­£ç¡®çš„system.mapæ–‡ä»¶</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> import idaapi</p>
<p>def load_system_map(file_path):<br>    with open(file_path, â€œrâ€) as f:<br>        for line in f:<br>            parts &#x3D; line.split()<br>            if len(parts) &lt; 3:<br>                continue</p>
<pre><code>        addr = int(parts[0], 16)
        symbol_type = parts[1]
        symbol_name = parts[2]

        # if symbol_type in [&#39;T&#39;, &#39;t&#39;, &#39;D&#39;, &#39;d&#39;, &#39;B&#39;, &#39;b&#39;]:     #å¦‚æœç¬¦å·è¡¨å¤ªå¤§ï¼Œå¯ä»¥é’ˆå¯¹æ€§æ·»åŠ 
        if not idaapi.add_entry(addr, addr, symbol_name, 0):
            print(f&quot;Failed to add symbol: &#123;symbol_name&#125; at &#123;hex(addr)&#125;&quot;)
        else:
            print(f&quot;Added symbol: &#123;symbol_name&#125; at &#123;hex(addr)&#125;&quot;)
</code></pre>
<p>system_map_path &#x3D; idaapi.ask_file(0, â€œ*.mapâ€, â€œSelect System.map fileâ€)<br>if system_map_path:<br>    load_system_map(system_map_path) #ï¼ï¼ï¼è·¯å¾„åœ¨è¿™<br>else:<br>    print(â€œNo file selectedâ€)</p>
<pre><code>
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://hfddh666.github.io">hfddh666</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://hfddh666.github.io/2025/09/26/kernel-basic/">https://hfddh666.github.io/2025/09/26/kernel-basic/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://hfddh666.github.io" target="_blank">hfddh666's Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8/">å†…æ ¸å®‰å…¨</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/10/01/qwb2018-core/" title="qwb2018-core"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">qwb2018-core</div></div><div class="info-2"><div class="info-item-1">qwb2018-coreç»™äº†å››ä¸ªæ–‡ä»¶ï¼ˆbzImage,core.cpio,start.sh,vmlinux),vmlinuxæ˜¯bzImageå‹ç¼©å‰çš„æ–‡ä»¶ï¼Œpopæ®µå…¨ï¼Œè‹¥é¢˜ç›®æ²¡ç»™vmlinuxï¼Œé€šè¿‡ 12./extract-vmlinux ./bzImage &gt; vmlinux file vmlinux  å…ˆçœ‹start.sh:å‘ç°å¼€å¯äº†kaslrï¼Œå¯åŠ¨ä¸€ä¸‹ï¼Œè‹¥æ— æ³•å¯åŠ¨ï¼Œå°†-måçš„å‚æ•°è°ƒå¤§ 12345678qemu-system-x86_64 \-m 256M \-kernel ./bzImage \-initrd  ./core.cpio \-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \-s  \-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \-nographic  \  å†çœ‹çœ‹initæ–‡ä»¶ï¼šå¾ˆå¥½ï¼Œå°†kallsymsä¿å­˜åˆ°tmpç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æ‰“å¼€&#x2F;tmp&#x2F;kallsymsç›®å½•...</div></div></div></a><a class="pagination-related" href="/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/" title="linuxç”¨æˆ·å±‚pwn"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">linuxç”¨æˆ·å±‚pwn</div></div><div class="info-2"><div class="info-item-1">åŸºç¡€æŒ‡ä»¤IDA:shift+F12;ctrl+f  jgå¤§äºåˆ™è·³è½¬ï¼Œjlå°äºåˆ™è·³è½¬ï¼Œjumpæ— æ¡ä»¶è·³è½¬  encodeä¸decodeåŒºåˆ« gdb:ctrl+cï¼Œp &amp;printfï¼Œ ç›´æ¥æŸ¥çœ‹è¯¥åœ°å€æ‰€å­˜å‚¨çš„ä¸œè¥¿ï¼šx&#x2F;x addrï¼Œ æŸ¥çœ‹gotè¡¨ï¼šgot disass mainï¼šæŸ¥çœ‹mainå‡½æ•°çš„æ±‡ç¼– æŸ¥çœ‹äº‹åŠ¡ï¼š 1234567gefâ¤  x/a 0xffffd0d00xffffd0d0:	0x80484b0gefâ¤  x/10c 0x80484b00x80484b0:	0x68	0x65	0x6c	0x6c	0x6f	0x20	0x77	0x6f0x80484b8:	0x72	0x6cgefâ¤  x/s 0x80484b00x80484b0:	&quot;hello world!&quot;  æŸ¥çœ‹å¯„å­˜å™¨ï¼š info registers  æ¥æ”¶æ•°æ®ï¼š64ä½canaryæ¥å—ï¼šå› ä¸ºæ­£å¸¸canaryçš„æœ«ä½ä¸ºâ€\x00â€ 1canary=u64(p.recv(7).rjust(8,b&#x27;\x00&#x27;))   64ä½çš„å †æ¥å—æŸä¸ªå±•ç¤ºçš„æ•°æ® 1free_add...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/10/03/2021%E6%98%A5%E7%A7%8B%E6%9D%AF-core/" title="2021æ˜¥ç§‹æ¯-core"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">2021æ˜¥ç§‹æ¯-core</div></div><div class="info-2"><div class="info-item-1">å‡†å¤‡å·¥ä½œ1.å…ˆæ¥ä¸ªvmlinux12./extract-vmlinux ./bzImage &gt; vmlinux file vmlinux  #è¦çœ‹çœ‹æœ‰æ²¡æœ‰extract-vmlinuxçš„æ–‡ä»¶  2.è§£åŒ…ï¼šç»™çš„æ˜¯ä¸€ä¸ªrootfs.img.gzçš„æ–‡ä»¶123456gunzip rootfs.img.gzfile rootfs.imgmkdir rootfs_extractedcd rootfs_extractedcpio -idv &lt; ../rootfs.imgè¾“å‡ºä¸€å¤§ä¸²æˆåŠŸäº†  æ³¨æ„æå®Œåè¦å†æ¥ä¸ªgunzipï¼Œä¸ç„¶.&#x2F;start.shæ‰€åœ¨ç›®å½•æ‰¾ä¸åˆ°rootfs.img 3.çœ‹start.shï¼šå¼€å¯smepå’Œkaslr12345678910#!/bin/shqemu-system-x86_64  \-m 256M \   #è¦æ”¹256-cpu kvm64,+smep \-kernel ./bzImage \-initrd rootfs.img \-nographic \-s \-append &quot;console=ttyS0 kaslr quiet noap...</div></div></div></a><a class="pagination-related" href="/2025/11/22/heap-spray/" title="heap spray"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-22</div><div class="info-item-2">heap spray</div></div><div class="info-2"><div class="info-item-1">æ¦‚å¿µå †å–·å°„æŒ‡çš„æ˜¯é€šè¿‡åˆ†é…å¤§é‡ç›¸åŒçš„ç»“æ„ä½“æ¥è¾¾æˆæŸç§ç‰¹å®šçš„å†…å­˜å¸ƒå±€ RWCTF2023 ä½“éªŒèµ› - Digging into kernel 31.æŸ¥çœ‹å¯åŠ¨è„šæœ¬å¾ˆæ˜æ˜¾ï¼Œå¼€å¯äº†smep,smap,kaslr,kpti 1234567891011121314#!/bin/shqemu-system-x86_64 \    -m 128M \    -nographic \    -kernel ./bzImage \    -initrd ./rootfs.img \    -enable-kvm \    -cpu kvm64,+smap,+smep \    -monitor /dev/null \    -append &#x27;console=ttyS0 kaslr kpti=1 quiet oops=panic panic=1 init=/init&#x27; \    -no-reboot \    -snapshot \    -s  åŠ è½½è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œlsä¸€ä¸‹ï¼Œå‘ç°æœ‰ä¸ªrwctf.koï¼Œæ¼æ´æ¨¡å—æ‰¾åˆ°äº† 2.IDAåˆ†æå°±åªæœ‰è¿™ä¸€ä¸ªå‡½æ•° 123456789101112131...</div></div></div></a><a class="pagination-related" href="/2025/11/06/kernel-UAF/" title="kernel-UAF"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-06</div><div class="info-item-2">kernel-UAF</div></div><div class="info-2"><div class="info-item-1">CISCN2017-babydriver1.æ–‡ä»¶åˆ†æå…ˆä»¿çœŸè¿è¡Œä¸€ä¸‹ä¼šå‘ç°ç»™çš„boot.shæœ‰é—®é¢˜ï¼Œæ²¡æœ‰è£…è½½klmæ¨¡å—å¥½åƒå¥½åƒ æ²¡å¼€kaslr 1234567891011#!/bin/bashqemu-system-x86_64 \  -initrd rootfs.cpio \  -kernel bzImage \  -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; \  -monitor /dev/null \  -m 64M \  --nographic \  -smp cores=1,threads=1 \  -cpu qemu64  å¼€å¯smepï¼Œæ¼æ´æ¨¡å—æ˜¯babydriver.koï¼Œç„¶åå°±æ˜¯rootæ‰å¯è¯»å–flag 1234567891011121314151617mount -t proc none /procmount -t sysfs none /sysmount -t devtmpfs devtmpfs /devchown root:root flagchmod 400 flage...</div></div></div></a><a class="pagination-related" href="/2025/10/26/kaslr%E7%88%86%E7%A0%B4/" title="kaslrçˆ†ç ´"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-26</div><div class="info-item-2">kaslrçˆ†ç ´</div></div><div class="info-2"><div class="info-item-1">TCTF2021-FINALéš¾åº¦å› è¯¥æ˜¯ç›®å‰åšçš„æœ€ç®€å•çš„ï¼Œä¸»è¦æ˜¯ç†è§£ä¸‹kernelçš„kaslrçˆ†ç ´å’Œè¿œç¨‹expå¦‚ä½•ç¼–å†™ã€‚ é¢˜ç›®åˆ†æå‘ç°å¼€å¯äº†kpti 12/start.shcat /sys/devices/system/cpu/vulnerabilities/*    å†çœ‹ä¸‹start.sh,å¼€å¯äº†SMAP,SMEP,KASLR,ä½†æ˜¯-drive file=flag.txt,format=raw \ å°†flag.txtæ–‡ä»¶ä½œä¸ºåŸå§‹ç£ç›˜é•œåƒï¼Œåœ¨&#x2F;dev&#x2F;sdaä¸­,cat &#x2F;dev&#x2F;sdaï¼Œæ­£å¸¸æƒ…å†µä¸‹flag.txtæ˜¯å…¨æ–°å…ˆè®¾ä¸º600ï¼ˆrootå¯è¯»ï¼‰ï¼Œç„¶åcat &#x2F;root&#x2F;flag.txt 12345678910111213stty intr ^]cd `dirname $0`timeout --foreground 300 qemu-system-x86_64 \    -m 256M \    -enable-kvm \    -cpu host,+smep,+smap \    -kernel bzImage \   ...</div></div></div></a><a class="pagination-related" href="/2025/10/31/kernel-heap/" title="kernel heap"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-31</div><div class="info-item-2">kernel heap</div></div><div class="info-2"><div class="info-item-1">å†…æ ¸å †æ¦‚è¿°å‰è¿°linux kernelå¯¹å †çš„å†…å­˜ç®¡ç†å™¨æœ‰ä¸¤ç§ï¼Œbuddy systemå’Œslab allocater,å‰è€…ä»¥å†…å­˜é¡µä¸ºæ“ä½œå•ä½ï¼Œåè€…åˆ™æ˜¯å°†å†…å­˜é¡µåˆ’åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„å¯¹è±¡è¿›è¡Œç²’åº¦é¢—ç²’ç®¡ç† linux kernelå°†å†…å­˜åˆ†ä¸ºé¡µ-åŒº-èŠ‚ç‚¹ä¸‰çº§ç»“æ„ï¼Œä¸‹é¢æ˜¯ä¸€å¼ ååˆ†ç»å…¸çš„ Overview ï¼Œè‡ªé¡¶å‘ä¸‹æ˜¯  èŠ‚ç‚¹ï¼ˆnodeï¼Œå¯¹åº”ç»“æ„ä½“ pgdata_listï¼‰ åŒºï¼ˆzoneï¼Œå¯¹åº”ç»“æ„ä½“ zoneï¼Œå›¾ä¸Šå±•ç¤ºäº†ä¸‰ç§ç±»å‹çš„ zoneï¼‰ é¡µï¼ˆpageï¼Œå¯¹åº”ç»“æ„ä½“ pageï¼‰   é¡µ    åŒºå°†èŠ‚ç‚¹çš„ä¸åŒç”¨é€”çš„å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„zone    èŠ‚ç‚¹ ä¸€ä¸ªMCå¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹ï¼›å¯¹äºåŒä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ä¸‹çš„CPUè€Œè¨€å…¶å¯¹åº”çš„èŠ‚ç‚¹ç§°ä¸ºæœ¬åœ°å†…å­˜  Buddy systemä»¥å†…å­˜é¡µä¸ºç²’åº¦ç®¡ç†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œå…¶å­˜åœ¨äºåŒºè¿™ä¸€çº§åˆ«  æ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢:  1234struct zone &#123;    //...    struct free_area    free_area[MAX_ORDER...</div></div></div></a><a class="pagination-related" href="/2025/10/23/kernel%E5%B8%B8%E8%A7%81%E4%BF%9D%E6%8A%A4/" title="kernelå¸¸è§ä¿æŠ¤"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-23</div><div class="info-item-2">kernelå¸¸è§ä¿æŠ¤</div></div><div class="info-2"><div class="info-item-1">å¸¸è§ä¿æŠ¤ä¸€.KPTIkptiç®€ä»‹ç®€å•è¯´å°±æ˜¯å†…æ ¸é¡µè¡¨éš”ç¦»ï¼šå¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç ï¼›å³æ— æ³•ç›´æ¥é€šè¿‡æ„é€ swapgs_iretqçš„ROPæ¥è¿”å›ç”¨æˆ·æ€ã€‚ PGD:å‡ºç°ç”¨äºå¤„ç†ä¸­æ–­ æ‰€ä»¥æœ‰ä¸€ä¸ªCR3å¯„å­˜å™¨ PGD:å½“CR3[12]ä¸º1æ—¶ä¸ºç”¨æˆ·æ€ï¼Œä¸º0æ—¶ä¸ºå†…æ ¸æ€ï¼Œæ‰€ä»¥å…³é”®æ˜¯è¦çœ‹æ€ä¹ˆåˆ‡æ¢CR3[12]ã€‚ ASID:å½“CR3[11]ä¸º1æ—¶ä¸ºç”¨æˆ·æ€ï¼Œä¸º0æ—¶ä¸ºå†…æ ¸æ€ï¼Œæ‰€ä»¥å…³é”®æ˜¯è¦çœ‹æ€ä¹ˆåˆ‡æ¢CR3[11]ã€‚ä¸€èˆ¬CR4å¼€å¯PCIDEæ—¶CR3çš„ä½12ä½æ‰æœ‰æ„ä¹‰ï¼Œæ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯ç½®ä¸º0 æ‰€ä»¥ä¸€æ—¦å¼€å¯kptiå°±ä¸èƒ½ä½¿ç”¨ret2userï¼Œå› ä¸ºå†…æ ¸æ€æ— æ³•ç¡®è®¤ç”¨æˆ·æ€é¡µè¡¨ kptiç»•è¿‡swap CR3åœ¨ä¸€ä¸ªå¼€å¯ KPTIå†…æ ¸ä¸­ä¼šè°ƒç”¨SWITCH_KERNEL_CR3_NO_STACKå‡½æ•°æ¥ä»ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€ï¼Œå…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678mov     rdi, cr3nopnopnopnopnopand     rdi, 0xFFFFFFFFFFFFE7FFmov     cr3, rdi  è¿™ä¸ªä½œç”¨å°±æ˜¯å°†CR3[11]&#x3D;CR3[12]&#x3D;0; è€Œä»å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€è°ƒ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">hfddh666</div><div class="author-info-description">æ¬¢è¿è®¿é—® hfddh666 çš„åšå®¢ï¼</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" href="/about/"><i class="fab fa-github"></i><span>å…³äºæˆ‘</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#linux-kernel"><span class="toc-number">1.</span> <span class="toc-text">linux kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.1.</span> <span class="toc-text">ä¸€.åŸºç¡€çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.æ“ä½œç³»ç»Ÿå†…æ ¸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E7%BA%A7%E4%BF%9D%E6%8A%A4%E7%8E%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.åˆ†çº§ä¿æŠ¤ç¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.çŠ¶æ€åˆ‡æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#user-space-to-kernel-space-%EF%BC%88%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%89"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">user space to kernel space ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kernel-space-to-user-space"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">kernel space to user space</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4"><span class="toc-number">1.1.4.</span> <span class="toc-text">4.è™šæ‹Ÿå†…å­˜ç©ºé—´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.5.</span> <span class="toc-text">5.è¿›ç¨‹æƒé™ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">è¿›ç¨‹æè¿°ç¬¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90%E5%87%AD%E8%AF%81"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">è¿›ç¨‹æƒé™å‡­è¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90%E6%94%B9%E5%8F%98"><span class="toc-number">1.1.5.3.</span> <span class="toc-text">è¿›ç¨‹æƒé™æ”¹å˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Loadable-Kernel-Modules-LKMs"><span class="toc-number">1.1.6.</span> <span class="toc-text">6.Loadable Kernel Modules(LKMs)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">ç›¸å…³æŒ‡ä»¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%86%85%E6%A0%B8%E4%BA%A4%E4%BA%92"><span class="toc-number">1.1.7.</span> <span class="toc-text">7.å†…æ ¸äº¤äº’</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Aioctl%EF%BC%88%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%AF%BB%E5%9D%80%EF%BC%89"><span class="toc-number">1.1.7.1.</span> <span class="toc-text">ç³»ç»Ÿè°ƒç”¨ï¼šioctlï¼ˆå¯ä»¥ç›´æ¥å¯»å€ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%B8%B8%E8%A7%81%E5%86%85%E6%A0%B8%E6%80%81%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.8.</span> <span class="toc-text">8.å¸¸è§å†…æ ¸æ€å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.9.</span> <span class="toc-text">9.ä¿æŠ¤æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">é€šç”¨ä¿æŠ¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.9.2.</span> <span class="toc-text">å †ä¿æŠ¤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E4%B8%8E%E7%BC%96%E8%AF%91"><span class="toc-number">1.2.</span> <span class="toc-text">äºŒ.å†…æ ¸æºç ä¸‹è½½ä¸ç¼–è¯‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.ä¸‹è½½å†…æ ¸æºç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.é…ç½®ç¼–è¯‘é€‰é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%B0%83%E8%AF%95%E7%9B%B8%E5%85%B3%E9%80%89%E9%A1%B9"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.è°ƒè¯•ç›¸å…³é€‰é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.4.</span> <span class="toc-text">4.ç¼–è¯‘å†…æ ¸</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%90%AD%E5%BB%BA%E5%86%85%E6%A0%B8%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.</span> <span class="toc-text">å››.æ­å»ºå†…æ ¸è¿è¡Œç¯å¢ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%EF%BC%88make-j-nproc-bzImage"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.è·å–å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆmake -j$(nproc) bzImage)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-BusyBox-%E6%90%AD%E5%BB%BA%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.ä½¿ç”¨ BusyBox æ­å»ºåŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%88%E5%9C%A8-install%E7%9B%AE%E5%BD%95%E4%B8%8B%E8%BF%9B%E8%A1%8C%EF%BC%89"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨_installç›®å½•ä¸‹è¿›è¡Œï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%88%E5%9C%A8busybox%E7%9B%AE%E5%BD%95%E4%B8%8B%E8%BF%9B%E8%A1%8C%EF%BC%89"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿï¼ˆåœ¨busyboxç›®å½•ä¸‹è¿›è¡Œï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.å¯åŠ¨å†…æ ¸</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/12/ret2gets/" title="ret2gets">ret2gets</a><time datetime="2026-02-12T06:28:07.000Z" title="å‘è¡¨äº 2026-02-12 14:28:07">2026-02-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/09/DLink%E8%B7%AF%E7%94%B1%E5%99%A8RCE%E6%BC%8F%E6%B4%9E-CVE-2019-17621/" title="DLinkè·¯ç”±å™¨RCEæ¼æ´ CVE-2019-17621">DLinkè·¯ç”±å™¨RCEæ¼æ´ CVE-2019-17621</a><time datetime="2026-02-09T09:39:02.000Z" title="å‘è¡¨äº 2026-02-09 17:39:02">2026-02-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/09/python%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" title="pythonå‰ç«¯å¼€å‘">pythonå‰ç«¯å¼€å‘</a><time datetime="2026-02-09T09:37:07.000Z" title="å‘è¡¨äº 2026-02-09 17:37:07">2026-02-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/04/%E4%B8%89%E5%A4%A7%E6%9E%B6%E6%9E%84%E6%AF%94%E8%BE%83/" title="ä¸‰å¤§æ¶æ„æ¯”è¾ƒ">ä¸‰å¤§æ¶æ„æ¯”è¾ƒ</a><time datetime="2026-02-04T15:07:13.000Z" title="å‘è¡¨äº 2026-02-04 23:07:13">2026-02-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/12/nss%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" title="nssåšé¢˜è®°å½•">nssåšé¢˜è®°å½•</a><time datetime="2025-12-12T08:35:53.000Z" title="å‘è¡¨äº 2025-12-12 16:35:53">2025-12-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By hfddh666</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
  // æ«å¶è„šæœ¬ï¼ˆæ•°é‡å‡å°‘ï¼Œæ›´è½»ç›ˆï¼‰
  $(document).ready(function() {
    var leafCount = 0;
    var maxLeaf = 15;
    var fallSpeed = 1.8;
    
    function createLeaf() {
      if (leafCount >= maxLeaf) return;
      var size = Math.random() * 15 + 10;
      var colors = ['#e65100','#ff7043','#f57c00'];
      var color = colors[Math.floor(Math.random() * colors.length)];
      
      var leaf = $('<div class="maple-leaf"></div>').css({
        top: -size + 'px',
        left: Math.random() * $(window).width() + 'px',
        width: size + 'px',
        height: size + 'px'
      });
      leaf[0].style.setProperty('--leaf-color', color);
      leaf.find('::before').css('background', color);
      
      $('body').append(leaf);
      leafCount++;
      
      leaf.animate({
        top: $(window).height() + size + 'px',
        left: "+=" + (Math.random() * 150 - 75) + "px",
        rotate: Math.random() * 720 + 'deg'
      }, fallSpeed * 20000, 
      function() {
        $(this).remove();
        leafCount--;
      });
    }
    for (var i = 0; i < 8; i++) createLeaf();
    setInterval(createLeaf, 800);
  });
</script>
<script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>